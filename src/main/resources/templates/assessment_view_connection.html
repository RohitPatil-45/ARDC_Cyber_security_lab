<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
<title>Assessment Lab | CMP</title>
<link rel="icon" type="image/png"
	href="/webtemplate/dist/img/magicboxEye3.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bootstrap & Font Awesome -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
	--assessment-color: #8a2be2;
	--assessment-dark: #6a0dad;
	--assessment-light: #9b4dff;
}

body {
	overflow: hidden;
	background-color: #0f172a;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Timer Styles */
.timer-container {
	background: linear-gradient(135deg, var(--assessment-color), var(--assessment-dark));
	color: white;
	padding: 1rem;
	border-radius: 8px;
	margin-bottom: 1rem;
	text-align: center;
	box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
}

.timer-label {
	font-size: 0.9rem;
	text-transform: uppercase;
	letter-spacing: 1px;
	margin-bottom: 0.5rem;
	opacity: 0.9;
}

.timer-display {
	font-size: 2.5rem;
	font-weight: 700;
	font-family: 'Roboto Mono', monospace;
	margin: 0;
}

.timer-warning {
	background: linear-gradient(135deg, #ffab00, #ff6b00);
}

.timer-danger {
	background: linear-gradient(135deg, #ff1744, #c40000);
	animation: pulse 1s infinite;
}

@keyframes pulse {
	0% { opacity: 1; }
	50% { opacity: 0.7; }
	100% { opacity: 1; }
}

.connection-container {
	display: flex;
	flex-direction: column;
	height: 100vh;
	position: relative;
}

.main-content {
	display: flex;
	flex: 1;
	overflow: hidden;
}

.rdp-frame-container {
	flex: 1;
	position: relative;
	transition: all 0.3s ease;
}

.rdp-frame-container.expanded {
	margin-right: 0;
}

.rdp-frame {
	width: 100%;
	height: 100%;
	border: none;
}

.sidebar {
	width: 400px;
	background-color: #1a202c;
	border-left: 1px solid #2d3748;
	display: flex;
	flex-direction: column;
	transition: all 0.3s ease;
}

.sidebar.collapsed {
	display: none;
}

.sidebar-tabs {
	display: flex;
	border-bottom: 1px solid #2d3748;
}

.sidebar-tab {
	flex: 1;
	background: none;
	border: none;
	color: #a0aec0;
	padding: 12px;
	cursor: pointer;
	transition: background-color 0.3s, color 0.3s;
}

.sidebar-tab:hover {
	background-color: #2d3748;
	color: white;
}

.sidebar-tab.active {
	background-color: #2d3748;
	color: white;
	border-bottom: 2px solid var(--assessment-color);
}

.tab-content {
	flex: 1;
	overflow: hidden;
	display: flex;
	flex-direction: column;
}

.tab-pane {
	display: none;
	flex-direction: column;
	height: 100%;
	overflow: hidden;
}

.tab-pane.active {
	display: flex;
}

.details-container {
	flex: 1;
	overflow: auto;
	padding: 15px;
}

.detail-row {
	display: flex;
	margin-bottom: 12px;
}

.detail-label {
	font-weight: bold;
	margin-right: 6px;
	min-width: 100px;
	color: #adb5bd;
}

.detail-value {
	color: #f8f9fa;
}

.top-controls {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 10px 20px;
	background-color: #1a202c;
	border-bottom: 1px solid #2d3748;
	color: white;
}

.brand {
	font-weight: bold;
	color: var(--assessment-color);
}

.connection-info {
	display: flex;
	align-items: center;
	gap: 10px;
}

.status-indicator {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background-color: #48bb78;
}

.control-buttons {
	display: flex;
	gap: 10px;
}

.btn-control {
	background-color: var(--assessment-color);
	color: white;
	border: none;
	padding: 8px 15px;
	border-radius: 4px;
	cursor: pointer;
	transition: background-color 0.3s;
}

.btn-control:hover {
	background-color: var(--assessment-dark);
}

.assessment-warning {
	background-color: rgba(138, 43, 226, 0.1);
	border: 1px solid var(--assessment-color);
	border-radius: 8px;
	padding: 15px;
	margin: 15px;
	text-align: center;
}

.assessment-warning i {
	color: var(--assessment-color);
	font-size: 2rem;
	margin-bottom: 10px;
}

.assessment-warning h5 {
	color: var(--assessment-color);
	margin-bottom: 10px;
}

.assessment-warning p {
	color: #a0aec0;
	margin: 0;
}

/* Mandatory Command Styles */
.mandatory-command {
	background-color: rgba(255, 193, 7, 0.1);
	border: 1px solid #ffc107;
	border-radius: 8px;
	padding: 15px;
	margin: 15px;
}

.mandatory-command h6 {
	color: #ffc107;
	margin-bottom: 10px;
	display: flex;
	align-items: center;
	gap: 8px;
}

.command-container {
	position: relative;
	margin: 10px 0;
	padding: 12px;
	background-color: #2d3748;
	border-radius: 8px;
	border-left: 3px solid #ffc107;
}

.command-text {
	font-family: 'Courier New', monospace;
	font-size: 14px;
	color: #f8f9fa;
	margin-right: 30px;
	word-break: break-all;
}

.copy-button {
	position: absolute;
	top: 8px;
	right: 8px;
	background-color: transparent;
	color: #a0aec0;
	border: none;
	border-radius: 4px;
	padding: 5px;
	font-size: 12px;
	cursor: pointer;
	transition: color 0.3s;
}

.copy-button:hover {
	color: #007bff;
}

.copy-button.copied {
	color: #28a745;
}

/* Focus management for RDP frame */
.rdp-frame:focus {
	outline: 2px solid var(--assessment-color);
	outline-offset: -2px;
}

/* Warning message styles */
.warning-message {
	background-color: rgba(255, 193, 7, 0.1);
	border: 1px solid #ffc107;
	border-radius: 8px;
	padding: 12px;
	margin: 10px 15px;
	color: #ffc107;
	font-size: 0.9rem;
}

.warning-message i {
	margin-right: 8px;
}

/* Sidebar toggle button */
.sidebar-toggler {
	position: absolute;
	top: 50%;
	right: 0;
	transform: translateY(-50%);
	background-color: #2d3748;
	color: white;
	border: none;
	border-radius: 5px 0 0 5px;
	padding: 10px 5px;
	cursor: pointer;
	z-index: 101;
	display: none;
}

.sidebar.collapsed ~ .sidebar-toggler {
	display: block;
}

/* Lab Completion Modal Styles */
.lab-completion-modal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.8);
	display: flex;
	justify-content: center;
	align-items: center;
	z-index: 10000;
}

.lab-completion-content {
	background: linear-gradient(135deg, #1a202c, #2d3748);
	border-radius: 15px;
	padding: 40px;
	text-align: center;
	max-width: 500px;
	width: 90%;
	border: 2px solid var(--assessment-color);
	box-shadow: 0 10px 30px rgba(138, 43, 226, 0.3);
}

.lab-completion-icon {
	font-size: 4rem;
	color: #28a745;
	margin-bottom: 20px;
	animation: bounce 1s infinite;
}

@keyframes bounce {
	0%, 100% { transform: translateY(0); }
	50% { transform: translateY(-10px); }
}

.lab-completion-title {
	color: #28a745;
	font-size: 2rem;
	margin-bottom: 15px;
	font-weight: bold;
}

.lab-completion-message {
	color: #a0aec0;
	font-size: 1.1rem;
	margin-bottom: 25px;
	line-height: 1.5;
}

.lab-completion-button {
	background: linear-gradient(135deg, var(--assessment-color), var(--assessment-dark));
	color: white;
	border: none;
	padding: 12px 30px;
	border-radius: 8px;
	font-size: 1.1rem;
	cursor: pointer;
	transition: all 0.3s ease;
	text-decoration: none;
	display: inline-block;
}

.lab-completion-button:hover {
	transform: translateY(-2px);
	box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
	color: white;
}
</style>

<link rel="stylesheet" th:href="@{/webtemplate/css/style_connetion.css}">
</head>

<body>
	<div class="connection-container">
		<!-- Top controls bar -->
		<div class="top-controls">
			<div class="brand">
				<i class="fas fa-clipboard-check"></i> MAGICBOX Assessment Lab
			</div>

			<div class="connection-info">
				<div class="status-indicator"></div>
				<span>Assessment Session</span>
			</div>

			<div class="control-buttons">
				<button class="btn-control" id="toggle-sidebar">
					<i class="fas fa-times"></i> Close Sidebar
				</button>
				<button class="btn-control" id="fullscreen-btn">
					<i class="fas fa-expand"></i> Fullscreen
				</button>
				<button class="btn-control" onclick="endAssessment()">
					<i class="fas fa-times"></i> End Assessment
				</button>
			</div>
		</div>

		<!-- Assessment Timer -->
		<div class="timer-container" id="timerContainer">
			<div class="timer-label">
				<i class="fas fa-clock"></i> ASSESSMENT TIME REMAINING
			</div>
			<div class="timer-display" id="timerDisplay">
				[[${assessmentTime}]]
			</div>
		</div>

		<!-- Main content area -->
		<div class="main-content">
			<!-- RDP Frame -->
			<div class="rdp-frame-container" id="rdp-container">
				<iframe th:src="${embedUrl}" class="rdp-frame" id="rdp-frame" 
					allow="clipboard-read; clipboard-write"></iframe>
			</div>

			<!-- Sidebar with details only -->
			<div class="sidebar" id="instruction-sidebar">
				<div class="sidebar-tabs">
					<button class="sidebar-tab active" data-tab="details">
						<i class="fas fa-info-circle"></i> Connection Details
					</button>
				</div>

				<div class="tab-content">
					<!-- Details Tab -->
					<div class="tab-pane active" id="details-tab">
						<div class="details-container">
							<div class="assessment-warning">
								<i class="fas fa-clipboard-check"></i>
								<h5>Assessment Mode</h5>
								<p>You are in assessment mode. Instructions and chat support are disabled.</p>
								<p>Complete the tasks within the allocated time.</p>
							</div>
							
							<!-- Mandatory Command Section -->
							<div class="mandatory-command" id="mandatoryCommandSection">
								<h6><i class="fas fa-exclamation-triangle"></i> Mandatory Setup Command</h6>
								<p style="color: #a0aec0; font-size: 0.9rem; margin-bottom: 10px;">
									Execute this command first to set up your assessment environment:
								</p>
								<div id="mandatoryCommandContainer">
									<!-- Mandatory command will be loaded here -->
								</div>
								<div class="warning-message">
									<i class="fas fa-exclamation-circle"></i>
									You must execute this command before proceeding with assessment tasks.
								</div>
							</div>
							
<!-- 							<h5 class="mb-3" style="color: aliceblue;">Connection Details</h5> -->
<!-- 							<div id="connection_details"> -->
								<!-- Connection details will be dynamically loaded here -->
<!-- 							</div> -->
							
							<!-- Assessment Progress -->
							<div style="margin-top: 20px; padding: 15px; background-color: rgba(138, 43, 226, 0.1); border-radius: 8px;">
								<h6 style="color: var(--assessment-color); margin-bottom: 10px;">
									<i class="fas fa-tasks"></i> Assessment Progress
								</h6>
								<div id="assessmentProgress">
									<div class="detail-row">
										<span class="detail-label">Mandatory Command:</span>
										<span class="detail-value" id="mandatoryStatus" style="color: #ff6b6b;">
											<i class="fas fa-times-circle"></i> Not Executed
										</span>
									</div>
									<div class="detail-row">
										<span class="detail-label">Assessment Status:</span>
										<span class="detail-value" id="assessmentStatus" style="color: #ffc107;">
											<i class="fas fa-clock"></i> In Progress
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Sidebar toggle button -->
			<button class="sidebar-toggler" id="sidebar-toggle">
				<i class="fas fa-chevron-left" id="sidebar-toggle-icon"></i>
			</button>
		</div>
	</div>

	<!-- Lab Completion Modal -->
	<div class="lab-completion-modal" id="labCompletionModal" style="display: none;">
		<div class="lab-completion-content">
			<div class="lab-completion-icon">
				<i class="fas fa-check-circle"></i>
			</div>
			<h2 class="lab-completion-title">Lab Completed Successfully!</h2>
			<p class="lab-completion-message">
				Congratulations! You have successfully completed the lab assessment.<br>
				Your performance has been recorded and scored.
			</p>
			<button class="lab-completion-button" onclick="redirectToPreviousPage()">
				<i class="fas fa-chart-line"></i> Check Your Score & Go Back
			</button>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- SweetAlert2 -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
		// Global variables
		let currentLabId = null;
		let currentScenarioId = null;
		let assessmentTimer = null;
		let tabSwitchCount = 0;
		let maxTabSwitches = 3;
		let mandatoryCommandExecuted = false;
		let assessmentCompleted = false;

		// Function to extract IDs from URL
		function getIdsFromUrl() {
			const path = window.location.pathname;
			const parts = path.split('/');
			const labId = parts[parts.length - 1];
			const scenarioId = parts[parts.length - 2]; // Assuming URL pattern: /guac/assessmentviewPlaylistConnection/{scenarioId}/{labId}
			return { labId, scenarioId };
		}
		
		// Function to redirect to previous page or scenario page
		function redirectToPreviousPage() {
			if (currentScenarioId) {
				// Redirect to scenario page
				window.location.href = `/guac/assessmentviewPlaylistConnection/${currentScenarioId}`;
			} else {
				// Go back to previous page
				window.history.back();
			}
		}

		// Function to show lab completion modal
		function showLabCompletionModal() {
			const modal = document.getElementById('labCompletionModal');
			modal.style.display = 'flex';
			
			// Disable all controls
			document.querySelectorAll('.btn-control').forEach(btn => {
				btn.disabled = true;
				btn.style.opacity = '0.5';
			});
			
			// Stop the timer
			clearInterval(assessmentTimer);
		}

		// Timer functionality
		function startTimer(duration, display) {
			let timer = duration, minutes, seconds;
			const timerContainer = document.getElementById('timerContainer');
			
			assessmentTimer = setInterval(function () {
				minutes = parseInt(timer / 60, 10);
				seconds = parseInt(timer % 60, 10);

				minutes = minutes < 10 ? "0" + minutes : minutes;
				seconds = seconds < 10 ? "0" + seconds : seconds;

				display.textContent = minutes + ":" + seconds;

				// Update timer container class based on remaining time
				if (timer <= 300) { // 5 minutes
					timerContainer.classList.add('timer-danger');
					timerContainer.classList.remove('timer-warning');
				} else if (timer <= 900) { // 15 minutes
					timerContainer.classList.add('timer-warning');
					timerContainer.classList.remove('timer-danger');
				} else {
					timerContainer.classList.remove('timer-warning', 'timer-danger');
				}

				if (--timer < 0) {
					clearInterval(assessmentTimer);
					display.textContent = "TIME'S UP!";
					timerContainer.classList.add('timer-danger');
					
					// Mark assessment as completed due to time up
					markAssessmentCompleted('Time expired');
				}
			}, 1000);
		}

		// Function to handle tab switching
		function handleTabSwitch() {
			if (assessmentCompleted) return;
			
			tabSwitchCount++;
			const remainingSwitches = maxTabSwitches - tabSwitchCount;
			
			if (tabSwitchCount <= maxTabSwitches) {
				Swal.fire({
					icon: 'warning',
					title: 'Warning!',
					html: `Do not switch tabs during assessment!<br>
						   <strong>Warning ${tabSwitchCount}/${maxTabSwitches}</strong><br>
						   ${remainingSwitches > 0 ? 
						   	`${remainingSwitches} warning${remainingSwitches > 1 ? 's' : ''} remaining before assessment is terminated.` : 
						   	'Next violation will terminate your assessment!'}`,
					confirmButtonText: 'I Understand',
					allowOutsideClick: false,
					background: '#1a202c',
					color: 'white'
				});
			}
			
			if (tabSwitchCount >= maxTabSwitches) {
			    Swal.fire({
			        icon: 'error',
			        title: 'Assessment Terminated!',
			        html: 'You have exceeded the maximum allowed tab switches.<br>Your assessment has been terminated.',
			        confirmButtonText: 'OK',
			        allowOutsideClick: false,
			        background: '#1a202c',
			        color: 'white'
			    }).then(() => {
			        markAssessmentCompleted('Tab switching violation');
			        window.history.back(); // Go back to previous page
			    });
			}
		}

		// Function to mark assessment as completed and redirect
		function markAssessmentCompleted(reason) {
			if (assessmentCompleted) return;
			
			assessmentCompleted = true;
			clearInterval(assessmentTimer);
			
			// Update UI
			document.getElementById('assessmentStatus').innerHTML = 
				'<i class="fas fa-check-circle" style="color: #28a745;"></i> Completed';
			document.getElementById('assessmentStatus').style.color = '#28a745';
			
			// Send completion to server
			$.ajax({
				type: "POST",
				url: "/guac/assessment/markCompleted",
				data: {
					labId: currentLabId,
					reason: reason
				},
				success: function(response) {
					console.log('Assessment marked as completed:', response);
					
					// Show completion modal instead of SweetAlert
					showLabCompletionModal();
				},
				error: function(error) {
					console.error('Failed to mark assessment completed:', error);
					// Still show completion modal even if there's an error
					showLabCompletionModal();
				}
			});
		}

		// Function to check mandatory command status
		function checkMandatoryCommandStatus() {
			if (!currentLabId || assessmentCompleted) return;
			
			// Get the mandatory command text from the page
			const mandatoryCommand = document.querySelector('.command-text')?.textContent?.trim();
			
			if (!mandatoryCommand) {
				console.error('Mandatory command not found on page');
				return;
			}
			
			$.ajax({
				type: "POST",
				url: "/guac/assessment/checkMandatoryCommand",
				data: { 
					labId: currentLabId,
					command: mandatoryCommand
				},
				success: function(response) {
					if (response.success && response.executed) {
						mandatoryCommandExecuted = true;
						document.getElementById('mandatoryStatus').innerHTML = 
							'<i class="fas fa-check-circle" style="color: #28a745;"></i> Executed';
						document.getElementById('mandatoryStatus').style.color = '#28a745';
						
						// Hide the mandatory command section after execution
						document.getElementById('mandatoryCommandSection').style.display = 'none';
					}
				},
				error: function(error) {
					console.error('Failed to check mandatory command status:', error);
				}
			});
		}

		// Function to setup copy button functionality
		function setupCopyButtons() {
			$(document).on('click', '.copy-button', function () {
				const commandText = $(this).closest('.command-container').find('.command-text').text().trim();
				const button = $(this);

				// Try to copy command to clipboard
				navigator.clipboard.writeText(commandText)
					.then(() => {
						// Success feedback
						button.addClass('copied');
						button.html('<i class="fas fa-check"></i>');

						// Focus the RDP iframe
						focusRDPFrame();

						// Reset button after 2 seconds
						setTimeout(function () {
							button.removeClass('copied');
							button.html('<i class="fas fa-copy"></i>');
						}, 2000);
					})
					.catch(() => {
						// Error feedback
						Swal.fire({
							icon: 'error',
							title: 'Copy Failed',
							text: 'Failed to copy command to clipboard. Please try again.',
							timer: 2000,
							showConfirmButton: false,
							background: '#1a202c',
							color: 'white'
						});
					});
			});
		}

		// Function to focus on RDP frame
		function focusRDPFrame() {
			const iframe = document.getElementById("rdp-frame");
			if (iframe) {
				iframe.setAttribute("tabindex", "0");
				iframe.focus();
			}
		}

		// Function to end assessment
		function endAssessment() {
			Swal.fire({
				title: 'End Assessment?',
				html: 'Are you sure you want to end this assessment?<br><strong>This action cannot be undone!</strong>',
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Yes, End Assessment',
				cancelButtonText: 'Cancel',
				background: '#1a202c',
				color: 'white',
				confirmButtonColor: '#d33',
				cancelButtonColor: '#3085d6'
			}).then((result) => {
				if (result.isConfirmed) {
					markAssessmentCompleted('Manually ended by user');
				}
			});
		}

		// Function to toggle sidebar
		function toggleSidebar() {
			const sidebar = document.getElementById('instruction-sidebar');
			const rdpContainer = document.getElementById('rdp-container');
			const toggleBtn = document.getElementById('toggle-sidebar');
			
			sidebar.classList.toggle('collapsed');
			rdpContainer.classList.toggle('expanded');
			
			if (sidebar.classList.contains('collapsed')) {
				toggleBtn.innerHTML = '<i class="fas fa-bars"></i> Show Sidebar';
			} else {
				toggleBtn.innerHTML = '<i class="fas fa-times"></i> Close Sidebar';
			}
		}

		function ConnectionDetails(id) {
		    $.ajax({
		        type: "POST",
		        url: "/guac/assessment/getConnectionDeatils",
		        data: { LabId: id },
		        success: function(response) {
		            if (response.success) {
		                $('#connection_details').empty();

		                const detailsHtml = `
		                    <div class="detail-row">
		                        <span class="detail-label">Username:</span>
		                        <span class="detail-value">${response.username || '-'}</span>
		                    </div>
		                    <div class="detail-row">
                            <span class="detail-label">Password:</span>
                            <span class="detail-value">${response.password || '-'}</span>
                        </div>
		                    <div class="detail-row">
		                        <span class="detail-label">Lab Name:</span>
		                        <span class="detail-value">${response.labName || '-'}</span>
		                    </div>
		                    <div class="detail-row">
		                        <span class="detail-label">IP Address:</span>
		                        <span class="detail-value">${response.ipAddress || '-'}</span>
		                    </div>
		                `;
		                $('#connection_details').html(detailsHtml);
		            } else {
		                console.error('Failed to load connection details:', response.error);
		                $('#connection_details').html('<div class="text-muted">Error loading connection details</div>');
		            }
		        },
		        error: function() {
		            $('#connection_details').html('<div class="text-muted">Error loading connection details</div>');
		        }
		    });
		}

		// Function to load mandatory command
		function loadMandatoryCommand(labId) {
			$.ajax({
				type: "POST",
				url: "/guac/assessment/getMandatoryCommand",
				data: { labId: labId },
				success: function(response) {
					if (response.success && response.command) {
						const commandHtml = `
							<div class="command-container">
								<div class="command-text">${response.command}</div>
								<button class="copy-button">
									<i class="fas fa-copy"></i>
								</button>
							</div>
						`;
						$('#mandatoryCommandContainer').html(commandHtml);
					} else {
						$('#mandatoryCommandSection').style.display = 'none';
					}
				},
				error: function() {
					console.error('Failed to load mandatory command');
				}
			});
		}

		$(document).ready(function() {
			// Initialize current lab ID and scenario ID
			const ids = getIdsFromUrl();
			currentLabId = ids.labId;
			currentScenarioId = ids.scenarioId;

			// Initialize assessment timer
			const timerDisplay = document.getElementById('timerDisplay');
			if (timerDisplay) {
				const timeString = timerDisplay.textContent;
				const [minutes, seconds] = timeString.split(':').map(Number);
				const totalSeconds = minutes * 60 + seconds;
				
				if (totalSeconds > 0) {
					startTimer(totalSeconds, timerDisplay);
				}
			}

			// Load connection details and mandatory command
			if (currentLabId) {
				ConnectionDetails(currentLabId);
				loadMandatoryCommand(currentLabId);
				
				// Start periodic check for mandatory command execution
				setInterval(checkMandatoryCommandStatus, 5000); // Check every 5 seconds
			}
			
			// Sidebar toggle functionality
			$('#toggle-sidebar').click(toggleSidebar);
			$('#sidebar-toggle').click(toggleSidebar);
			
			// Fullscreen functionality
			$('#fullscreen-btn').click(function() {
				const elem = $('.connection-container')[0];
				
				if (!document.fullscreenElement) {
					if (elem.requestFullscreen) {
						elem.requestFullscreen();
					} else if (elem.webkitRequestFullscreen) {
						elem.webkitRequestFullscreen();
					} else if (elem.msRequestFullscreen) {
						elem.msRequestFullscreen();
					}
					$(this).html('<i class="fas fa-compress"></i> Exit Fullscreen');
				} else {
					if (document.exitFullscreen) {
						document.exitFullscreen();
					} else if (document.webkitExitFullscreen) {
						document.webkitExitFullscreen();
					} else if (document.msExitFullscreen) {
						document.msExitFullscreen();
					}
					$(this).html('<i class="fas fa-expand"></i> Fullscreen');
				}
			});
			
			// Set up copy buttons
			setupCopyButtons();
			
			// Focus RDP frame for better interaction
			const iframe = document.getElementById("rdp-frame");
			iframe.setAttribute("tabindex", "0");
			
			// Return focus to iframe after any click
			window.addEventListener("click", () => {
				setTimeout(() => {
					iframe.focus();
				}, 50);
			});

			// Tab switching detection
			document.addEventListener('visibilitychange', function() {
				if (document.hidden && !assessmentCompleted) {
					handleTabSwitch();
				}
			});

			// Prevent context menu
			document.addEventListener('contextmenu', function(e) {
				if (!assessmentCompleted) {
					e.preventDefault();
				}
			});

			// Prevent keyboard shortcuts that might open new tabs/windows
			document.addEventListener('keydown', function(e) {
				if (!assessmentCompleted && (e.ctrlKey || e.metaKey)) {
					// Prevent Ctrl+N, Ctrl+T, Ctrl+W, etc.
					if (e.key === 'n' || e.key === 't' || e.key === 'w') {
						e.preventDefault();
						handleTabSwitch();
					}
				}
			});
		});
	</script>
</body>
</html>
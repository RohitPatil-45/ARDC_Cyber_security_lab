<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Cloud Portal - Docker Container</title>
    <head th:include="templateListing :: headFragment"></head> <!-- Consider removing nested <head> -->
    <link rel="icon" type="image/png" href="/webtemplate/dist/img/magicboxEye3.png">
    <style>
      /* Add horizontal scroll if needed */
      .table-responsive {
          overflow-x: auto;
      }
    </style>
</head>

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link
	href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap"
	rel="stylesheet">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <div th:replace="fragments/header :: header"></div>
        <div th:replace="fragments/sidebar :: aside"></div>
        <div class="content-wrapper">
            <section class="content-header">
                <!-- ... your breadcrumb and header ... -->
            </section>

            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-secondary">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <h3 class="card-title" style="padding-top: 10px">Docker Container Details</h3>
                                        </div>
                                        <div class="col-md-2"></div>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">  <!-- Added table-responsive here -->
                                     <table id="dockerContainerTable" class="table table-bordered table-hover" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>Container ID</th>
                                                <th>Image Name</th>
                                                <th>Command</th>
                                                <th>Created</th>
                                                <th>Status</th>
                                                <th>Ports</th>
                                                <th>Container Name</th>
                                                <th>Physical Server IP</th>
                                                <th>Services</th>
                                                <th>Username</th>
                                                <th>Scenario Name</th>
                                                <th>Last Active Connection</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="obj : ${listObj}">
                                                <td th:text="${obj.containerId}"></td>
                                                <td th:text="${obj.imageName}"></td>
                                                <td th:text="${obj.command}"></td>
                                                <td th:text="${#dates.format(obj.created, 'yyyy-MM-dd HH:mm:ss')}"></td>
                                                <td th:text="${obj.status}"></td>
                                                <td th:text="${obj.ports}"></td>
                                                <td th:text="${obj.containerName}"></td>
                                                <td th:text="${obj.physicalServerIp}"></td>
                                                 <td th:text="${obj.services}"></td>
                                                <td th:text="${obj.username}"></td>
                                                <td th:text="${obj.scenarioName}"></td>
                                                <td th:text="${obj.lastActiveConnection != null ? #dates.format(obj.lastActiveConnection, 'yyyy-MM-dd HH:mm:ss') : '-'}"></td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-cyber dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <i class="fas fa-cog"></i> Actions
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                           
                                                            <li>
                                                                <a class="dropdown-item" href="#" th:attr="data-id=${obj.containerName}" onclick="deleteContainer(this)">
                                                                    <i class="fas fa-trash"></i> Delete
                                                                </a>
                                                            </li>
   
																
                                                            <li>
                                                                <a class="dropdown-item" href="#" th:attr="data-id=${obj.containerName}" onclick="startContainer(this)">
                                                                    <i class="fas fa-play"></i> Start
                                                                </a>
                                                            </li>
                                                            <li>
                                                                <a class="dropdown-item" href="#" th:attr="data-id=${obj.containerName}" onclick="stopContainer(this)">
                                                                    <i class="fas fa-stop"></i> Stop
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <div th:replace="fragments/footer :: footer"></div>
    </div>

    <div th:replace="templateListing :: jsscript"></div>
    
     <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
     
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

    <script th:inline="javascript">
        $(function() {
            $("#dockerContainerTable").DataTable({
                responsive: true,
                lengthChange: false,
                autoWidth: false,
                buttons: ["csv", "excel", "print", "colvis"]
            }).buttons().container().appendTo('#dockerContainerTable_wrapper .col-md-6:eq(0)');
        });

//         function deleteContainer(button) {
//             const id = button.getAttribute('data-id');
//             alert()
//             if (confirm('Are you sure to delete container ' + id + '?')) {
//                 // AJAX call to delete endpoint
//             }
//         }

//         function stopContainer(button) {
//             const id = button.getAttribute('data-id');
//             // AJAX call to stop container
//         }

//         function startContainer(button) {
//             const id = button.getAttribute('data-id');
//             // AJAX call to start container
//         }

//         function editContainer(button) {
//             const id = button.getAttribute('data-id');
//             // Redirect or open modal for editing container
//         }
        
        
        function startContainer(button) {
        	 const containerName = button.getAttribute('data-id');
        	alert("sdsd")
            swal.fire({
                title: 'Start Lab?',
                html: `Are you sure you want to start <b>${containerName}</b>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-play"></i> Start Lab',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: '/guac/start_lab', // Make sure your backend supports this
                        data: {
                            "containerName": containerName
                        },
                        success: function(result) {
                            if (result === 'success') {
                            	swal.fire({
                                    icon: 'success',
                                    title: 'Started!',
                                    html: `Lab <b>${containerName}</b> has been started successfully.`,
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                            	swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Failed to start the lab!'
                                });
                            }
                        },
                        error: function() {
                        	swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Failed to start the lab!'
                            });
                        }
                    });
                }
            });
        }


        function stopContainer(button) {
        	 const containerName = button.getAttribute('data-id');
        	swal.fire({
                title: 'Stop Lab?',
                html: `Are you sure you want to stop <b>${containerName}</b>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-stop"></i> Stop Lab',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: '/guac/stop_lab',
                        data: {
                            "containerName": containerName
                        },
                        success: function(result) {
                            if (result === 'success') {
                            	swal.fire({
                                    icon: 'success',
                                    title: 'Stopped!',
                                    html: `Lab <b>${containerName}</b> has been stopped successfully.`,
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                            	swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Failed to stop the lab!'
                                });
                            }
                        },
                        error: function() {
                        	swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Failed to stop the lab!'
                            });
                        }
                    });
                }
            });
        }

        function deleteContainer(button) {
        	 const containerName = button.getAttribute('data-id');
        	swal.fire({
                title: 'Remove Lab?',
                html: `Are you sure you want to remove <b>${containerName}</b>?<br><span class="text-danger">This action cannot be undone!</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash"></i> Yes, remove it!',
                cancelButtonText: 'Cancel',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: '/guac/remove_lab',
                        data: {
                            "containerName": containerName
                        },
                        success: function(result) {
                            if (result === 'success') {
                            	swal.fire({
                                    icon: 'success',
                                    title: 'Removed!',
                                    html: `Lab <b>${containerName}</b> has been removed successfully.`,
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                            	swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Failed to remove the lab!'
                                });
                            }
                        },
                        error: function() {
                        	swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Failed to remove the lab!'
                            });
                        }
                    });
                }
            });
        }

        function resetLab(button) {
        	 const containerName = button.getAttribute('data-id');
        	swal.fire({
                title: 'Reset Lab?',
                html: `This will reset <b>${containerName}</b> to its initial state.<br><span class="text-warning">All progress will be lost!</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-redo"></i> Yes, reset it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: '/guac/reset_lab',
                        data: {
                            "containerName": containerName
                        },
                        success: function(result) {
                            if (result === 'success') {
                                swal.fire({
                                    icon: 'success',
                                    title: 'Reset!',
                                    html: `Lab <b>${containerName}</b> has been reset successfully.`,
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                            	swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Failed to reset the lab!'
                                });
                            }
                        },
                        error: function() {
                        	swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Failed to reset the lab!'
                            });
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>

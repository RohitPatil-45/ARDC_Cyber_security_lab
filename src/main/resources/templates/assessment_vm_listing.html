<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:include="template :: headFragment(${pageTitle})">
<title>Assessment Lab | Cyber Ranges</title>

<!-- Fonts & Icons -->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link
	href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap"
	rel="stylesheet">

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

<!-- Chart.js for percentage graphs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>
:root {
	--primary-blue: #2b7fff;
	--blue-dark: #1a5dd0;
	--blue-light: #3d8aff;
	--bg-light: #f8f9fa;
	--bg-card: #ffffff;
	--bg-card-header: #f1f5f9;
	--text-primary: #333333;
	--text-secondary: #666666;
	--border-color: #e0e0e0;
	--success: #00c853;
	--warning: #ffab00;
	--danger: #ff1744;
	--assessment-color: #8a2be2;
	--shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

* {
	box-sizing: border-box;
}

body {
	background-color: var(--bg-light);
	color: var(--text-primary);
	font-family: 'Poppins', sans-serif;
	line-height: 1.6;
	margin: 0;
	padding: 0;
}

.content-wrapper {
	padding: 1.5rem;
	background-color: var(--bg-light);
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
	color: var(--assessment-color);
	font-weight: 600;
	margin-top: 0;
}

h1 {
	font-size: 2rem;
	margin-bottom: 1.5rem;
}

h3 {
	font-size: 1.5rem;
	margin-bottom: 1rem;
}

/* Card Styles */
.card {
	background-color: var(--bg-card);
	border: 1px solid var(--border-color);
	border-radius: 8px;
	box-shadow: var(--shadow);
	margin-bottom: 1.5rem;
	overflow: hidden;
	transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card-header {
	border-bottom: 1px solid var(--border-color);
	background-color: var(--bg-card-header);
	padding: 1rem 1.5rem;
}

.card-title {
	font-weight: 600;
	font-size: 1.25rem;
	color: var(--assessment-color);
	margin: 0;
	display: flex;
	align-items: center;
	gap: 0.5rem;
}

.card-body {
	padding: 1.5rem;
}

/* Timer Styles */
.timer-container {
	background: linear-gradient(135deg, var(--assessment-color), #6a0dad);
	color: white;
	padding: 1rem;
	border-radius: 8px;
	margin-bottom: 1.5rem;
	text-align: center;
	box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
}

.timer-label {
	font-size: 0.9rem;
	text-transform: uppercase;
	letter-spacing: 1px;
	margin-bottom: 0.5rem;
	opacity: 0.9;
}

.timer-display {
	font-size: 2.5rem;
	font-weight: 700;
	font-family: 'Roboto Mono', monospace;
	margin: 0;
}

.timer-warning {
	background: linear-gradient(135deg, var(--warning), #ff6b00);
}

.timer-danger {
	background: linear-gradient(135deg, var(--danger), #c40000);
	animation: pulse 1s infinite;
}

@keyframes pulse {
	0% { opacity: 1; }
	50% { opacity: 0.7; }
	100% { opacity: 1; }
}

/* Table Styles */
.table-responsive {
	border-radius: 8px;
	overflow: hidden;
	border: 1px solid var(--border-color);
}

.table {
	margin-bottom: 0;
	color: var(--text-primary);
	background-color: var(--bg-card);
}

.table th {
	background-color: #e9ecef;
	color: #495057;
	font-weight: 600;
	border-bottom: 2px solid var(--border-color);
	padding: 1rem;
	text-transform: uppercase;
	font-size: 0.85rem;
	letter-spacing: 0.5px;
	white-space: nowrap;
}

.table td {
	vertical-align: middle;
	border-color: var(--border-color);
	padding: 1rem;
	background-color: var(--bg-card);
	color: var(--text-primary);
	white-space: nowrap;
}

.table-striped tbody tr:nth-of-type(odd) {
	background-color: #f8f9fa;
}

/* Button Styles */
.btn-assessment {
	background: linear-gradient(to bottom, var(--assessment-color), #6a0dad);
	color: #fff;
	border: none;
	font-weight: 600;
	border-radius: 4px;
	padding: 0.5rem 1.25rem;
	transition: all 0.3s ease;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	display: inline-flex;
	align-items: center;
	gap: 0.5rem;
}

.btn-assessment:hover {
	background: linear-gradient(to bottom, #7a1be2, #5a0cad);
	transform: translateY(-2px);
	box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
}

/* Badge Styles */
.badge {
	font-weight: 600;
	padding: 0.5rem 0.75rem;
	border-radius: 50px;
	font-size: 0.75rem;
}

.badge-assessment {
	background-color: var(--assessment-color);
	color: #fff;
}

.badge-success {
	background-color: var(--success);
}

.badge-warning {
	background-color: var(--warning);
}

.badge-danger {
	background-color: var(--danger);
}

/* Breadcrumb */
.breadcrumb {
	background-color: transparent;
	padding: 0;
	margin-bottom: 1.5rem;
}

.breadcrumb-item a {
	color: var(--assessment-color);
	text-decoration: none;
	transition: color 0.3s ease;
}

.breadcrumb-item.active {
	color: var(--text-secondary);
}

/* Text Section */
.text-section {
	margin-bottom: 2rem;
	padding: 1.5rem;
	background-color: var(--bg-card);
	border-radius: 8px;
	border-left: 4px solid var(--assessment-color);
	box-shadow: var(--shadow);
}

.text-section h1 {
	margin-top: 0;
	font-size: 1.8rem;
}

.text-section p {
	line-height: 1.6;
	margin-bottom: 0.5rem;
	color: var(--text-primary);
}

/* Progress Bar Styles */
.progress-container {
	width: 100%;
	height: 20px;
	background-color: #e9ecef;
	border-radius: 10px;
	overflow: hidden;
	margin: 0.5rem 0;
	position: relative;
}

.progress-bar {
	height: 100%;
	background: linear-gradient(90deg, var(--assessment-color), #9b4dff);
	border-radius: 10px;
	transition: width 0.5s ease;
	position: relative;
}

.progress-text {
	position: absolute;
	right: 10px;
	top: 0;
	font-size: 0.75rem;
	font-weight: 600;
	color: #333;
	text-shadow: none;
	line-height: 20px;
}

/* Status Indicators */
.status-indicator {
	display: inline-block;
	width: 10px;
	height: 10px;
	border-radius: 50%;
	margin-right: 0.5rem;
}

.status-active {
	background-color: var(--success);
}

.status-inactive {
	background-color: var(--danger);
}

.status-pending {
	background-color: var(--warning);
}

/* Action buttons container */
.action-buttons {
	display: flex;
	gap: 0.5rem;
}

/* Empty state styling */
.text-muted {
	color: #6c757d !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
	.content-wrapper {
		padding: 1rem;
	}
	
	.card-body {
		padding: 1rem;
	}
	
	.table-responsive {
		font-size: 0.9rem;
	}
	
	.action-buttons {
		flex-direction: column;
	}
	
	.timer-display {
		font-size: 2rem;
	}
}
</style>
<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">

		<!-- Header & Sidebar -->
		<div th:replace="fragments/header :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<!-- Main Content -->
		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>[[${pageTitle}]]</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#"><i
										class="fas fa-home"></i> Home</a></li>
								<li class="breadcrumb-item active">Assessment Lab</li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<!-- Assessment Timer -->
			<div class="row" th:if="${assessmentTime != null}">
				<div class="col-md-12">
					<div class="timer-container" id="timerContainer">
						<div class="timer-label">
							<i class="fas fa-clock"></i> ASSESSMENT TIME REMAINING
						</div>
						<div class="timer-display" id="timerDisplay">
							[[${assessmentTime}]]
						</div>
					</div>
				</div>
			</div>

			<!-- Assessment Instructions -->
			<div class="row">
				<div class="col-md-12">
					<div class="text-section">
						<h1>
							<i class="fas fa-clipboard-check"></i> ASSESSMENT GUIDELINES
						</h1>
						<div class="cyber-line"></div>
						<p>This is an assessment environment. Your performance is being evaluated.</p>
						<p>Timer is active - complete all tasks before time runs out.</p>
						<p>Browser-based access is provided via a web GUI service and SSH for Webshell access.</p>
					</div>
				</div>
			</div>

			<!-- Table and Instructions -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">
										<i class="fas fa-network-wired"></i> Assessment Lab Overview
									</h3>
								</div>
								<div class="card-body table-responsive" id="table-container">
									<table class="table table-bordered table-striped">
										<thead>
											<tr>
												<th>ID</th>
												<th>Lab Name</th>
												<th>IP Address</th>
												<th>UserName</th>
												<th>Password</th>
												<th>OS</th>
												<th>Status</th>
												<th>Progress</th>
												<th>State</th>
												<th>Console</th>
												<th>Action</th>
											</tr>
										</thead>
										<tbody>
											<th:block th:if="${labData != null and !labData.empty}">
												<tr th:each="data : ${labData}">
													<td th:text="${data['lab'].labId}"></td>
													<td th:text="${data['lab'].instanceName}"></td>
													<td th:text="${data['lab'].ipAddress}"></td>
													<td th:text="${data['lab'].instanceUser}"></td>
													<td th:text="${data['lab'].password}"></td>
													<td th:text="${data['os']}"></td>
													<td><span th:if="${data['lab'].Status == 'Completed'}"
														class="badge badge-success"> <i
															class="fas fa-circle status-indicator status-active"></i>
															Completed
													</span> <span th:unless="${data['lab'].Status == 'Completed'}"
														class="badge badge-warning"> <i
															class="fas fa-circle status-indicator status-pending"></i>
															In Progress
													</span></td>

													<td>
														<div class="progress-container">
															<div class="progress-bar"
																th:style="'width: ' + ${data['percentage']} + '%;'"></div>
															<div class="progress-text"
																th:text="${data['percentage']} + '%'"></div>
														</div>
													</td>

													<td th:text="${data['lab'].VmState}"></td>

													<td><a class="btn btn-sm btn-assessment console-link"
														th:href="@{|/guac/assessmentviewPlaylistConnection/${data['lab'].guacamoleId}|}"
														title="Access Virtual Machine Console" target="_blank">
															<i class="fas fa-desktop"></i> View Console
													</a></td>

													<td>
														<div class="action-buttons">
															<button class="btn btn-sm btn-assessment dropdown-toggle"
																type="button" id="dropdownMenuButton"
																data-bs-toggle="dropdown" aria-expanded="false">
																<i class="fas fa-cog"></i> Actions
															</button>
															<ul class="dropdown-menu"
																aria-labelledby="dropdownMenuButton">
																<!-- Show Start or Stop Lab based on VmState -->
																<li th:if="${data['lab'].VmState == 'stop'}"><a
																	class="dropdown-item start-lab-btn" href="#"
																	th:data-container-name="${data['lab'].instanceName}">
																		<i class="fas fa-play"></i> Start Lab
																</a></li>
																<li th:if="${data['lab'].VmState == 'running'}"><a
																	class="dropdown-item stop-lab-btn" href="#"
																	th:data-container-name="${data['lab'].instanceName}">
																		<i class="fas fa-stop"></i> Stop Lab
																</a></li>

																<!-- Remove Lab - Always show -->
																<li><a class="dropdown-item remove-lab-btn"
																	href="#"
																	th:data-container-name="${data['lab'].instanceName}">
																		<i class="fas fa-trash"></i> Remove Lab
																</a></li>

																<!-- Reset Lab - Always show -->
																<li><a class="dropdown-item reset-lab-btn" href="#"
																	th:data-container-name="${data['lab'].instanceName}">
																		<i class="fas fa-redo"></i> Reset Lab
																</a></li>
															</ul>
														</div>
													</td>
												</tr>
											</th:block>

											<tr th:if="${labData == null or labData.empty}">
												<td colspan="11" class="text-muted text-center"><i
													class="fas fa-inbox fa-2x mb-2"></i><br> No active assessment labs found.</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<!-- Footer -->
		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>

	<!-- Bootstrap JS for dropdowns -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// Timer functionality
		function startTimer(duration, display) {
			let timer = duration, minutes, seconds;
			const timerContainer = document.getElementById('timerContainer');
			
			const interval = setInterval(function () {
				minutes = parseInt(timer / 60, 10);
				seconds = parseInt(timer % 60, 10);

				minutes = minutes < 10 ? "0" + minutes : minutes;
				seconds = seconds < 10 ? "0" + seconds : seconds;

				display.textContent = minutes + ":" + seconds;

				// Update timer container class based on remaining time
				if (timer <= 300) { // 5 minutes
					timerContainer.classList.add('timer-danger');
					timerContainer.classList.remove('timer-warning');
				} else if (timer <= 900) { // 15 minutes
					timerContainer.classList.add('timer-warning');
					timerContainer.classList.remove('timer-danger');
				} else {
					timerContainer.classList.remove('timer-warning', 'timer-danger');
				}

				if (--timer < 0) {
					clearInterval(interval);
					display.textContent = "TIME'S UP!";
					timerContainer.classList.add('timer-danger');
					
					// Show time up message
					Swal.fire({
						icon: 'warning',
						title: 'Time Expired!',
						html: 'Assessment time has ended. Your work will be submitted automatically.',
						confirmButtonText: 'OK',
						allowOutsideClick: false
					});
				}
			}, 1000);
		}

		document.addEventListener('DOMContentLoaded', function() {
			// Initialize timer if assessment time is provided
			const timerDisplay = document.getElementById('timerDisplay');
			if (timerDisplay) {
				const timeString = timerDisplay.textContent;
				const [minutes, seconds] = timeString.split(':').map(Number);
				const totalSeconds = minutes * 60 + seconds;
				
				if (totalSeconds > 0) {
					startTimer(totalSeconds, timerDisplay);
				}
			}

			// Custom SweetAlert2 styling for assessment
			const swalWithAssessmentTheme = Swal.mixin({
				customClass: {
					confirmButton: 'btn btn-assessment',
					cancelButton: 'btn btn-secondary'
				},
				buttonsStyling: false
			});
			
			// Action button handlers (same as normal page but with assessment endpoints)
			document.querySelectorAll('.stop-lab-btn').forEach(button => {
				button.addEventListener('click', function(e) {
					e.preventDefault();
					const containerName = this.getAttribute('data-container-name');
					stopAssessmentLab(containerName);
				});
			});

			document.querySelectorAll('.start-lab-btn').forEach(button => {
				button.addEventListener('click', function(e) {
					e.preventDefault();
					const containerName = this.getAttribute('data-container-name');
					startAssessmentLab(containerName);
				});
			});

			document.querySelectorAll('.remove-lab-btn').forEach(button => {
				button.addEventListener('click', function(e) {
					e.preventDefault();
					const containerName = this.getAttribute('data-container-name');
					removeAssessmentLab(containerName);
				});
			});

			document.querySelectorAll('.reset-lab-btn').forEach(button => {
				button.addEventListener('click', function(e) {
					e.preventDefault();
					const containerName = this.getAttribute('data-container-name');
					resetAssessmentLab(containerName);
				});
			});

			function startAssessmentLab(containerName) {
				swalWithAssessmentTheme.fire({
					title: 'Start Assessment Lab?',
					html: `Are you sure you want to start <b>${containerName}</b>?`,
					icon: 'question',
					showCancelButton: true,
					confirmButtonText: '<i class="fas fa-play"></i> Start Lab',
					cancelButtonText: 'Cancel'
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							type: "POST",
							url: '/guac/assessment/start_lab',
							data: {
								"containerName": containerName
							},
							success: function(result) {
								if (result === 'success') {
									swalWithAssessmentTheme.fire({
										icon: 'success',
										title: 'Started!',
										html: `Assessment Lab <b>${containerName}</b> has been started successfully.`,
										confirmButtonText: 'OK'
									}).then(() => {
										location.reload();
									});
								} else {
									swalWithAssessmentTheme.fire({
										icon: 'error',
										title: 'Oops...',
										text: 'Failed to start the assessment lab!'
									});
								}
							},
							error: function() {
								swalWithAssessmentTheme.fire({
									icon: 'error',
									title: 'Oops...',
									text: 'Failed to start the assessment lab!'
								});
							}
						});
					}
				});
			}

			function stopAssessmentLab(containerName) {
				swalWithAssessmentTheme.fire({
					title: 'Stop Assessment Lab?',
					html: `Are you sure you want to stop <b>${containerName}</b>?`,
					icon: 'question',
					showCancelButton: true,
					confirmButtonText: '<i class="fas fa-stop"></i> Stop Lab',
					cancelButtonText: 'Cancel'
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							type: "POST",
							url: '/guac/assessment/stop_lab',
							data: {
								"containerName": containerName
							},
							success: function(result) {
								if (result === 'success') {
									swalWithAssessmentTheme.fire({
										icon: 'success',
										title: 'Stopped!',
										html: `Assessment Lab <b>${containerName}</b> has been stopped successfully.`,
										confirmButtonText: 'OK'
									}).then(() => {
										location.reload();
									});
								} else {
									swalWithAssessmentTheme.fire({
										icon: 'error',
										title: 'Oops...',
										text: 'Failed to stop the assessment lab!'
									});
								}
							},
							error: function() {
								swalWithAssessmentTheme.fire({
									icon: 'error',
									title: 'Oops...',
									text: 'Failed to stop the assessment lab!'
								});
							}
						});
					}
				});
			}

			function removeAssessmentLab(containerName) {
				swalWithAssessmentTheme.fire({
					title: 'Remove Assessment Lab?',
					html: `Are you sure you want to remove <b>${containerName}</b>?<br><span class="text-danger">This action cannot be undone!</span>`,
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: '<i class="fas fa-trash"></i> Yes, remove it!',
					cancelButtonText: 'Cancel',
					reverseButtons: true
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							type: "POST",
							url: '/guac/assessment/remove_lab',
							data: {
								"containerName": containerName
							},
							success: function(result) {
								if (result === 'success') {
									swalWithAssessmentTheme.fire({
										icon: 'success',
										title: 'Removed!',
										html: `Assessment Lab <b>${containerName}</b> has been removed successfully.`,
										confirmButtonText: 'OK'
									}).then(() => {
										location.reload();
									});
								} else {
									swalWithAssessmentTheme.fire({
										icon: 'error',
										title: 'Oops...',
										text: 'Failed to remove the assessment lab!'
									});
								}
							},
							error: function() {
								swalWithAssessmentTheme.fire({
									icon: 'error',
									title: 'Oops...',
									text: 'Failed to remove the assessment lab!'
								});
							}
						});
					}
				});
			}

			function resetAssessmentLab(containerName) {
				swalWithAssessmentTheme.fire({
					title: 'Reset Assessment Lab?',
					html: `This will reset <b>${containerName}</b> to its initial state.<br><span class="text-warning">All progress will be lost!</span>`,
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: '<i class="fas fa-redo"></i> Yes, reset it!',
					cancelButtonText: 'Cancel'
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							type: "POST",
							url: '/guac/assessment/reset_lab',
							data: {
								"containerName": containerName
							},
							success: function(result) {
								if (result === 'success') {
									swalWithAssessmentTheme.fire({
										icon: 'success',
										title: 'Reset!',
										html: `Assessment Lab <b>${containerName}</b> has been reset successfully.`,
										confirmButtonText: 'OK'
									}).then(() => {
										location.reload();
									});
								} else {
									swalWithAssessmentTheme.fire({
										icon: 'error',
										title: 'Oops...',
										text: 'Failed to reset the assessment lab!'
									});
								}
							},
							error: function() {
								swalWithAssessmentTheme.fire({
									icon: 'error',
									title: 'Oops...',
									text: 'Failed to reset the assessment lab!'
								});
							}
						});
					}
				});
			}

			// Animate progress bars on scroll into view
			const observerOptions = {
				root: null,
				rootMargin: '0px',
				threshold: 0.1
			};

			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const progressBar = entry.target.querySelector('.progress-bar');
						const width = progressBar.style.width;
						progressBar.style.width = '0';
						setTimeout(() => {
							progressBar.style.width = width;
						}, 100);
						observer.unobserve(entry.target);
					}
				});
			}, observerOptions);

			document.querySelectorAll('.progress-container').forEach(container => {
				observer.observe(container);
			});
		});
	</script>

</body>

</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:include="template :: headFragment(${pageTitle})">
<title>View Scenario | Cyber Ranges</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link
	href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap"
	rel="stylesheet">
</head>

<style>
body {
	background-color: #ffffff;
	color: #333333;
	font-family: 'Roboto', sans-serif;
}

.content-wrapper {
	background-color: #f8f9fa;
}

/* Card Styling */
.playlist-card {
	background-color: #ffffff;
	border: 2px solid #e0e0e0;
	border-radius: 12px;
	overflow: hidden;
	color: #333333;
	cursor: pointer;
	box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
	transition: transform 0.2s, box-shadow 0.2s;
}

.card-image img {
	width: 100%;
	height: 300px;
	object-fit: cover;
	display: block;
	border-bottom: 2px solid #e9ecef;
}

.card-content {
	padding: 24px;
	display: flex;
	flex-direction: column;
	gap: 12px;
}

.card-title {
	font-family: 'Poppins', sans-serif;
	font-size: 1.8rem;
	font-weight: 700;
	color: #2d4fa6;
	margin: 0;
}

.card-description {
	font-size: 1rem;
	color: #666666;
	margin: 0;
	line-height: 1.5;
}

.card-tags {
	margin-top: 12px;
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
}

.card-tags .tag {
	display: flex;
	align-items: center;
	gap: 6px;
	background: #f1f5f9;
	color: #2d4fa6;
	font-size: 0.85rem;
	font-weight: 500;
	padding: 6px 12px;
	border-radius: 12px;
	text-transform: uppercase;
}

/* Additional Info outside card */
.scenario-info {
	margin-top: 20px;
	background-color: #ffffff;
	border: 1px solid #e0e0e0;
	border-radius: 12px;
	padding: 20px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.scenario-info h4 {
	color: #2d4fa6;
	margin-bottom: 10px;
}

.scenario-info p {
	color: #333333;
	margin-bottom: 6px;
	font-size: 0.95rem;
}

/* Footer & other elements */
.main-footer {
	background-color: #f8f9fa;
	border-top: 1px solid #e0e0e0;
	color: #333333;
}

.start-btn {
	background: linear-gradient(90deg, #16a34a, #22c55e);
	color: #fff;
	padding: 6px 16px;
	border-radius: 20px;
	font-size: 0.9rem;
	font-weight: 600;
	text-decoration: none;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
	transition: all 0.3s ease;
}

.assessment-btn {
	background: linear-gradient(90deg, #9333ea, #a855f7);
	color: #fff;
	padding: 6px 16px;
	border-radius: 20px;
	font-size: 0.9rem;
	font-weight: 600;
	text-decoration: none;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
	transition: all 0.3s ease;
	border: none;
	cursor: pointer;
}

.view-assessment-btn {
	background: linear-gradient(90deg, #dc2626, #ef4444);
	color: #fff;
	padding: 6px 16px;
	border-radius: 20px;
	font-size: 0.9rem;
	font-weight: 600;
	text-decoration: none;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
	transition: all 0.3s ease;
	border: none;
	cursor: pointer;
}

.assessment-btn:hover {
	background: linear-gradient(90deg, #7e22ce, #9333ea);
	transform: translateY(-2px);
	box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
	color: white;
	text-decoration: none;
}

.view-assessment-btn:hover {
	background: linear-gradient(90deg, #b91c1c, #dc2626);
	transform: translateY(-2px);
	box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
	color: white;
	text-decoration: none;
}

.start-btn i {
	font-size: 0.9rem;
}

.assessment-btn i, .view-assessment-btn i {
	font-size: 0.9rem;
}

/* Comments Section Styles */
.comment {
	background-color: #f8f9fa;
	border-radius: 8px;
	padding: 15px;
	margin-bottom: 15px;
	position: relative;
	border-left: 3px solid #2d4fa6;
}

.comment-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 10px;
}

.comment-author {
	font-weight: 600;
	color: #2d4fa6;
}

.comment-date {
	color: #666;
	font-size: 0.85rem;
}

.comment-content {
	color: #333333;
	line-height: 1.5;
	margin-bottom: 10px;
}

.comment-actions {
	display: flex;
	gap: 15px;
}

.comment-action-btn {
	background: none;
	border: none;
	color: #2d4fa6;
	cursor: pointer;
	font-size: 0.9rem;
	display: flex;
	align-items: center;
	gap: 5px;
	transition: color 0.2s;
}

.comment-form {
	background-color: #f8f9fa;
	border-radius: 8px;
	padding: 20px;
	margin-bottom: 20px;
	border: 1px solid #e0e0e0;
}

.comment-textarea {
	width: 100%;
	background-color: #ffffff;
	border: 1px solid #ced4da;
	border-radius: 6px;
	color: #333333;
	padding: 12px;
	resize: vertical;
	min-height: 100px;
	margin-bottom: 15px;
	font-family: 'Roboto', sans-serif;
}

.comment-textarea:focus {
	outline: none;
	border-color: #2d4fa6;
	box-shadow: 0 0 0 2px rgba(45, 79, 166, 0.2);
}

.comment-form-actions {
	display: flex;
	justify-content: flex-end;
	gap: 10px;
}

.comment-submit-btn, .comment-cancel-btn {
	padding: 8px 16px;
	border-radius: 6px;
	font-weight: 500;
	cursor: pointer;
	border: none;
	transition: all 0.2s;
}

.comment-submit-btn {
	background-color: #2d4fa6;
	color: white;
}

.comment-cancel-btn {
	background-color: #6c757d;
	color: white;
}

.comment-edit-form {
	margin-top: 10px;
}

.hidden {
	display: none;
}

/* CSS for page loader */
.loader-overlay {
	position: fixed;
	inset: 0;
	display: grid;
	place-items: center;
	background: rgba(255, 255, 255, 0.9);
	backdrop-filter: blur(2px);
	z-index: 9999;
}

.spinner {
	width: 64px;
	height: 64px;
	border-radius: 50%;
	border: 6px solid #e6e6e6;
	border-top-color: #2d4fa6;
	animation: spin 0.9s linear infinite;
}

@keyframes spin {
	to { 
		transform:rotate(360deg);
	}
}

.loader-text {
	margin-top: 14px;
	color: #2d4fa6;
	font: 500 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto,
		sans-serif;
	letter-spacing: .2px;
}

@media (prefers-reduced-motion: reduce) {
	.spinner {
		animation: none;
		border-top-color: #2d4fa6;
	}
}

.page-content {
	min-height: 100vh;
	display: grid;
	place-items: center;
}

/* Modal Styles */
.modal-overlay {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(0, 0, 0, 0.5);
	z-index: 10000;
	justify-content: center;
	align-items: center;
}

.modal-content {
	background-color: #ffffff;
	border-radius: 12px;
	padding: 24px;
	width: 90%;
	max-width: 500px;
	border: 1px solid #e0e0e0;
	box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.modal-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 20px;
	padding-bottom: 15px;
	border-bottom: 1px solid #e0e0e0;
}

.modal-title {
	font-family: 'Poppins', sans-serif;
	font-size: 1.5rem;
	font-weight: 700;
	color: #2d4fa6;
	margin: 0;
}

.modal-close {
	background: none;
	border: none;
	color: #666;
	font-size: 1.5rem;
	cursor: pointer;
	transition: color 0.2s;
}

.modal-close:hover {
	color: #333;
}

.modal-body {
	margin-bottom: 20px;
}

.modal-select {
	width: 100%;
	padding: 10px 12px;
	background-color: #ffffff;
	border: 1px solid #ced4da;
	border-radius: 6px;
	color: #333333;
	font-size: 1rem;
}

.modal-select:focus {
	outline: none;
	border-color: #2d4fa6;
	box-shadow: 0 0 0 2px rgba(45, 79, 166, 0.2);
}

.modal-footer {
	display: flex;
	justify-content: flex-end;
	gap: 10px;
}

.modal-btn {
	padding: 8px 16px;
	border-radius: 6px;
	font-weight: 500;
	cursor: pointer;
	border: none;
	transition: all 0.2s;
}

.modal-btn-primary {
	background-color: #2d4fa6;
	color: white;
}

.modal-btn-primary:hover {
	background-color: #1e3a8a;
}

.modal-btn-secondary {
	background-color: #6c757d;
	color: white;
}

.modal-btn-secondary:hover {
	background-color: #5a6268;
}

/* Breadcrumb styling */
.breadcrumb {
	background-color: transparent;
}

.breadcrumb-item a {
	color: #2d4fa6;
	text-decoration: none;
}

.breadcrumb-item a:hover {
	color: #1e3a8a;
	text-decoration: underline;
}

/* Form controls */
.form-control {
	background-color: #ffffff;
	border: 1px solid #ced4da;
	color: #333333;
}

.form-control:focus {
	border-color: #2d4fa6;
	box-shadow: 0 0 0 2px rgba(45, 79, 166, 0.2);
}

.btn-outline-primary {
	color: #2d4fa6;
	border-color: #2d4fa6;
}

.btn-outline-primary:hover {
	background-color: #2d4fa6;
	border-color: #2d4fa6;
	color: white;
}

/* Content header */
.content-header h1 {
	color: #2d4fa6;
}

/* Success button */
.btn-success {
	background-color: #22c55e;
	border-color: #22c55e;
}

.btn-success:hover {
	background-color: #16a34a;
	border-color: #16a34a;
}

/* Primary button */
.btn-primary {
	background-color: #2d4fa6;
	border-color: #2d4fa6;
}

.btn-primary:hover {
	background-color: #1e3a8a;
	border-color: #1e3a8a;
}

/* Button container spacing */
.button-container {
	display: flex;
	align-items: center;
	gap: 10px;
	flex-wrap: wrap;
}
</style>

<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">
		<div th:replace="fragments/header :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>
								<i class="fas fa-list-ol playlist-icon"></i> View Scenario
							</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#"><i
										class="fas fa-home"></i> Home</a></li>
								<li class="breadcrumb-item active"><a href="#">Scenario</a></li>
							</ol>
							<div></div>
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid" id="scenarioContainer">
					<!-- Scenario card and additional info will be dynamically generated here -->
				</div>
			</section>

			<!-- Comments Section -->
			<div class="col-md-12 mt-4">
				<div class="card playlist-card">
					<div class="card-content">
						<h4 style="margin-bottom: 16px; color: #2d4fa6;">Comments</h4>

						<!-- Comment Form (initially hidden) -->
						<div id="commentForm" class="comment-form hidden">
							<textarea id="commentText" class="comment-textarea"
								placeholder="Write your comment here..."></textarea>
							<div class="comment-form-actions">
								<button id="cancelCommentBtn" class="comment-cancel-btn">Cancel</button>
								<button id="submitCommentBtn" class="comment-submit-btn">Submit</button>
							</div>
						</div>

						<div id="commentsContainer">
							<p id="noComments" style="color: #666;">No comments available
								for this scenario.</p>
							<!-- Comments will be dynamically inserted here -->
						</div>

						<button id="addCommentBtn" class="btn btn-primary mt-3">
							<i class="fas fa-plus"></i> Add Comment
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Page Loader -->
		<div id="pageLoader" class="loader-overlay" role="status"
			aria-live="polite" style="display: none" aria-label="Page loading">
			<div>
				<div class="spinner" aria-hidden="true"></div>
				<div class="loader-text">Loadingâ€¦</div>
			</div>
		</div>
		<!-- End Page Loader -->

		<!-- Move Scenario Modal -->
		<div id="moveScenarioModal" class="modal-overlay">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title">Move Scenario</h3>
					<button class="modal-close" onclick="closeMoveModal()">&times;</button>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="scenarioDropdown">Select Playlist</label> <select
							id="scenarioDropdown" class="form-control custom-select">
							<option value="">-- Choose a Playlist --</option>
							<option th:each="playlist : ${PlaylistList}"
								th:value="${playlist.Id}" th:text="${playlist.playlistName}"></option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button class="modal-btn modal-btn-secondary"
						onclick="closeMoveModal()">Cancel</button>
					<button class="modal-btn modal-btn-primary"
						onclick="submitMoveScenario()">Move Scenario</button>
				</div>
			</div>
		</div>

		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>

	<script>
// Global variables
let jsonData;
let scenarioId;
let editingCommentId = null;
let noofinstance;
let scenarioName;
let currentScenarioIdForMove = null;

document.addEventListener("DOMContentLoaded", function () {
    let rawData = '[[${listObj}]]'.replace(/&quot;/g, '"');

    try {
        jsonData = JSON.parse(rawData);
    } catch (e) {
        console.error("Invalid JSON:", e);
        return;
    }

    if (!jsonData || !jsonData.length) return;

    const item = jsonData[0];
    scenarioId = item.Id; 
    noofinstance = item.NumberofInstance;
    scenarioName = item.Scenario_Name;
    const container = document.getElementById("scenarioContainer");
    
    // Initialize all button states
    initializeButtonStates();
    
    const fragment = document.createDocumentFragment();

    // Card HTML
    const cardHTML = `
        <div class="col-md-12 mb-4">
            <div class="playlist-card">
                <div class="card-image">
                    <img src="/report/image/${item.Id}" alt="${item.Scenario_Title}" loading="lazy">
                </div>
                <div class="card-content">
                    <div class="mb-2">
                        <h3 class="card-title" style="font-weight: 700; margin: 0;">
                            ${item.Scenario_Title}
                        </h3>
                    </div>
                   
                    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3" style="gap: 10px;">
                        <h5 class="card-subtitle mb-0" style="font-weight: 500; color: #666;">
                            ${item.Scenario_Name || 'N/A'}
                        </h5>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                        <div id="Complete_Per"></div>
                            <div class="form-group mb-0">
                                <select required id="Actions_${item.Id}" name="Actions"
                                        class="form-control btn btn-outline-primary"
                                        style="padding: 8px 12px; height: 38px; font-weight: 500;"
                                        onchange="handleActionChange(this, '${item.Id}')">
                                    <option value="">-- Select --</option>
                                    <option value="edit">Edit</option>
                                    <option value="delete">Delete</option>
                                </select>
                            </div>
                            
                            <div class="button-container">
                                <div id="viewLab_btn">
                                    <a href="javascript:void(0);"
                                       class="btn btn-sm btn-success start-btn create-btn"
                                       onclick="updateLastActiveSession('${item.Id}')">
                                       <i class="fas fa-play"></i> View Lab
                                    </a>
                                </div>

                                <div id="createLab_btn">
                                    <button type="button" class="start-btn create-btn" onclick="createDockerContainer()">
                                        <i class="fas fa-play"></i> Create Lab
                                    </button>
                                </div>

                                <div id="assessment_btn">
                                    <button type="button" class="assessment-btn" onclick="startAssessment()">
                                        <i class="fas fa-clipboard-check"></i> Start Assessment
                                    </button>
                                </div>
                                
                                <div id="viewAssessmentLab_btn">
                                    <button type="button" class="view-assessment-btn" onclick="viewAssessmentLab()">
                                        <i class="fas fa-eye"></i> View Assessment Lab
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-tags mt-3 d-flex flex-wrap gap-2">
                        <span class="tag"><i class="fas fa-signal"></i> ${item.Difficulty_Level}</span>
                        <span class="tag"><i class="fas fa-clock"></i> ${item.Duration}</span>
                        <span class="tag"><i class="fas fa-gamepad"></i> ${item.Mode}</span>
                        <span class="tag"><i class="fas fa-layer-group"></i> ${item.Scenario_Type}</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Info HTML
    const infoHTML = `
        <div class="col-md-12 scenario-info">
            <p><strong>Category:</strong> ${item.Category || 'N/A'}</p>&nbsp;
            <div class="descriptionContent"></div>
        </div>
    `;

    // Create wrapper and append both card and info
    const wrapper = document.createElement("div");
    wrapper.innerHTML = cardHTML + infoHTML;
    fragment.appendChild(wrapper);
    container.appendChild(fragment);

    // Find the description container inside the wrapper
    const descEl = wrapper.querySelector(".descriptionContent");
    if (descEl) {
        // Create a temporary element to decode HTML entities
        const temp = document.createElement("div");
        temp.innerHTML = item.Description || 'N/A';
        descEl.innerHTML = temp.textContent || temp.innerText || 'N/A';
    }
    
    // Load comments for this scenario
    loadComments();
});

// Initialize all button states based on completion percentage and assessment lab status
function initializeButtonStates() {
    // First check completion percentage
    getPercenetageParticularScenerio();
}

// Get completion percentage and update button visibility
function getPercenetageParticularScenerio() {
    $.ajax({
        type: "POST",
        url: '/guac/getPercentageParticularScenario',
        data: {
            "scenarioId": scenarioId,
            "scenarioName": scenarioName
        },
        success: function(result) {
            result = result.trim();
            alert(result)
            if (!isNaN(result)) {
                let percentage = parseFloat(result);
                const el = document.getElementById("Complete_Per");
                el.innerText = "Completion: " + percentage + "%";

                // Update completion text color
                if (percentage == 100) {
                    el.style.color = "green";
                } else if (percentage >= 50) {
                    el.style.color = "orange";
                } else {
                    el.style.color = "red";
                }

                // Check if completion is 100%
                if (percentage == 100) {
                    // Hide Create Lab and View Lab buttons
                    $('#createLab_btn').hide();
//                     $('#viewLab_btn').hide();
                    
                    // Check if assessment lab exists
                    checkAssessmentLabStatus();
                } else {
                    // If completion is not 100%, show normal lab buttons
                    checkLabAvailability();
                    $('#assessment_btn').hide();
                    $('#viewAssessmentLab_btn').hide();
                }
            } else {
                const el = document.getElementById("Complete_Per");
                el.innerText = "Completion: N/A";
                el.style.color = "gray";
                
                // Default to normal lab buttons
                checkLabAvailability();
                $('#assessment_btn').hide();
                $('#viewAssessmentLab_btn').hide();
            }
        },
        error: function(err) {
            console.error("AJAX error:", err);
            document.getElementById("Complete_Per").innerText = "Error";
            
            // Default to normal lab buttons on error
            checkLabAvailability();
            $('#assessment_btn').hide();
            $('#viewAssessmentLab_btn').hide();
        }
    });
}

// Check if assessment lab exists
function checkAssessmentLabStatus() {
    $.ajax({
        type: "POST",
        url: '/guac/checkAssessmentLabStatus',
        data: {
            "scenarioId": scenarioId
        },
        success: function(result) {
            result = result.trim();
            if (result === "available") {
                // If assessment lab exists, show View Assessment Lab button and hide Start Assessment button
                $('#viewAssessmentLab_btn').show();
                $('#assessment_btn').hide();
            } else {
                // If assessment lab doesn't exist, show Start Assessment button
                $('#assessment_btn').show();
                $('#viewAssessmentLab_btn').hide();
            }
        },
        error: function(err) {
            console.error("Assessment status check error:", err);
            // On error, show Start Assessment button
            $('#assessment_btn').show();
            $('#viewAssessmentLab_btn').hide();
        }
    });
}

// Check if lab is available and update button visibility
function checkLabAvailability() {
    $.ajax({
        type: "POST",
        url: '/guac/showLabButtonOn_Check',
        data: {
            "scenarioId": scenarioId,
            "scenarioName": scenarioName
        },
        success: function(result) {
            result = result.trim();
            if (result === "available") {
                // Show View Lab, hide Create Lab
                $('#viewLab_btn').show();
                $('#createLab_btn').hide();
            } else if (result === "notavailable") {
                // Show Create Lab, hide View Lab
                $('#createLab_btn').show();
                $('#viewLab_btn').hide();
            } else {
                console.error("Unexpected result from server:", result);
                // Default to Create Lab
                $('#createLab_btn').show();
                $('#viewLab_btn').hide();
            }
        },
        error: function(err) {
            console.error("AJAX error:", err);
            // Default to Create Lab on error
            $('#createLab_btn').show();
            $('#viewLab_btn').hide();
        }
    });
}

// Event listeners for comment functionality
document.getElementById("addCommentBtn").addEventListener("click", showCommentForm);
document.getElementById("cancelCommentBtn").addEventListener("click", hideCommentForm);
document.getElementById("submitCommentBtn").addEventListener("click", submitComment);

function showCommentForm() {
    document.getElementById("commentForm").classList.remove("hidden");
    document.getElementById("addCommentBtn").classList.add("hidden");
    document.getElementById("commentText").focus();
}

function hideCommentForm() {
    document.getElementById("commentForm").classList.add("hidden");
    document.getElementById("addCommentBtn").classList.remove("hidden");
    document.getElementById("commentText").value = "";
    editingCommentId = null;
}

function submitComment() {
    const commentText = document.getElementById("commentText").value.trim();
    
    if (!commentText) {
        Swal.fire("Error", "Comment cannot be empty!", "error");
        return;
    }
    
    // Prepare data for submission
    const data = {
        scenarioId: scenarioId,
        comment: commentText
    };
    
    // If we're editing an existing comment, add the comment ID
    if (editingCommentId) {
        data.commentId = editingCommentId;
    }
    
    // Determine the appropriate endpoint
    const endpoint = editingCommentId ? "/guac/updateComment" : "/guac/addComment";
    
    // Send the request
    $.ajax({
        url: endpoint,
        type: "POST",
        data: {
            scenarioId: scenarioId,
            comment: commentText,
            ...(editingCommentId && { commentId: editingCommentId })
        },
        success: function (data) {
            if (data === "success") {
                Swal.fire("Success", editingCommentId ? "Comment updated successfully!" : "Comment added successfully!", "success");
                hideCommentForm();
                loadComments();
            } else {
                Swal.fire("Error", data.message || "Failed to save comment.", "error");
            }
        },
        error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
            Swal.fire("Error", "An error occurred while saving the comment.", "error");
        }
    });
}

function loadComments() {
    $.ajax({
        url: `/guac/getComments`,
        type: "GET",
        data: { scenarioId: scenarioId },
        dataType: "json",
        success: function (comments) {
            const commentsContainer = document.getElementById("commentsContainer");
            const noCommentsText = document.getElementById("noComments");

            commentsContainer.querySelectorAll(".comment").forEach(el => el.remove());

            if (comments && comments.length > 0) {
                noCommentsText.style.display = 'none';

                comments.forEach(comment => {
                    const commentEl = createCommentElement(comment);
                    commentsContainer.appendChild(commentEl);
                });
            } else {
                noCommentsText.style.display = 'block';
            }
        },
        error: function (xhr, status, error) {
            console.error("Error loading comments:", error);
        }
    });
}

function createCommentElement(comment) {
    const commentEl = document.createElement("div");
    commentEl.className = "comment";
    commentEl.dataset.commentId = comment.id;
    
    const commentDate = new Date(comment.createdAt);
    const formattedDate = commentDate.toLocaleDateString() + ' ' + commentDate.toLocaleTimeString();
    
    commentEl.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${comment.author || 'Anonymous'}</span>
            <span class="comment-date">${formattedDate}</span>
        </div>
        <div class="comment-content">${comment.content}</div>
        <div class="comment-actions">
            <button class="comment-action-btn edit-comment-btn">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button class="comment-action-btn delete-comment-btn">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    `;
    
    commentEl.querySelector(".edit-comment-btn").addEventListener("click", () => editComment(comment));
    commentEl.querySelector(".delete-comment-btn").addEventListener("click", () => deleteComment(comment.id));
    
    return commentEl;
}

function editComment(comment) {
    document.getElementById("commentText").value = comment.content;
    editingCommentId = comment.id;
    showCommentForm();
}

function deleteComment(commentId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This comment will be permanently deleted.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "/guac/deleteComment",
                type: "POST",
                data: ({ commentId: commentId }),
                success: function(data) {
                    if (data==="success") {
                        Swal.fire("Success", "Comment deleted successfully!", "success");
                        loadComments();
                    } else {
                        Swal.fire("Error", data.message || "Delete operation failed", "error");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error deleting comment:", error);
                    Swal.fire("Error", "Failed to delete comment!", "error");
                }
            });
        }
    });
}

function handleActionChange(selectElement, SceneriotId) {
    const action = selectElement.value;

    if (action === "edit") {
        editScenerio(SceneriotId);
    } else if (action === "delete") {
        deleteScenerio(SceneriotId);
    } else if (action === "move") {
        MoveScenerio(SceneriotId);
    }

    selectElement.value = "";
}

function MoveScenerio(id) {
    currentScenarioIdForMove = id;
    showMoveModal();
}

function showMoveModal() {
    document.getElementById("moveScenarioModal").style.display = "flex";
    loadPlaylists();
}

function closeMoveModal() {
    document.getElementById("moveScenarioModal").style.display = "none";
    currentScenarioIdForMove = null;
}

function editScenerio(id) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You are about to edit this scenario (ID: " + id + ").",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Edit it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/guac/editsceneriolist/' + id;
        }
    });
}

function deleteScenerio(id) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This will permanently delete the scenario (ID: " + id + ").",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/guac/deletsceneriolist/' + id;
        }
    });
}

function createDockerContainer() {
    $("#pageLoader").show();
    $.ajax({
        type: "POST",
        url: '/cloud_instance/docker',
        data: {
            "scenarioId": scenarioId,
        },
        success: function(result) {
            $("#pageLoader").hide();
            window.location = "/guac/View_Vm_Listing?Id=" + scenarioId;
        },
        error: function() {
            $("#pageLoader").hide();
            Swal.fire("Error", "Failed to create lab. Please try again.", "error");
        }
    });
}

function startAssessment() {
    $("#pageLoader").show();
    $.ajax({
        type: "POST",
        url: '/cloud_instance/assessment',
        data: {
            "scenarioId": scenarioId,
        },
        success: function(result) {
            $("#pageLoader").hide();
            if (result === "success") {
                Swal.fire({
                    icon: 'success',
                    title: 'Assessment Started!',
                    text: 'Your assessment has been successfully initiated.',
                    confirmButtonText: 'Continue to Assessment'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // After starting assessment, hide Start Assessment button and show View Assessment Lab button
                        $('#assessment_btn').hide();
                        $('#viewAssessmentLab_btn').show();
                        window.location = "/guac/assessmentView_Vm_Listing?Id=" + scenarioId;
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Assessment Failed',
                    text: result.message || 'Unable to start assessment. Please try again.'
                });
            }
        },
        error: function(xhr, status, error) {
            $("#pageLoader").hide();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while starting the assessment. Please try again.'
            });
            console.error("Assessment AJAX error:", error);
        }
    });
}

function viewAssessmentLab() {
    window.location = "/guac/assessmentView_Vm_Listing?Id=" + scenarioId;
}

function updateLastActiveSession(itemId) {
    $.ajax({
        type: "POST",
        url: "/guac/update_last_session",
        data: {
            id: itemId
        },
        success: function(response) {
            window.location.href = `/guac/View_Vm_Listing?Id=${itemId}`;
        },
        error: function() {
            Swal.fire({
                icon: 'error',
                title: 'Failed',
                text: 'Could not update last active session.'
            });
        }
    });
}

// Load playlists function (you may need to implement this based on your existing code)
function loadPlaylists() {
    // Implementation depends on your existing code
    console.log("Loading playlists...");
}
</script>
</body>
</html>
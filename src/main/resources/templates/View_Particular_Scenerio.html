<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:include="template :: headFragment(${pageTitle})">
<title>View Scenario | Cyber Ranges</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link
	href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap"
	rel="stylesheet">
</head>

<style>
body {
	background-color: #121212;
	color: #e0e0e0;
	font-family: 'Roboto', sans-serif;
}

.content-wrapper {
	background-color: #121212;
}

/* Card Styling */
.playlist-card {
	background-color: #1e1e1e;
	border: 2px solid #2d4fa6;
	border-radius: 12px;
	overflow: hidden;
	color: #e0e0e0;
	cursor: pointer;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
}

.card-image img {
	width: 100%;
	height: 300px;
	object-fit: cover;
	display: block;
	border-bottom: 2px solid #444;
}

.card-content {
	padding: 24px;
	display: flex;
	flex-direction: column;
	gap: 12px;
}

.card-title {
	font-family: 'Poppins', sans-serif;
	font-size: 1.8rem;
	font-weight: 700;
	color: #3b82f6;
	margin: 0;
}

.card-description {
	font-size: 1rem;
	color: #b0b0b0;
	margin: 0;
}

.card-tags {
	margin-top: 12px;
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
}

.card-tags .tag {
	display: flex;
	align-items: center;
	gap: 6px;
	background: #2d2d2d;
	color: #3b82f6;
	font-size: 0.85rem;
	font-weight: 500;
	padding: 6px 12px;
	border-radius: 12px;
	text-transform: uppercase;
}

/* Additional Info outside card */
.scenario-info {
	margin-top: 20px;
	background-color: #1a1a1a;
	border: 1px solid #333;
	border-radius: 12px;
	padding: 20px;
}

.scenario-info h4 {
	color: #3b82f6;
	margin-bottom: 10px;
}

.scenario-info p {
	color: #e0e0e0;
	margin-bottom: 6px;
	font-size: 0.95rem;
}

/* Footer & other elements */
.main-footer {
	background-color: #1a1a1a;
	border-top: 1px solid #333;
	color: #e0e0e0;
}

.start-btn {
	background: linear-gradient(90deg, #16a34a, #22c55e);
	color: #fff;
	padding: 6px 16px;
	border-radius: 20px;
	font-size: 0.9rem;
	font-weight: 600;
	text-decoration: none;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
	transition: all 0.3s ease;
}

.start-btn:hover {
	background: linear-gradient(90deg, #15803d, #16a34a);
	transform: translateY(-2px);
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
	text-decoration: none;
}

.start-btn i {
	font-size: 0.9rem;
}

/* Comments Section Styles */
.comment {
	background-color: #2a2a2a;
	border-radius: 8px;
	padding: 15px;
	margin-bottom: 15px;
	position: relative;
}

.comment-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 10px;
}

.comment-author {
	font-weight: 600;
	color: #3b82f6;
}

.comment-date {
	color: #888;
	font-size: 0.85rem;
}

.comment-content {
	color: #e0e0e0;
	line-height: 1.5;
	margin-bottom: 10px;
}

.comment-actions {
	display: flex;
	gap: 15px;
}

.comment-action-btn {
	background: none;
	border: none;
	color: #3b82f6;
	cursor: pointer;
	font-size: 0.9rem;
	display: flex;
	align-items: center;
	gap: 5px;
	transition: color 0.2s;
}

.comment-action-btn:hover {
	color: #60a5fa;
}

.comment-form {
	background-color: #2a2a2a;
	border-radius: 8px;
	padding: 20px;
	margin-bottom: 20px;
}

.comment-textarea {
	width: 100%;
	background-color: #1e1e1e;
	border: 1px solid #444;
	border-radius: 6px;
	color: #e0e0e0;
	padding: 12px;
	resize: vertical;
	min-height: 100px;
	margin-bottom: 15px;
	font-family: 'Roboto', sans-serif;
}

.comment-form-actions {
	display: flex;
	justify-content: flex-end;
	gap: 10px;
}

.comment-submit-btn, .comment-cancel-btn {
	padding: 8px 16px;
	border-radius: 6px;
	font-weight: 500;
	cursor: pointer;
	border: none;
}

.comment-submit-btn {
	background-color: #3b82f6;
	color: white;
}

.comment-cancel-btn {
	background-color: #6b7280;
	color: white;
}

.comment-edit-form {
	margin-top: 10px;
}

.hidden {
	display: none;
}

/* CSS for page loader */
/* ---- Page loader overlay ---- */
.loader-overlay {
	position: fixed;
	inset: 0; /* top:0 right:0 bottom:0 left:0 */
	display: grid;
	place-items: center; /* perfect centering */
	background: rgba(0, 0, 0, 0.4);
	backdrop-filter: blur(2px);
	/* subtle polish (ignored if unsupported) */
	z-index: 9999;
}

/* ---- Spinner ---- */
.spinner {
	width: 64px;
	height: 64px;
	border-radius: 50%;
	border: 6px solid #e6e6e6; /* track */
	border-top-color: #2563eb; /* indicator */
	animation: spin 0.9s linear infinite;
}

@keyframes spin {to { transform:rotate(360deg);
	
}

}

/* Optional loading text */
.loader-text {
	margin-top: 14px;
	color: #ffffff;
	font: 500 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto,
		sans-serif;
	text-shadow: 0 1px 2px rgba(0, 0, 0, .45);
	letter-spacing: .2px;
}

/* Respect users who prefer reduced motion */
@media ( prefers-reduced-motion : reduce) {
	.spinner {
		animation: none;
		border-top-color: #2563eb;
	}
}

/* Demo content area */
.page-content {
	min-height: 100vh;
	display: grid;
	place-items: center;
}
</style>

<body class="hold-transition sidebar-mini layout-fixed dark-mode">
	<div class="wrapper">
		<div th:replace="fragments/header :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>
								<i class="fas fa-list-ol playlist-icon"></i> View Scenario
							</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#"><i
										class="fas fa-home"></i> Home</a></li>
								<li class="breadcrumb-item active"><a href="#">Scenario</a></li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid" id="scenarioContainer">
					<!-- Scenario card and additional info will be dynamically generated here -->
				</div>
			</section>

			<!-- Comments Section -->
			<div class="col-md-12 mt-4">
				<div class="card playlist-card">
					<div class="card-content">
						<h4 style="margin-bottom: 16px; color: #3b82f6;">Comments</h4>

						<!-- Comment Form (initially hidden) -->
						<div id="commentForm" class="comment-form hidden">
							<textarea id="commentText" class="comment-textarea"
								placeholder="Write your comment here..."></textarea>
							<div class="comment-form-actions">
								<button id="cancelCommentBtn" class="comment-cancel-btn">Cancel</button>
								<button id="submitCommentBtn" class="comment-submit-btn">Submit</button>
							</div>
						</div>

						<div id="commentsContainer">
							<p id="noComments" style="color: #aaa;">No comments available
								for this scenario.</p>
							<!-- Comments will be dynamically inserted here -->
						</div>

						<button id="addCommentBtn" class="btn btn-primary mt-3">
							<i class="fas fa-plus"></i> Add Comment
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Page Loader -->
		<div id="pageLoader" class="loader-overlay" role="status"
			aria-live="polite" style="display: none" aria-label="Page loading">
			<div>
				<div class="spinner" aria-hidden="true"></div>
				<div class="loader-text">Loadingâ€¦</div>
			</div>
		</div>
		<!-- End Page Loader -->

		<!-- no of instance -->
		<div class="modal fade text-center" id="noOfInstance">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Lab creation</h5>
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="action" class="float-left">No of Instances</label> <input
								type="text" required id="instances" name="instances"
								class="form-control" placeholder="Enter No of Instances">
						</div>
						<input type="hidden" id="cloudInstanceId">
						<div class="form-group">
							<button class="btn btn-success"
								th:onclick="createDockerContainer()">Submit</button>
						</div>

					</div>
				</div>
			</div>
		</div>
		<!-- End no of instance -->

		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>
	<script th:src="@{/custom_js/viewParticularScenario.js}"></script>


	<script>
// Global variables
let jsonData;
let scenarioId;
let editingCommentId = null;
let instanceId;

document.addEventListener("DOMContentLoaded", function () {
    let rawData = '[[${listObj}]]'.replace(/&quot;/g, '"');

    try {
        jsonData = JSON.parse(rawData);
    } catch (e) {
        console.error("Invalid JSON:", e);
        return;
    }

    if (!jsonData || !jsonData.length) return;

    const item = jsonData[0];
    scenarioId = item.Id; // Store scenario ID for later use
    instanceId = item.LabId;
    const container = document.getElementById("scenarioContainer");

    const fragment = document.createDocumentFragment();

    // Card HTML
    const cardHTML = `
        <div class="col-md-12 mb-4">
            <div class="playlist-card">
                <div class="card-image">
                    <img src="/report/image/${item.Id}" alt="${item.Scenario_Title}" loading="lazy">
                </div>
                <div class="card-content">
                    <div class="mb-2">
                        <h3 class="card-title" style="font-weight: 700; margin: 0;">
                            ${item.Scenario_Title}
                        </h3>
                    </div>
                    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3" style="gap: 10px;">
                        <h5 class="card-subtitle mb-0" style="font-weight: 500; color: #555;">
                            ${item.Scenario_Name || 'N/A'}
                        </h5>
                        <div class="d-flex align-items-center" style="gap: 10px;">
                            <div class="form-group mb-0">
                                <select required id="Actions_${item.Id}" name="Actions"
                                        class="form-control btn btn-outline-primary"
                                        style="padding: 8px 12px; height: 38px; font-weight: 500;"
                                        onchange="handleActionChange(this, '${item.Id}')">
                                    <option value="">-- Select --</option>
                                    <option value="edit">Edit</option>
                                    <option value="delete">Delete</option>
                                </select>
                            </div>
                            <button type="button" class="start-btn create-btn"
								data-toggle="modal" data-target="#noOfInstance"
								th:data-request-id="${item.LabId}">
								<i class="fas fa-play"></i> Create Lab
							</button>
                        </div>
                    </div>
                    <div class="card-tags mt-3 d-flex flex-wrap gap-2">
                        <span class="tag"><i class="fas fa-signal"></i> ${item.Difficulty_Level}</span>
                        <span class="tag"><i class="fas fa-clock"></i> ${item.Duration}</span>
                        <span class="tag"><i class="fas fa-gamepad"></i> ${item.Mode}</span>
                        <span class="tag"><i class="fas fa-layer-group"></i> ${item.Scenario_Type}</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Info HTML
    const infoHTML = `
        <div class="col-md-12 scenario-info">
            <p><strong>Category:</strong> ${item.Category || 'N/A'}</p>&nbsp;
            <div class="descriptionContent"></div>
        </div>
    `;

    // Create wrapper and append both card and info
    const wrapper = document.createElement("div");
    wrapper.innerHTML = cardHTML + infoHTML;
    fragment.appendChild(wrapper);
    container.appendChild(fragment);

    // Find the description container inside the wrapper
    const descEl = wrapper.querySelector(".descriptionContent");
    if (descEl) {
        // Create a temporary element to decode HTML entities
        const temp = document.createElement("div");
        temp.innerHTML = item.Description || 'N/A';
        descEl.innerHTML = temp.textContent || temp.innerText || 'N/A';
    }
    
    // Load comments for this scenario
    loadComments();
});

// Event listeners for comment functionality
document.getElementById("addCommentBtn").addEventListener("click", showCommentForm);
document.getElementById("cancelCommentBtn").addEventListener("click", hideCommentForm);
document.getElementById("submitCommentBtn").addEventListener("click", submitComment);

function showCommentForm() {
    document.getElementById("commentForm").classList.remove("hidden");
    document.getElementById("addCommentBtn").classList.add("hidden");
    document.getElementById("commentText").focus();
}

function hideCommentForm() {
    document.getElementById("commentForm").classList.add("hidden");
    document.getElementById("addCommentBtn").classList.remove("hidden");
    document.getElementById("commentText").value = "";
    editingCommentId = null;
}

function submitComment() {
    const commentText = document.getElementById("commentText").value.trim();
    
    if (!commentText) {
        Swal.fire("Error", "Comment cannot be empty!", "error");
        return;
    }
    
    // Prepare data for submission
    const data = {
        scenarioId: scenarioId,
        comment: commentText
    };
    
    // If we're editing an existing comment, add the comment ID
    if (editingCommentId) {
        data.commentId = editingCommentId;
    }
    
    // Determine the appropriate endpoint
    const endpoint = editingCommentId ? "/guac/updateComment" : "/guac/addComment";
    
 // Send the request
    $.ajax({
        url: endpoint,
        type: "POST",
        data: {
            scenarioId: scenarioId,
            comment: commentText,
            ...(editingCommentId && { commentId: editingCommentId }) // add only if editing
        },
        success: function (data) {
            if (data === "success") {
                Swal.fire("Success", editingCommentId ? "Comment updated successfully!" : "Comment added successfully!", "success");
                hideCommentForm();
                loadComments();
            } else {
                Swal.fire("Error", data.message || "Failed to save comment.", "error");
            }
        },
        error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
            Swal.fire("Error", "An error occurred while saving the comment.", "error");
        }
    });


}

function loadComments() {
    $.ajax({
        url: `/guac/getComments`,
        type: "GET",
        data: { scenarioId: scenarioId }, // Pass scenarioId as query param
        dataType: "json", // Expect JSON response
        success: function (comments) {
            const commentsContainer = document.getElementById("commentsContainer");
            const noCommentsText = document.getElementById("noComments");

            // Remove all comment blocks
            commentsContainer.querySelectorAll(".comment").forEach(el => el.remove());

            if (comments && comments.length > 0) {
                noCommentsText.style.display = 'none';

                comments.forEach(comment => {
                    const commentEl = createCommentElement(comment);
                    commentsContainer.appendChild(commentEl);
                });
            } else {
                noCommentsText.style.display = 'block';
            }
        },
        error: function (xhr, status, error) {
            console.error("Error loading comments:", error);
        }
    });
}


function createCommentElement(comment) {
    const commentEl = document.createElement("div");
    commentEl.className = "comment";
    commentEl.dataset.commentId = comment.id;
    
    // Format date
    const commentDate = new Date(comment.createdAt);
    const formattedDate = commentDate.toLocaleDateString() + ' ' + commentDate.toLocaleTimeString();
    
    commentEl.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${comment.author || 'Anonymous'}</span>
            <span class="comment-date">${formattedDate}</span>
        </div>
        <div class="comment-content">${comment.content}</div>
        <div class="comment-actions">
            <button class="comment-action-btn edit-comment-btn">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button class="comment-action-btn delete-comment-btn">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    `;
    
    // Add event listeners for edit and delete buttons
    commentEl.querySelector(".edit-comment-btn").addEventListener("click", () => editComment(comment));
    commentEl.querySelector(".delete-comment-btn").addEventListener("click", () => deleteComment(comment.id));
    
    return commentEl;
}

function editComment(comment) {
    // Show the comment form with the existing content
    document.getElementById("commentText").value = comment.content;
    editingCommentId = comment.id;
    showCommentForm();
}

function deleteComment(commentId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This comment will be permanently deleted.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: "/guac/deleteComment",
                type: "POST",
                data: ({ commentId: commentId }),
                success: function(data) {
                    if (data==="success") {
                        Swal.fire("Success", "Comment deleted successfully!", "success");
                        loadComments(); // Reload comments
                    } else {
                        Swal.fire("Error", data.message || "Delete operation failed", "error");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error deleting comment:", error);
                    Swal.fire("Error", "Failed to delete comment!", "error");
                }
            });
        }
    });
}


function handleActionChange(selectElement, SceneriotId) {
    const action = selectElement.value;

    if (action === "edit") {
        editScenerio(SceneriotId);
    } else if (action === "delete") {
        deleteScenerio(SceneriotId);
    }

    // Reset dropdown
    selectElement.value = "";
}

function editScenerio(id) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You are about to edit this scenario (ID: " + id + ").",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Edit it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/guac/editsceneriolist/' + id;
        }
    });
}

function deleteScenerio(id) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This will permanently delete the scenario (ID: " + id + ").",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/guac/deletsceneriolist/' + id;
        }
    });
}

function createDockerContainer() {
	$("#pageLoader").show();
	$.ajax({
		type: "POST",
		url : '/cloud_instance/docker',
		data : {
			"instanceID" : instanceId,
			"noOfInstances" : $('#instances').val(),
			"scenarioId" : scenarioId
			
		},
		success : function(result) {
			$("#pageLoader").hide();
			window.location = "/guac/View_Vm_Listing?Id="+scenarioId;
			//alert(result);
		}
	});
}
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="template :: headFragment(${pageTitle})"></head>
<link rel="icon" type="image/png" href="/webtemplate/dist/img/magicboxEye3.png">

<link rel="stylesheet"
	th:href="@{/webtemplate/plugins/select2/css/select2.min.css}">
<link rel="stylesheet"
	th:href="@{/webtemplate/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css}">
<link rel="stylesheet"
	th:href="@{/webtemplate/multiselect/bootstrap-multiselect.css}">

<link rel="stylesheet" type="text/css"
	th:href="@{/webtemplate/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css}">

<style>
.homepage-hero-module {
	position: relative;
}

.bg-overlay {
	background: linear-gradient(to right, #ffffff00 0%, #000000 90%);
	width: 100%;
	display: block;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	width: 100%;
}

.mycard {
	margin-bottom: 1rem;
	background: transparent;
	position: relative;
	display: -webkit-flex;
	display: -ms-flexbox;
	display: flex;
	-webkit-flex-direction: column;
	-ms-flex-direction: column;
	flex-direction: column;
	min-width: 0;
	word-wrap: break-word;
	background-clip: border-box;
	border: 0 solid rgba(0, 0, 0, .125);
	border-radius: .25rem;
}

.whitetextmy {
	color: white;
}

.greytextmy {
	color: grey;
}

.captcha-container {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
}

.captcha-text {
    font-weight: bold;
    font-size: 18px;
    letter-spacing: 2px;
    color: #333;
    margin-bottom: 8px;
    user-select: none;
}

.captcha-refresh {
    cursor: pointer;
    color: #007bff;
    font-size: 14px;
    margin-left: 10px;
}

.captcha-refresh:hover {
    text-decoration: underline;
}

.text-captcha {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    font-style: italic;
    text-decoration: line-through;
    color: #555;
    background-color: #f0f0f0;
    padding: 5px;
    border-radius: 3px;
}
</style>
<body>
	<section class="pt-5 pb-5 pb-0 homepage-hero-module"
		style="background-size: cover; min-height: 100vh; background-image: url(&quot;/webtemplate/dist/img/cloud-computing.jpg&quot;);">
		<div class="bg-overlay position-absolute"></div>
		<div class="container position-relative zindex-1 pt-3 pb-3">
			<div
				class="row  text-center align-content-center justify-content-between ">
				<div class="col-12 col-md-7 pr-md-5 text-left align-self-center ">

				</div>

				<div class="col-12  col-md-5 ">
					<div class="mycard text-left h-100">
						<div class="card-body px-4 py-5" style="margin-top: -68px">
							<h3 class="text-center mt-0 m-b-15">
								<a href="javascript:void(0);" id="logo" class="logo logo-admin">
									<img src="/webtemplate/dist/img/Magicbox-logo.png"
									style="width: 80%;" width="100px" ;="" alt="logo">
								</a>
							</h3>
							<br>
							<center>

								<h3 class="pb-3 font-weight-bold whitetextmy">Sign In To
									MAGIC BOX</h3>
							</center>
							<br>


							<form name='f' th:action="@{/j_spring_security_check}"
								method='POST' id="loginForm">

								<div class="form-floating mb-3">
									<label for="exampleInputEmail1"
										class="text-uppercase greytextmy">Username</label> <input
										type='text' name='username' value='' class="form-control"
										placeholder="Please Enter Username" />
								</div>

								<div class="form-floating mb-3" id="show_hide_password">
									<label for="exampleInputPassword1"
										class="text-uppercase greytextmy">Password</label> <input
										type='password' name='password' class="form-control"
										id="password" placeholder="Please Enter Password" />
									<div class="input-group-append"
										style="float: right; margin-top: -38px; height: 38px;">
										<span class="input-group-text" style="cursor: pointer;"><i
											class="fa fa-eye-slash" aria-hidden="true"></i></span>
									</div>
								</div>
                                
                                <!-- Enhanced CAPTCHA Section -->
                                <div class="form-floating mb-3">
                                    <label class="text-uppercase greytextmy">CAPTCHA Verification</label>
                                    <div class="captcha-container">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span id="captchaText" class="captcha-text"></span>
                                            <span id="refreshCaptcha" class="captcha-refresh">
                                                <i class="fa fa-refresh"></i> Refresh
                                            </span>
                                        </div>
                                        <input type="hidden" id="captchaAnswer">
                                        <input type="hidden" id="captchaType">
                                        <input type="text" class="form-control mt-2" id="captchaInput" 
                                            placeholder="Enter the answer" required>
                                        <div class="invalid-feedback" id="captchaError">
                                            Please enter the correct CAPTCHA answer.
                                        </div>
                                    </div>
                                </div>

								<div class="form-floating mb-3">
									<label for="exampleiii" class="text-uppercase greytextmy"></label>
									<input type="checkbox" name="remember-me" />&nbsp;<span
										class="greytextmy">Remember Me?</span><span class="pull-right"><a
										class="link-primary fw-bolder me-1" href="/users/signup">&nbsp;
											Sign Up here</a></span>
								</div>

								<br>
								<div class="row">
									<div class="col-md-6">
										<div class="form-floating mb-3">

											<button name="submit" type="submit" value="submit"
												class="btn btn-block bg-gradient-primary float-right">
												<a style="color: white;">Login</a>
											</button>


										</div>
									</div>

									<div class="col-md-6">
										<div class="form-floating mb-3">

											<button type="reset" name="resetbtn" id="resetbtn"
												class="btn btn-block bg-gradient-primary">Reset</button>


										</div>
									</div>
								</div>

								<span class="pull-right"><a
									class="link-primary fw-bolder me-1" href="/users/ForgetPass">&nbsp;
										Forget Password?</a></span>

								<center>
									<div class="greytextmy" style="display: none;">
										Copyright ï¿½ 2024- <a href="https://canaris.in/"
											style="color: #ffa500bd;">Tarang Pvt Ltd</a>
									</div>
								</center>

								<div th:if="${#request.getParameter('error') == 'true'}"
									id="login-error-message" style="color: red; margin: 10px 0px;">
									Login Failed..! <br /> <br />Reason: <br /> <span
										th:if="${#session != null and #session.getAttribute('SPRING_SECURITY_LAST_EXCEPTION') != null}">
										<span
										th:if="${#session.getAttribute('SPRING_SECURITY_LAST_EXCEPTION').message.contains('Bad credentials')}">
											Incorrect login credentials </span> <span
										th:unless="${#session.getAttribute('SPRING_SECURITY_LAST_EXCEPTION').message.contains('Bad credentials')}"
										th:utext="${#session.getAttribute('SPRING_SECURITY_LAST_EXCEPTION').message}">
									</span>
									</span>
								</div>

							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<div th:replace="template :: jsscript"></div>
</body>
<script th:src="@{/webtemplate/plugins/select2/js/select2.full.min.js}"></script>
<script
	th:src="@{/webtemplate/multiselect/bootstrap-multiselect.min.js}"></script>
<script th:src="@{/webtemplate/multiselect/bootstrap-multi.js}"></script>
<script th:src="@{/webtemplate/multiselect/bootstrap-multiselect.js}"></script>
<script
	th:src="@{/webtemplate/multiselect/bootstrap-multiselect.min.js.js}"></script>
<script
	th:src="@{/webtemplate/plugins/jquery-validation/jquery.validate.min.js}"></script>
<script
	th:src="@{/webtemplate/plugins/jquery-validation/additional-methods.min.js}"></script>

<script th:src="@{/webtemplate/plugins/sweetalert2/sweetalert2.min.js}"></script>

<script th:inline="javascript">
	if([[${resetPasswordMessage}]] == 'success'){
		Swal.fire({
			position: "top",
			icon: "success",
			title: 'Your Password has been reset please login with new password..!',
			showConfirmButton: true,
			timer: 5000,
		})
	}

	document.addEventListener("DOMContentLoaded", function() {
		var errorMessageDiv = document.getElementById("login-error-message");

		if (errorMessageDiv) {
			var errorMessage = errorMessageDiv.innerText
					|| errorMessageDiv.textContent;
			if (errorMessage.includes("credentials")) {
				Swal.fire({
					position : "top",
					icon : "error",
					title : errorMessage,
					showConfirmButton : true,
					timer : 3000,
				})
			} else if (errorMessage.includes("Maximum")) {
				Swal.fire({
					position : "top",
					icon : "error",
					title : "User is already logged in..!",
					showConfirmButton : true,
					timer : 3000,
				})
			}

		}
	});

	var input = $("#show_hide_password input");
	var icon = $("#show_hide_password i");
	icon.on('click', function(event) {
		event.preventDefault();

		if (input.attr("type") === "text") {
			input.attr('type', 'password');
			icon.addClass("fa-eye-slash");
			icon.removeClass("fa-eye");

		} else if (input.attr("type") === "password") {
			input.attr('type', 'text');
			icon.removeClass("fa-eye-slash");
			icon.addClass("fa-eye");
		}
	});
	
	// Enhanced CAPTCHA functionality
    function generateCaptcha() {
        // Randomly select CAPTCHA type (0: addition, 1: subtraction, 2: text)
        const captchaType = Math.floor(Math.random() * 3);
        document.getElementById('captchaType').value = captchaType;
        
        let captchaQuestion = '';
        let captchaAnswer = '';
        
        if (captchaType === 0) {
            // Addition CAPTCHA
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            captchaQuestion = `${num1} + ${num2} = ?`;
            captchaAnswer = num1 + num2;
        } else if (captchaType === 1) {
            // Subtraction CAPTCHA (ensure positive result)
            const num1 = Math.floor(Math.random() * 10) + 6;
            const num2 = Math.floor(Math.random() * 5) + 1;
            captchaQuestion = `${num1} - ${num2} = ?`;
            captchaAnswer = num1 - num2;
        } else {
            // Text-based CAPTCHA
            const texts = [
                {q: "Enter the word 'orange'", a: "orange"},
                {q: "Type 'seven' in lowercase", a: "seven"},
                {q: "What is 3rd month? (abbr)", a: "mar"},
                {q: "Spell 'cloud' backwards", a: "duolc"},
                {q: "First 3 letters of 'password'", a: "pas"}
            ];
            const selected = texts[Math.floor(Math.random() * texts.length)];
            captchaQuestion = selected.q;
            captchaAnswer = selected.a;
            
            // Apply special styling for text CAPTCHAs
            document.getElementById('captchaText').className = 'captcha-text text-captcha';
        }
        
        // Update the CAPTCHA display
        document.getElementById('captchaText').textContent = captchaQuestion;
        document.getElementById('captchaAnswer').value = captchaAnswer;
        
        // Clear the input field
        document.getElementById('captchaInput').value = '';
        document.getElementById('captchaInput').classList.remove('is-invalid');
    }
    
    // Initialize CAPTCHA on page load
    document.addEventListener('DOMContentLoaded', function() {
        generateCaptcha();
        
        // Add refresh CAPTCHA functionality
        document.getElementById('refreshCaptcha').addEventListener('click', function() {
            generateCaptcha();
        });
        
        // Add form validation for CAPTCHA
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            const userAnswer = document.getElementById('captchaInput').value.trim();
            const correctAnswer = document.getElementById('captchaAnswer').value;
            const captchaType = document.getElementById('captchaType').value;
            
            let isValid = false;
            
            // Validate based on CAPTCHA type
            if (captchaType === '0' || captchaType === '1') {
                // Math CAPTCHAs (numeric comparison)
                isValid = parseInt(userAnswer) === parseInt(correctAnswer);
            } else {
                // Text CAPTCHAs (case-insensitive comparison)
                isValid = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            }
            
            if (!isValid) {
                e.preventDefault();
                document.getElementById('captchaInput').classList.add('is-invalid');
                
                Swal.fire({
                    position: "top",
                    icon: "error",
                    title: "CAPTCHA verification failed. Please try again.",
                    showConfirmButton: true,
                    timer: 3000,
                });
                
                generateCaptcha(); // Generate a new CAPTCHA on failure
            }
        });
        
        // Clear validation when user starts typing in CAPTCHA field
        document.getElementById('captchaInput').addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
    });
</script>
</html>
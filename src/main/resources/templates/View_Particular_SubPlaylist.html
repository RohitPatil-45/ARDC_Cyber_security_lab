<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:include="template :: headFragment(${pageTitle})">
	<title>View Sub-Playlist | Cyber Ranges</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link
		href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Poppins:wght@400;600;700&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

	<!-- Bootstrap Multiselect CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-multiselect/dist/css/bootstrap-multiselect.css">
</head>

<style>
	/* Updated to match first page's light theme */
	body {
		background-color: #ffffff;
		color: #333333;
		font-family: 'Roboto', sans-serif;
	}

	.content-wrapper {
		background-color: #f8f9fa;
	}

	/* Sub-Playlist Card */
	.subplaylist-card {
		background-color: #ffffff;
		border: 2px solid #e0e0e0;
		border-radius: 12px;
		overflow: hidden;
		color: #333333;
		box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
		transition: transform 0.2s, box-shadow 0.2s;
	}

	.card-image img {
		width: 100%;
		height: 280px;
		object-fit: cover;
		border-bottom: 2px solid #e9ecef;
	}

	.card-content {
		padding: 20px;
	}

	/* Sub-Playlist Title */
	.card-title {
		font-family: 'Poppins', sans-serif;
		font-size: 1.6rem;
		font-weight: 700;
		color: #2d4fa6;
		margin: 0;
	}

	/* Sub-Playlist Tags */
	.card-tags {
		margin-top: 12px;
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
	}

	.card-tags .tag {
		display: flex;
		align-items: center;
		gap: 6px;
		background: #f1f5f9;
		color: #2d4fa6;
		font-size: 0.85rem;
		font-weight: 500;
		padding: 6px 12px;
		border-radius: 12px;
		text-transform: uppercase;
	}

	/* Sub-Playlist Info */
	.subplaylist-info {
		margin-top: 20px;
		background-color: #ffffff;
		border: 1px solid #e0e0e0;
		border-radius: 12px;
		padding: 20px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
	}

	.subplaylist-info h4 {
		color: #2d4fa6;
		margin-bottom: 10px;
	}

	.subplaylist-info p {
		color: #333333;
		margin-bottom: 6px;
		font-size: 0.95rem;
	}

	/* Add Scenario Button */
	.add-btn {
		background: linear-gradient(90deg, #16a34a, #22c55e);
		color: #fff;
		padding: 8px 18px;
		border-radius: 20px;
		font-size: 0.9rem;
		font-weight: 600;
		text-decoration: none;
		display: inline-flex;
		align-items: center;
		gap: 6px;
		box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
		transition: all 0.3s ease;
		border: none;
	}

	.add-btn:hover {
		background: linear-gradient(90deg, #15803d, #16a34a);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
		color: #fff;
		text-decoration: none;
	}

	.subplaylist-title-tags {
		display: flex;
		align-items: center;
		gap: 10px;
		/* space between title and tags */
	}

	.card-tags .tag {
		font-size: 0.85rem;
		padding: 4px 10px;
	}

	/* Dropdown menu styling for light theme */
	.dropdown-menu {
		background-color: #ffffff;
		border: 1px solid #e0e0e0;
	}

	.dropdown-item {
		color: #333333;
	}

	.dropdown-item:hover {
		background-color: #2d4fa6;
		color: #fff;
	}

	/* Scenario card styling */
	.scenario-card {
		background-color: #ffffff;
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		padding: 15px;
		margin-bottom: 15px;
		transition: all 0.3s ease;
		box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
	}

	.scenario-card:hover {
		background-color: #f8f9fa;
		transform: translateY(-2px);
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	}

	.scenario-content {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	/* Form controls */
	.form-control {
		background-color: #ffffff;
		border: 1px solid #ced4da;
		color: #333333;
	}

	.form-control:focus {
		border-color: #2d4fa6;
		box-shadow: 0 0 0 2px rgba(45, 79, 166, 0.2);
	}

	.btn-outline-primary {
		color: #2d4fa6;
		border-color: #2d4fa6;
	}

	.btn-outline-primary:hover {
		background-color: #2d4fa6;
		border-color: #2d4fa6;
		color: white;
	}

	/* Primary button */
	.btn-primary {
		background-color: #2d4fa6;
		border-color: #2d4fa6;
	}

	.btn-primary:hover {
		background-color: #1e3a8a;
		border-color: #1e3a8a;
	}

	/* Success button */
	.btn-success {
		background-color: #22c55e;
		border-color: #22c55e;
	}

	.btn-success:hover {
		background-color: #16a34a;
		border-color: #16a34a;
	}

	/* Modal styling for light theme */
	.modal-content {
		background-color: #ffffff;
		color: #333333;
	}

	.modal-header {
		border-bottom: 1px solid #e0e0e0;
	}

	.modal-footer {
		border-top: 1px solid #e0e0e0;
	}
</style>

<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">
		<div th:replace="fragments/header :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>
								<i class="fas fa-list-ol subplaylist-icon"></i> View
								Sub-Playlist
							</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i> Home</a></li>
								<li class="breadcrumb-item active"><a href="#">Sub-Playlist</a></li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid" id="subplaylistContainer">
					<!-- Sub-Playlist details will load here -->
				</div>
			</section>
		</div>

		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>

	<!-- Add Scenario Modal -->
	<div class="modal fade" id="addScenarioModal" tabindex="-1" role="dialog" aria-labelledby="addScenarioModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="addScenarioModalLabel">Add
						Scenario to Sub-Playlist</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form id="addScenarioForm">
						<div class="form-group">
							<label for="scenarioDropdown">Select Scenario</label> <select id="scenarioDropdown"
								class="form-control" multiple="multiple">
								<option th:each="scenario : ${scenarioList}" th:value="${scenario.Id}"
									th:text="${scenario.ScenarioName}">
								</option>
							</select>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<button type="submit" form="addScenarioForm" class="btn btn-primary">Add</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			let rawData = '[[${listObj}]]'.replace(/&quot;/g, '"');
			let subPlaylistRawData = '[[${subPlaylistObj}]]'.replace(/&quot;/g, '"');
			let jsonData;
			let subPlaylistData;

			try {
				jsonData = JSON.parse(rawData);
				subPlaylistData = JSON.parse(subPlaylistRawData);
			} catch (e) {
				console.error("Invalid JSON:", e);
				return;
			}

			const container = document.getElementById("subplaylistContainer");

			// If no sub-playlist data found
			if (!subPlaylistData || Object.keys(subPlaylistData).length === 0) {
				container.innerHTML = `
            <div class="col-md-12 text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h4 class="text-warning">Sub-Playlist not found</h4>
                <p class="text-muted">The requested sub-playlist could not be found.</p>
            </div>
        `;
				return;
			}

			// If no scenarios found
			if (!jsonData || !jsonData.length) {
				container.innerHTML = `
            <div class="col-md-12 mb-4">
                <div class="subplaylist-card">
                    <div class="card-image">
                        <img src="/guac/SubPlaylistimage/${subPlaylistData.Id}" alt="Sub-Playlist Cover" loading="lazy">
                    </div>
                    <div class="card-content">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="card-title mb-0">${subPlaylistData.Playlist_Title || 'Untitled Sub-Playlist'}</h3>
                            <div class="d-flex align-items-center">
                                <!-- Action Dropdown -->
                                <div class="form-group mb-0 mr-2">
                                
                                 
                                    <select required id="Actions" name="Actions"
                                            class="form-control btn btn-outline-primary"
                                            style="padding: 8px 12px; height: 38px; font-weight: 500;"
                                            onchange="handleActionChange(this)">
                                      <option value="">-- Select --</option>
                                      <option value="edit">Edit</option>
                                      <option value="delete">Delete</option>
                                    </select>
                                    
                                   
                                </div>

                                <!-- Add Dropdown -->
                                <div class="dropdown">
                                    <button class="add-btn dropdown-toggle" type="button" id="addDropdownMenu"
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                      <i class="fas fa-plus"></i> Add
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="addDropdownMenu">
                                      <!-- Option: Add Scenario -->
                                      <a class="dropdown-item" href="#" data-toggle="modal" data-target="#addScenarioModal">
                                        <i class="fas fa-flask mr-2 text-primary"></i> Add Scenario
                                      </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="subplaylist-info mt-2">
                            <h4>Sub-Playlist Details</h4>
                            <p><strong>Name:</strong> ${subPlaylistData.Playlist_Name || 'N/A'}</p>
                            <p><strong>Description:</strong> ${subPlaylistData.Description || 'No description available'}</p>
                            <p><strong>Tags:</strong> ${subPlaylistData.Tag || 'No tags'}</p>
                        </div>

                        <div class="subplaylist-info mt-3">
                            <h4>Scenarios</h4>
                            <p class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-3"></i><br>
                                <span class="text-muted">No scenarios found in this sub-playlist</span><br>
                                <small class="text-muted">Add scenarios using the "Add" button</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
				return;
			}

			const fragment = document.createDocumentFragment();

			const cardHTML = `
        <div class="col-md-12 mb-4">
            <div class="subplaylist-card">
                <div class="card-image">
                    <img src="/guac/SubPlaylistimage/${subPlaylistData.Id}" alt="Sub-Playlist Cover" loading="lazy">
                </div>
                <div class="card-content">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="card-title mb-0">${subPlaylistData.Playlist_Title || 'Untitled Sub-Playlist'}</h3>
                        <div class="d-flex align-items-center">
                            <!-- Action Dropdown -->
                            <div class="form-group mb-0 mr-2">
                             
                                <select required id="Actions" name="Actions"
                                        class="form-control btn btn-outline-primary"
                                        style="padding: 8px 12px; height: 38px; font-weight: 500;"
                                        onchange="handleActionChange(this)">
                                  <option value="">-- Select --</option>
                                  <option value="edit">Edit</option>
                                  <option value="delete">Delete</option>
                                </select>
                               
                            </div>

                            <!-- Add Dropdown -->
                            <div class="dropdown">
                                <button class="add-btn dropdown-toggle" type="button" id="addDropdownMenu"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                  <i class="fas fa-plus"></i> Add
                                </button>
                                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="addDropdownMenu">
                                  <!-- Option: Add Scenario -->
                                  <a class="dropdown-item" href="#" data-toggle="modal" data-target="#addScenarioModal">
                                    <i class="fas fa-flask mr-2 text-primary"></i> Add Scenario
                                  </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="subplaylist-info mt-2">
                        <h4>Sub-Playlist Details</h4>
                        <p><strong>Name:</strong> ${subPlaylistData.Playlist_Name || 'N/A'}</p>
                        <p><strong>Description:</strong> ${subPlaylistData.Description || 'No description available'}</p>
                        <p><strong>Tags:</strong> ${subPlaylistData.Tag || 'No tags'}</p>
                    </div>

                    <div class="subplaylist-info mt-3">
                        <h4>Scenarios in this Sub-Playlist</h4>
                        <p class="mb-3">This sub-playlist contains ${jsonData.length} scenario(s)</p>
    `;

			let contentHTML = ``;

			// Add scenarios
			if (jsonData.length > 0) {
				jsonData.forEach(scenario => {
					contentHTML += `
                <div class="scenario-card d-flex align-items-center p-3 mb-3">
                    <!-- Left Image -->
                    <div class="scenario-image" style="flex:0 0 120px; margin-right:15px;">
                        <img src="/guac/Scenarioimage/${scenario.Id}" alt="${scenario.Scenario_Title}" 
                             style="width:120px; height:80px; object-fit:cover; border-radius:4px;" loading="lazy">
                    </div>

                    <!-- Middle Content -->
                    <div class="scenario-content flex-grow-1">
                        <h5 class="mb-1" style="color:#333;">${scenario.Scenario_Name || 'Untitled Scenario'}</h5>
                        
                    </div>

                    <!-- Right Buttons -->
                    <div class="scenario-actions ml-3 text-right">
                        <button class="btn btn-sm btn-primary" style="background:#2d4fa6; border:none;" onclick='ScenerioCardClick("${scenario.Id}")'>
                            <i class="fas fa-play"></i> START
                        </button>
                        <button class="btn btn-sm btn-link text-muted ml-2" onclick='removeItem("scenario", "${scenario.Id}")'>
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
				});
			}

			contentHTML += `</div></div></div></div>`; // close all divs

			const wrapper = document.createElement("div");
			wrapper.innerHTML = cardHTML + contentHTML;
			fragment.appendChild(wrapper);
			container.appendChild(fragment);
		});

		// The rest of your JavaScript functions remain the same
		function removeItem(itemType, itemId) {
			let urlParams = new URLSearchParams(window.location.search);
			let subPlaylistId = urlParams.get("Id");

			Swal.fire({
				title: "Are you sure?",
				text: `This scenario will be removed from the sub-playlist.`,
				icon: "warning",
				showCancelButton: true,
				confirmButtonColor: "#3085d6",
				cancelButtonColor: "#d33",
				confirmButtonText: "Yes, remove it",
				cancelButtonText: "Cancel"
			}).then((result) => {
				if (result.isConfirmed) {
					$.ajax({
						type: "GET",
						url: "/guac/removeSubPlaylistItem",
						data: {
							subPlaylistId: subPlaylistId,
							itemId: itemId
						},
						success: function (response) {
							if (response === "success") {
								Swal.fire({
									icon: "success",
									title: "Removed",
									text: "Scenario removed successfully!",
									timer: 2000,
									showConfirmButton: false
								}).then(() => location.reload());
							} else {
								Swal.fire({
									icon: "error",
									title: "Failed",
									text: "Failed to remove scenario."
								});
							}
						},
						error: function () {
							Swal.fire({
								icon: "error",
								title: "Error",
								text: "Error while removing scenario. Please try again."
							});
						}
					});
				}
			});
		}

		function ScenerioCardClick(id) {
			window.location.href = "/guac/View_Particular_Scenerio?Id=" + id;
		}

		function handleActionChange(selectElement) {
			let urlParams = new URLSearchParams(window.location.search);
			let subPlaylistId = urlParams.get("Id");
			const action = selectElement.value;

			if (action === "edit") {
				editSubPlaylist(subPlaylistId);
			} else if (action === "delete") {
				deleteSubPlaylist(subPlaylistId);
			}

			// Reset dropdown
			selectElement.value = "";
		}

		function editSubPlaylist(id) {
			Swal.fire({
				title: 'Are you sure?',
				text: "You are about to edit this sub-playlist (ID: " + id + ").",
				icon: 'question',
				showCancelButton: true,
				confirmButtonText: 'Yes, Edit it!',
				cancelButtonText: 'Cancel',
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33'
			}).then((result) => {
				if (result.isConfirmed) {
					window.location.href = '/guac/Edit_Sub_Playlist/' + id;
				}
			});
		}

		function deleteSubPlaylist(id) {
			Swal.fire({
				title: 'Are you sure?',
				text: "This action will permanently delete the sub-playlist (ID: " + id + ").",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Yes, Delete it!',
				cancelButtonText: 'Cancel',
				confirmButtonColor: '#e74c3c',
				cancelButtonColor: '#6c757d'
			}).then((result) => {
				if (result.isConfirmed) {
					window.location.href = '/guac/deletesubplaylist/' + id;
				}
			});
		}
	</script>



	<!-- SweetAlert2 -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap-multiselect/dist/js/bootstrap-multiselect.min.js"></script>



	<script>
		$(document).ready(function () {
			// Initialize dropdowns

			$('#scenarioDropdown').multiselect({
				includeSelectAllOption: true,
				enableFiltering: true,
				maxHeight: 250,
				buttonWidth: '100%',
				nonSelectedText: '--Please Select Scenario--'
			});

			$('.dropdown-toggle').dropdown();

			$("#addScenarioForm").on("submit", function (event) {
				event.preventDefault(); // prevent default form submission

				let scenarioIds = $("#scenarioDropdown").val();

				if (!scenarioIds || scenarioIds.length === 0) {
					Swal.fire({
						icon: "warning",
						title: "No Scenario Selected",
						text: "Please select a scenario before adding."
					});
					return;
				}

				// Get subPlaylistId from URL
				let urlParams = new URLSearchParams(window.location.search);
				let subPlaylistId = urlParams.get("Id");

				// Send AJAX request to controller
				$.ajax({
					type: "POST",
					url: "/guac/addSubPlaylist_Scenario",
					traditional: true,
					data: {
						subPlaylistId: subPlaylistId,
						scenarioIds: scenarioIds
					},
					success: function (response) {
						$("#addScenarioModal").modal("hide");
						if (response == "success") {
							Swal.fire({
								icon: "success",
								title: "Scenario(s) Added",
								text: "Selected scenario(s) added successfully!!",
								timer: 2000,
								showConfirmButton: false
							}).then(() => location.reload());
						}
						
						else{
							window.location = "/403";
						}

					},
					error: function () {
						Swal.fire({
							icon: "error",
							title: "Failed",
							text: "Failed to add scenario(s). Try again."
						});
					}
				});
			});
		});
	</script>

</body>

</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:include="template :: headFragment(${pageTitle})">
<title>View Vm List | CMPs</title>
<link rel="icon" type="image/png" href="/webtemplate/dist/img/magicboxEye3.png">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link
	href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap"
	rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

</head>
<style>
body {
	font-family: 'Poppins', sans-serif;
	background-color: #f4f7f9;
}

.card {
	border-radius: 8px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.card-header {
	background-color: #ffffff;
	border-bottom: 1px solid #e0e0e0;
	padding: 1.25rem 1.5rem;
}

.card-title {
	font-weight: 600;
	font-size: 1.25rem;
	color: #333;
}

.table-responsive {
	overflow-x: auto;
}

.table {
	background-color: #ffffff;
	border-radius: 8px;
	overflow: hidden;
}

.table th {
	background-color: #e9ecef;
	color: #495057;
	font-weight: 600;
	text-transform: uppercase;
	font-size: 0.85rem;
	border-top: none;
	padding: 1rem;
	white-space: nowrap;
}

.table td {
	vertical-align: middle;
	padding: 1rem;
	white-space: nowrap;
}

.table-striped tbody tr:nth-of-type(odd) {
	background-color: #f8f9fa;
}

.table-hover tbody tr:hover {
	background-color: #f1f5f9;
}

.badge {
	font-size: 0.75rem;
	font-weight: 600;
	padding: 0.4em 0.8em;
	border-radius: 50px;
}

.progress-container {
	height: 1rem;
	background-color: #e9ecef;
	border-radius: 50px;
	overflow: hidden;
	position: relative;
}

.progress-bar {
	height: 100%;
	border-radius: 50px;
	transition: width 0.6s ease;
	background-color: #007bff;
}

.progress-text {
	position: absolute;
	right: 0.5rem;
	top: 50%;
	transform: translateY(-50%);
	font-size: 0.75rem;
	font-weight: 600;
	color: #333;
	z-index: 1;
}

.action-buttons .dropdown-toggle {
	background-color: #6c757d;
	border-color: #6c757d;
}

.action-buttons .dropdown-toggle:hover {
	background-color: #5a6268;
	border-color: #545b62;
}
</style>
<body class="hold-transition sidebar-mini layout-fixed light-mode">
	<div class="wrapper">

		<div th:replace="fragments/header :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
						</div>
						<div class="col-sm-6">
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">
										<i class="fas fa-network-wired"></i> Ideal Labs 
									</h3>
								</div>
								<div class="card-body">
									<div class="table-responsive" id="table-container">
										<table
											class="table table-bordered table-striped table-hover mb-0">
											<thead>
												<tr>
													<th>ID</th>
													<th>Lab Name</th>
													<th>IP Address</th>
													<th>UserName</th>
													<th>Password</th>
													<th>OS</th>
													<th>Physical Server IP</th>
													<th>Scenario Name</th>
													<th>Status</th>
													<th>Progress</th>
													<th>State</th>
													<th>Console</th>
													<th>Action</th>
												</tr>
											</thead>
											<tbody>
												<th:block th:if="${labData != null and !labData.empty}">
													<tr th:each="data : ${labData}">
														<td th:text="${data['lab'].labId}"></td>
														<td th:text="${data['lab'].instanceName}"></td>
														<td th:text="${data['lab'].ipAddress}"></td>
														<td th:text="${data['lab'].instanceUser}"></td>
														<td th:text="${data['lab'].password}"></td>
														<td th:text="${data['os']}"></td>
														<td th:text="${data['PhysicalServerIP']}"></td>
														<td th:text="${data['ScenarioName']}"></td>
														<td><span
															th:if="${data['lab'].Status == 'Completed'}"
															class="badge bg-success"> <i
																class="fas fa-check-circle me-1"></i> Completed
														</span> <span
															th:unless="${data['lab'].Status == 'Completed'}"
															class="badge bg-warning text-dark"> <i
																class="fas fa-sync-alt me-1"></i> In Progress
														</span></td>

														<td>
															<div class="progress-container">
																<div class="progress-bar" role="progressbar"
																	th:style="'width: ' + ${data['percentage']} + '%;'"
																	th:aria-valuenow="${data['percentage']}"
																	aria-valuemin="0" aria-valuemax="100"></div>
																<div class="progress-text"
																	th:text="${data['percentage']} + '%'"></div>
															</div>
														</td>

														<td th:text="${data['lab'].VmState}"></td>

														<td><a class="btn btn-sm btn-info"
															th:href="@{|/guac/viewPlaylistConnection/${data['lab'].guacamoleId}|}"
															title="Access Virtual Machine Console" target="_blank">
																<i class="fas fa-desktop"></i> Console
														</a></td>

														<td>
															<div class="dropdown action-buttons">
																<button
																	class="btn btn-sm btn-secondary dropdown-toggle"
																	type="button" id="dropdownMenuButton"
																	data-bs-toggle="dropdown" aria-expanded="false">
																	<i class="fas fa-cog"></i>
																</button>
																<ul class="dropdown-menu"
																	aria-labelledby="dropdownMenuButton">
																	<li th:if="${data['lab'].VmState == 'stop'}"><a
																		class="dropdown-item start-lab-btn" href="#"
																		th:data-container-name="${data['lab'].instanceName}">
																			<i class="fas fa-play"></i> Start Lab
																	</a></li>
																	<li th:if="${data['lab'].VmState == 'running'}"><a
																		class="dropdown-item stop-lab-btn" href="#"
																		th:data-container-name="${data['lab'].instanceName}">
																			<i class="fas fa-stop"></i> Stop Lab
																	</a></li>
																	<li><a class="dropdown-item remove-lab-btn"
																		href="#"
																		th:data-container-name="${data['lab'].instanceName}">
																			<i class="fas fa-trash"></i> Remove Lab
																	</a></li>
																	<li><a class="dropdown-item reset-lab-btn"
																		href="#"
																		th:data-container-name="${data['lab'].instanceName}">
																			<i class="fas fa-redo"></i> Reset Lab
																	</a></li>
																</ul>
															</div>
														</td>
													</tr>
												</th:block>

												<tr th:if="${labData == null or labData.empty}">
													<td colspan="13" class="text-muted text-center py-4"><i
														class="fas fa-inbox fa-2x mb-2"></i><br> No active
														labs found.</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// jQuery is still used in this template, ensure it's loaded before this script block.
		// For consistency, I will use jQuery functions as they are in the original code.
		function startConnection(id) {
			$.ajax({
				type : "POST",
				url : '/guac/startConnectionLab',
				data : {
					"UserLabId" : id
				},
				success : function(result) {
					window.location = "/guac/viewPlaylistConnection/" + result;
				}
			});
		}
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function() {
			const swalWithBootstrapButtons = Swal.mixin({
				customClass : {
					confirmButton : 'btn btn-primary',
					cancelButton : 'btn btn-secondary'
				},
				buttonsStyling : false
			});

			function setupLabActionListeners() {
				document.querySelectorAll('.start-lab-btn').forEach(
						button => {
							button.addEventListener('click', function(e) {
								e.preventDefault();
								const containerName = this
										.getAttribute('data-container-name');
								handleLabAction(containerName, 'start');
							});
						});

				document.querySelectorAll('.stop-lab-btn').forEach(
						button => {
							button.addEventListener('click', function(e) {
								e.preventDefault();
								const containerName = this
										.getAttribute('data-container-name');
								handleLabAction(containerName, 'stop');
							});
						});

				document.querySelectorAll('.remove-lab-btn').forEach(
						button => {
							button.addEventListener('click', function(e) {
								e.preventDefault();
								const containerName = this
										.getAttribute('data-container-name');
								handleLabAction(containerName, 'remove');
							});
						});

				document.querySelectorAll('.reset-lab-btn').forEach(
						button => {
							button.addEventListener('click', function(e) {
								e.preventDefault();
								const containerName = this
										.getAttribute('data-container-name');
								handleLabAction(containerName, 'reset');
							});
						});
			}

			function handleLabAction(containerName, action) {
				let title, html, icon, confirmButtonText, url;

				switch (action) {
				case 'start':
					title = 'Start Lab?';
					html = `Are you sure you want to start <b>${containerName}</b>?`;
					icon = 'question';
					confirmButtonText = '<i class="fas fa-play"></i> Start Lab';
					url = '/guac/start_lab';
					break;
				case 'stop':
					title = 'Stop Lab?';
					html = `Are you sure you want to stop <b>${containerName}</b>?`;
					icon = 'question';
					confirmButtonText = '<i class="fas fa-stop"></i> Stop Lab';
					url = '/guac/stop_lab';
					break;
				case 'remove':
					title = 'Remove Lab?';
					html = `Are you sure you want to remove <b>${containerName}</b>? This action cannot be undone!`;
					icon = 'warning';
					confirmButtonText = '<i class="fas fa-trash"></i> Yes, remove it!';
					url = '/guac/remove_lab';
					break;
				case 'reset':
					title = 'Reset Lab?';
					html = `This will reset <b>${containerName}</b> to its initial state. All progress will be lost!`;
					icon = 'warning';
					confirmButtonText = '<i class="fas fa-redo"></i> Yes, reset it!';
					url = '/guac/reset_lab';
					break;
				default:
					return;
				}

				swalWithBootstrapButtons
						.fire({
							title : title,
							html : html,
							icon : icon,
							showCancelButton : true,
							confirmButtonText : confirmButtonText,
							cancelButtonText : 'Cancel',
							reverseButtons : true
						})
						.then((result) => {
							if (result.isConfirmed) {
								$.ajax({
									type : "POST",
									url : url,
									data : {
										"containerName" : containerName
									},
									success : function(response) {
										if (response === 'success') {
											swalWithBootstrapButtons
													.fire({
														icon : 'success',
														title : 'Success!',
														html : `Lab <b>${containerName}</b> has been ${action}ed successfully.`,
														confirmButtonText : 'OK'
													})
													.then(() => {
														location.reload();
													});
										} else {
											swalWithBootstrapButtons
													.fire({
														icon : 'error',
														title : 'Oops...',
														text : `Failed to ${action} the lab!`
													});
										}
									},
									error : function() {
										swalWithBootstrapButtons
												.fire({
													icon : 'error',
													title : 'Oops...',
													text : `Failed to ${action} the lab!`
												});
									}
								});
							}
						});
			}

			setupLabActionListeners();

			// Animate progress bars on scroll into view
			const observerOptions = {
				root : null,
				rootMargin : '0px',
				threshold : 0.1
			};

			const observer = new IntersectionObserver((entries, observer) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const progressBar = entry.target;
						const width = progressBar.style.width;
						progressBar.style.width = '0';
						setTimeout(() => {
							progressBar.style.width = width;
						}, 100);
						observer.unobserve(entry.target);
					}
				});
			}, observerOptions);

			document.querySelectorAll('.progress-bar').forEach(
					progressBar => {
						observer.observe(progressBar);
					});
		});
	</script>
</body>
</html>
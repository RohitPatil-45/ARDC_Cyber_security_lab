<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>Cloud Portal</title>
<head th:include="templateListing :: headFragment"></head>
<style>
/* Add a custom style for the Action button to make it look nice */
.action-btn {
	background-color: #007bff;
	color: white;
	border: none;
	padding: 8px 12px;
	border-radius: 4px;
	cursor: pointer;
	transition: background-color 0.3s ease;
}

.action-btn:hover {
	background-color: #0056b3;
}

/* Style for the modal and progress bar */
.progress-container {
	height: 25px;
	background-color: #e9ecef;
	border-radius: 5px;
	margin-top: 10px;
}

.progress-bar {
	background-color: #28a745;
	transition: width 0.6s ease;
}
</style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">
		<div th:replace="fragments/header :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>User Wise Performance</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Home</a></li>
								<li class="breadcrumb-item active">User Wise Performance</li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card card-secondary">
								<div class="card-header">
									<h3 class="card-title" style="padding-top: 10px">
										User Performance Details
									</h3>
								</div>
								<div class="card-body">
									<table id="userPerformanceTable"
										class="table table-bordered table-striped">
										<thead class="thead-light">
											<tr>
												<th>Sr No.</th>
												<th>User Name</th>
												<th>Performance %</th>
												<th>Action</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div class="modal fade" id="performanceModal" tabindex="-1"
		aria-labelledby="performanceModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="performanceModalLabel">Scenario
						Performance for <span id="modalUsername"></span>
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body" id="modalBodyContent">
					<p>Loading performance data...</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div th:replace="templateListing :: jsscript"></div>

	<script type="text/javascript"
		th:src="@{/webtemplate/plugins/jquery-validation/jquery.validate.min.js}"></script>
	<script type="text/javascript"
		th:src="@{/webtemplate/plugins/jquery-validation/additional-methods.min.js}"></script>

	<script>
		$(function() {
			let rawData = '[[${listObj}]]';
			rawData = rawData.replace(/&quot;/g, '"');
			let jsonData = [];
			try {
				jsonData = JSON.parse(rawData);
			} catch (e) {
				console.error("Invalid JSON data for UserWisePerformance:", e);
			}

			$("#userPerformanceTable")
					.DataTable({
						data : jsonData,
						columns : [ {
							title : "Sr No."
						}, {
							title : "User Name"
						}, {
							title : "Performance %"
						}, {
							title : "Action",
							render : function(data, type, row) {
								const username = row[1];
								return `<button class="btn btn-info action-btn" data-bs-toggle="modal" data-bs-target="#performanceModal" data-username="${username}">
                                <i class="fas fa-chart-line"></i> View Scenarios
                            </button>`;
							}
						} ],
						responsive : false,
						lengthChange : false,
						autoWidth : false,
						buttons : [ "csv", "excel", "print", "colvis" ]
					}).buttons().container().appendTo(
							'#userPerformanceTable_wrapper .col-md-6:eq(0)');

			// Handle modal show event
			$('#performanceModal').on(
					'show.bs.modal',
					function(event) {
						const button = $(event.relatedTarget);
						const username = button.data('username');
						const modal = $(this);
						const modalBody = modal.find('#modalBodyContent');
						modal.find('#modalUsername').text(username);

						// Clear previous content and show loading message
						modalBody.html('<p>Loading performance data...</p>');

						// Fetch user's scenarios and calculate percentage
						alert()
						$.ajax({
							url : '/getScenarioByUsername', // You need to create this endpoint
							type : 'GET',
							data : {
								username : username
							},
							success : function(scenarios) {
								if (scenarios && scenarios.length > 0) {
									let contentHtml = '';
									let scenarioPromises = scenarios
											.map(scenario => {
												return $.ajax({
													url : '/getPercentageParticularScenario',
													type : 'POST',
													data : {
														scenarioId : scenario.Id,
														scenarioName : scenario.ScenarioName
													}
												}).then(
														percentage => {
															const progessValue = parseInt(percentage) || 0;
															return `<div class="mb-3">
                                                                <h6>${scenario.ScenarioName}</h6>
                                                                <div class="progress progress-container">
                                                                    <div class="progress-bar" role="progressbar" style="width: ${progessValue}%" aria-valuenow="${progessValue}" aria-valuemin="0" aria-valuemax="100"></div>
                                                                </div>
                                                                <p class="mb-0 text-end">${progessValue}% Complete</p>
                                                            </div>`;
														});
											});

									Promise.all(scenarioPromises).then(
											htmlArray => {
												modalBody.html(htmlArray
														.join(''));
											}).catch(
											() => {
												modalBody
														.html(
																'<p class="text-danger">Failed to load all scenario percentages.</p>');
											});
								} else {
									modalBody
											.html(
													'<p>No scenarios found for this user.</p>');
								}
							},
							error : function() {
								modalBody
										.html(
												'<p class="text-danger">Failed to load scenario data.</p>');
							}
						});
					});
		});
	</script>
</body>
</html>
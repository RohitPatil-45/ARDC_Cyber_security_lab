<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>All Users Task Performance</title>
    <head th:include="templateListing :: headFragment"></head>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap4.min.css">
    <style>
        .progress { height: 8px; margin-bottom: 5px; }
        .progress-bar-task { background-color: #17a2b8; }
        .progress-bar-assessment { background-color: #28a745; }
        .percentage-badge { font-size: 0.75rem; font-weight: bold; min-width: 45px; text-align: center; }
        .badge-task { background-color: #17a2b8; color: white; }
        .badge-assessment { background-color: #28a745; color: white; }
        .progress-container { min-width: 120px; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background-color: #6c757d; color: white;
                       display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; }
        .no-scenario-cell { background-color: #f8f9fa; font-style: italic; color: #6c757d; }
        .department-badge { background-color: #6f42c1; color: white; }
        .course-badge { background-color: #e83e8c; color: white; }
        .semester-badge { background-color: #20c997; color: white; }
        .batch-badge { background-color: #fd7e14; color: white; }
        .info-badge { font-size: 0.7rem; padding: 3px 6px; margin: 1px; display: inline-block; }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <div th:replace="fragments/header_bk :: header"></div>
        <div th:replace="fragments/sidebar :: aside"></div>
        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Users Task Performance</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a >Home</a></li>
                                <li class="breadcrumb-item active">Users Task Performance</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-secondary">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3 class="card-title" style="padding-top: 10px">Users Performance Details</h3>
                                        </div>
                                        <div class="col-md-4 text-right">
                                            
                                        </div>
                                    </div>
                                    <!-- Error Message -->
                                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show text-center mt-3" role="alert">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <span th:text="${error}">Error message</span>
                                        <button type="button" class="close btn-sm" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div id="loadingMessage" class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">Loading data...</p>
                                    </div>

                                    <table id="allUsersPerformanceTable" class="table table-bordered table-striped" style="display: none;">
                                        <thead class="thead-light">
                                            <tr>
                                                <th width="4%">Sr No.</th>
                                                <th width="10%">Username</th>
                                                <th width="10%">Full Name</th>
                                                <th width="15%">Scenario Name</th>
                                                <th width="10%">Department</th>
                                                <th width="10%">Course</th>
                                                <th width="10%">Semester</th>
                                                <th width="8%">Batch</th>
                                                <th width="9%">Task Progress</th>
                                                <th width="9%">Assessment Progress</th>
                                                <th width="9%">Overall Progress</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- DataTables will populate -->
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>
        <div th:replace="fragments/footer :: footer"></div>
    </div>

    <div th:replace="templateListing :: jsscript"></div>

    <!-- DataTables Scripts -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

   <script th:inline="javascript">
    $(document).ready(function() {
        console.log("Document ready - initializing DataTable");
        
        // Get the raw data from Thymeleaf
        let rawData = /*[[${listObj}]]*/ '';
        console.log("Raw data received:", rawData);
        
        let jsonData = [];

        try {
            // Handle the Thymeleaf string format with double brackets
            if (typeof rawData === "string") {
                // Remove the double brackets if present
                let cleanedData = rawData.trim();
                if (cleanedData.startsWith('[[') && cleanedData.endsWith(']]')) {
                    cleanedData = cleanedData.substring(2, cleanedData.length - 2);
                }
                
                if (cleanedData.startsWith('[') && cleanedData.endsWith(']')) {
                    jsonData = JSON.parse(cleanedData);
                } else if (cleanedData) {
                    // Try to parse as is
                    jsonData = JSON.parse(cleanedData);
                }
            } else if (Array.isArray(rawData)) {
                jsonData = rawData;
            }
            
            console.log("Parsed JSON data:", jsonData);
            console.log("Number of records:", jsonData.length);
            
            if (jsonData.length > 0) {
                console.log("First record sample:", jsonData[0]);
                console.log("First record length:", jsonData[0].length);
            }
        } catch (e) {
            console.error("Error parsing JSON data:", e);
            // Try alternative parsing method
            try {
                // Direct evaluation (be careful with this approach)
                if (typeof rawData === "string" && rawData.includes('[')) {
                    jsonData = eval(rawData);
                    console.log("Data parsed using eval:", jsonData);
                }
            } catch (e2) {
                console.error("Alternative parsing also failed:", e2);
                jsonData = [];
            }
        }

        // Initialize DataTable
        if (jsonData && jsonData.length > 0) {
            console.log("Initializing DataTable with", jsonData.length, "records");
            
            var table = $('#allUsersPerformanceTable').DataTable({
                data: jsonData,
                responsive: true,
                lengthChange: true,
                autoWidth: false,
                pageLength: 25,
                initComplete: function(settings, json) {
                    console.log("DataTable initialization complete");
                    $('#loadingMessage').hide();
                    $('#allUsersPerformanceTable').show();
                },
                createdRow: function(row, data, dataIndex) {
                    console.log("Created row:", dataIndex, data);
                },
                buttons: [
                    {
                        extend: 'collection',
                        className: 'btn btn-secondary',
                        text: '<i class="fas fa-cog"></i> Options',
                        buttons: [
                            {
                                extend: 'copy',
                                className: 'btn btn-secondary',
                                text: '<i class="fas fa-copy"></i> Copy',
                                exportOptions: {
                                    columns: ':visible'
                                },
                                title: 'All Users Task Performance Report'
                            },
                            {
                                extend: 'excel',
                                className: 'btn btn-success',
                                text: '<i class="fas fa-file-excel"></i> Excel',
                                exportOptions: {
                                    columns: ':visible'
                                },
                                title: 'All Users Task Performance Report',
                                filename: 'all_users_performance_' + new Date().toISOString().slice(0,10)
                            },
                            {
                                extend: 'pdf',
                                className: 'btn btn-danger',
                                text: '<i class="fas fa-file-pdf"></i> PDF',
                                exportOptions: {
                                    columns: ':visible'
                                },
                                title: 'All Users Task Performance Report',
                                filename: 'all_users_performance_' + new Date().toISOString().slice(0,10),
                                orientation: 'landscape'
                            },
                            {
                                extend: 'print',
                                className: 'btn btn-info',
                                text: '<i class="fas fa-print"></i> Print',
                                exportOptions: {
                                    columns: ':visible'
                                },
                                title: 'All Users Task Performance Report - ' + new Date().toLocaleDateString()
                            },
                            {
                                text: '<i class="fas fa-search"></i> Toggle Search',
                                className: 'btn btn-warning',
                                action: function ( e, dt, node, config ) {
                                    // Search header functionality
                                    $('#searchHeader').toggle();
                                    table.columns.adjust();
                                }
                            },
                            {
                                extend: 'colvis',
                                className: 'btn btn-primary',
                                text: '<i class="fas fa-columns"></i> Show/Hide Columns'
                            }
                        ]
                    }
                ],
                columns: [
                    { 
                        data: 0, 
                        title: "Sr No.",
                        className: "text-center"
                    },
                    { 
                        data: 1, 
                        title: "Username",
                        render: function(data, type, row) {
                            if (!data) return '<span class="text-muted">N/A</span>';
                            return '<div class="d-flex align-items-center">' +
                                   '<div class="user-avatar">' +
                                   data.charAt(0).toUpperCase() +
                                   '</div>' +
                                   '<div><strong>' + data + '</strong></div>' +
                                   '</div>';
                        }
                    },
                    { 
                        data: 2, 
                        title: "Full Name",
                        render: function(data, type, row) {
                            return data || '<span class="text-muted">N/A</span>';
                        }
                    },
                    { 
                        data: 3, 
                        title: "Scenario Name",
                        render: function(data, type, row) {
                            if (!data || data === "No Scenarios Assigned") {
                                return '<span class="text-muted"><i class="fas fa-exclamation-circle mr-1"></i>No Scenarios Assigned</span>';
                            }
                            return '<strong>' + data + '</strong>';
                        }
                    },
                    { 
                        data: 4, 
                        title: "Department",
                        render: function(data, type, row) {
                            if (!data || data === "Not Assigned") {
                                return '<span class="text-muted"><i class="fas fa-building mr-1"></i>Not Assigned</span>';
                            }
                            return '<span class="badge department-badge info-badge"><i class="fas fa-building mr-1"></i>' + data + '</span>';
                        }
                    },
                    { 
                        data: 5, 
                        title: "Course",
                        render: function(data, type, row) {
                            if (!data || data === "Not Assigned") {
                                return '<span class="text-muted"><i class="fas fa-graduation-cap mr-1"></i>Not Assigned</span>';
                            }
                            return '<span class="badge course-badge info-badge"><i class="fas fa-graduation-cap mr-1"></i>' + data + '</span>';
                        }
                    },
                    { 
                        data: 6, 
                        title: "Semester",
                        render: function(data, type, row) {
                            if (!data || data === "Not Assigned") {
                                return '<span class="text-muted"><i class="fas fa-calendar-alt mr-1"></i>Not Assigned</span>';
                            }
                            return '<span class="badge semester-badge info-badge"><i class="fas fa-calendar-alt mr-1"></i>' + data + '</span>';
                        }
                    },
                    { 
                        data: 7, 
                        title: "Batch",
                        render: function(data, type, row) {
                            if (!data || data === "Not Assigned") {
                                return '<span class="text-muted"><i class="fas fa-users mr-1"></i>Not Assigned</span>';
                            }
                            return '<span class="badge batch-badge info-badge"><i class="fas fa-users mr-1"></i>' + data + '</span>';
                        }
                    },
                    { 
                        data: 8, 
                        title: "Task Progress",
                        render: function(data, type, row) {
                            var progress = parseInt(data) || 0;
                            var progressBar = '<div class="progress-container">' +
                                '<div class="d-flex align-items-center">' +
                                '<div class="flex-grow-1 mr-2">' +
                                '<div class="progress">' +
                                '<div class="progress-bar progress-bar-task" role="progressbar" ' +
                                'style="width: ' + progress + '%;" ' +
                                'aria-valuenow="' + progress + '" aria-valuemin="0" aria-valuemax="100">' +
                                '</div></div></div>' +
                                '<span class="percentage-badge badge-task">' + progress + '%</span>' +
                                '</div></div>';
                            return progressBar;
                        }
                    },
                    { 
                        data: 9, 
                        title: "Assessment Progress",
                        render: function(data, type, row) {
                            var progress = parseInt(data) || 0;
                            var progressBar = '<div class="progress-container">' +
                                '<div class="d-flex align-items-center">' +
                                '<div class="flex-grow-1 mr-2">' +
                                '<div class="progress">' +
                                '<div class="progress-bar progress-bar-assessment" role="progressbar" ' +
                                'style="width: ' + progress + '%;" ' +
                                'aria-valuenow="' + progress + '" aria-valuemin="0" aria-valuemax="100">' +
                                '</div></div></div>' +
                                '<span class="percentage-badge badge-assessment">' + progress + '%</span>' +
                                '</div></div>';
                            return progressBar;
                        }
                    },
                    { 
                        data: 10, 
                        title: "Overall Progress",
                        className: "text-center",
                        render: function(data, type, row) {
                            var progress = parseInt(data) || 0;
                            var colorClass = progress >= 50 ? 'text-success' : progress >= 25 ? 'text-warning' : 'text-danger';
                            var icon = progress >= 50 ? 'fa-check-circle' : progress >= 25 ? 'fa-exclamation-circle' : 'fa-times-circle';
                            return '<div class="text-center">' +
                                   '<div class="h5 mb-1 ' + colorClass + '">' +
                                   '<i class="fas ' + icon + ' mr-1"></i>' + progress + '%</div>' +
                                   '<small class="text-muted">Average</small>' +
                                   '</div>';
                        }
                    }
                ],
                language: {
                    search: " Search:",
                    lengthMenu: "Show _MENU_ entries",
                    emptyTable: "No performance data available.",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    infoFiltered: "(filtered from _MAX_ total entries)"
                }
            });

            console.log("DataTable initialized successfully");

        } else {
            console.warn("No data available to display");
            $('#loadingMessage').html('<div class="alert alert-warning text-center">No data available to display.</div>');
            $('#allUsersPerformanceTable').hide();
        }

        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    });
</script>

</body>
</html>

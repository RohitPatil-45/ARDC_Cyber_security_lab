<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
<title>View RDP Connections | CMP</title>
<link rel="icon" type="image/png" href="/webtemplate/dist/img/magicboxEye3.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bootstrap & Font Awesome -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Your existing CSS styles remain unchanged */
body {
	overflow: hidden;
	background-color: #0f172a;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.continue-button {
	background-color: #007bff;
	color: white;
	border: none;
	border-radius: 25px;
	padding: 10px 20px;
	font-size: 16px;
	cursor: pointer;
	text-align: center;
	display: inline-block;
	transition: background-color 0.3s;
	margin-top: 10px;
}

.continue-button:hover {
	background-color: #0056b3;
}

.messageoutgoing {
	background-color: #2a2d3000;
	color: white;
	display: flex;
	justify-content: flex-end;
	padding: 10px;
}

/* Added for tab switching functionality */
.tab-pane {
	display: none;
}

.tab-pane.active {
	display: block;
}

/* Fix for instruction content alignment */
.instruction-content {
	color: #f8f9fa;
	line-height: 1.6;
}

/* Fix for details grid */
.details-grid {
	display: grid;
	grid-template-columns: 1fr 2fr;
	gap: 10px;
	padding: 15px;
	color: #f8f9fa;
}

.detail-label {
	font-weight: bold;
	color: #adb5bd;
}

/* Chat container improvements */
.chat-container {
	display: flex;
	flex-direction: column;
	height: 100%;
}

#chat-messages {
	flex-grow: 1;
	overflow-y: auto;
	padding: 10px;
}

/* Message styling */
.message {
	margin-bottom: 15px;
	padding: 10px;
	border-radius: 8px;
	max-width: 80%;
}

.message.incoming {
	background-color: #2d3748;
	align-self: flex-start;
}

.message.outgoing {
	background-color: #2a4d8e;
	align-self: flex-end;
	margin-left: auto;
}


.message-time {
	font-size: 0.75rem;
	color: #a0aec0;
	text-align: right;
}

.message-sender {
	font-weight: bold;
	margin-bottom: 5px;
	color: #63b3ed;
}

.status-indicator {
	display: inline-block;
	width: 10px;
	height: 10px;
	border-radius: 50%;
	background-color: #28a745;
	margin-right: 5px;
}

.detail-row {
	display: flex;
	margin-bottom: 12px; /* adds space between rows */
}

.detail-label {
	font-weight: bold;
	margin-right: 6px;
	min-width: 100px;
}
</style>

<style>
/* Add these styles to your existing CSS */

/* Chat container improvements */
.chat-container {
	display: flex;
	flex-direction: column;
	height: 100%;
	padding: 10px;
}

#chat-messages {
	flex-grow: 1;
	overflow-y: auto;
	padding: 10px;
	display: flex;
	flex-direction: column;
	gap: 15px;
}

/* Enhanced message styling */
.message {
	margin-bottom: 5px;
	padding: 12px 15px;
	border-radius: 12px;
	max-width: 90%;
	word-wrap: break-word;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.message.incoming {
	background-color: #2d3748;
	align-self: flex-start;
	border-bottom-left-radius: 5px;
}

.message.outgoing {
	background-color: #2a4d8e;
	align-self: flex-end;
	margin-left: auto;
	border-bottom-right-radius: 5px;
}

.message-content {
	margin-bottom: 5px;
	line-height: 1.5;
	font-size: 17px;
}

.message-content img {
	max-width: 100%;
	height: auto;
	border-radius: 8px;
	margin-top: 8px;
	transition: transform 0.3s ease, box-shadow 0.3s ease;
	cursor: pointer;
}

.message-content img:hover {
	transform: scale(1.5);
	box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
	z-index: 1000;
	position: relative;
}

.message-time {
	font-size: 0.7rem;
	color: #a0aec0;
	text-align: right;
	margin-top: 5px;
}

.message-sender {
	font-weight: bold;
	margin-bottom: 5px;
	color: #63b3ed;
	font-size: 0.85rem;
}

/* Continue button styling */
.continue-container {
	padding: 15px 10px;
	background-color: #1a202c;
	border-top: 1px solid #2d3748;
	margin-top: auto;
}

.continue-button {
	background-color: #007bff;
	color: white;
	border: none;
	border-radius: 20px;
	padding: 10px 20px;
	font-size: 14px;
	cursor: pointer;
	display: block;
	width: 100%;
	transition: background-color 0.3s;
}

.continue-button:hover {
	background-color: #0056b3;
}

.continue-button:disabled {
	background-color: #4a5568;
	cursor: not-allowed;
}

/* Custom scrollbar for chat */
#chat-messages::-webkit-scrollbar {
	width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
	background: #1a202c;
	border-radius: 10px;
}

#chat-messages::-webkit-scrollbar-thumb {
	background: #4a5568;
	border-radius: 10px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
	background: #718096;
}

/* New styles for collapsible sidebar */
.connection-container {
	display: flex;
	flex-direction: column;
	height: 100vh;
	position: relative;
}

.main-content {
	display: flex;
	flex: 1;
	overflow: hidden;
}

.rdp-frame-container {
	flex: 1;
	position: relative;
	transition: all 0.3s ease;
}

.rdp-frame-container.expanded {
	margin-right: 0;
}

.sidebar {
	width: 400px;
	background-color: #1a202c;
	border-left: 1px solid #2d3748;
	display: flex;
	flex-direction: column;
	transition: transform 0.3s ease;
	z-index: 100;
}

.sidebar.collapsed {
	transform: translateX(100%);
}

.sidebar-toggler {
	position: absolute;
	top: 50%;
	right: 400px;
	transform: translateY(-50%);
	background-color: #2d3748;
	color: white;
	border: none;
	border-radius: 5px 0 0 5px;
	padding: 10px 5px;
	cursor: pointer;
	z-index: 101;
	transition: right 0.3s ease;
}

.sidebar.collapsed ~ .sidebar-toggler {
	right: 0;
}

.sidebar-tabs {
	display: flex;
	border-bottom: 1px solid #2d3748;
}

.sidebar-tab {
	flex: 1;
	background: none;
	border: none;
	color: #a0aec0;
	padding: 12px;
	cursor: pointer;
	transition: background-color 0.3s, color 0.3s;
}

.sidebar-tab:hover {
	background-color: #2d3748;
	color: white;
}

.sidebar-tab.active {
	background-color: #2d3748;
	color: white;
	border-bottom: 2px solid #007bff;
}

/* Enhanced Chat Tab Styling */
.sidebar-tab[data-tab="chat"] {
	position: relative;
}

.sidebar-tab[data-tab="chat"].has-new-messages::after {
	content: "";
	position: absolute;
	top: 8px;
	right: 8px;
	width: 8px;
	height: 8px;
	background-color: #ff4757;
	border-radius: 50%;
}

.sidebar-tab[data-tab="chat"].active.has-new-messages::after {
	display: none;
}

.tab-content {
	flex: 1;
	overflow: hidden;
	display: flex;
	flex-direction: column;
}

.tab-pane {
	display: none;
	flex-direction: column;
	height: 100%;
	overflow: hidden;
}

.tab-pane.active {
	display: flex;
}

.instructions-container, .chat-container, .details-container {
	flex: 1;
	overflow: auto;
	padding: 15px;
}

.instruction-toggle {
	display: flex;
	align-items: center;
	justify-content: space-between;
	margin-bottom: 15px;
	padding-bottom: 10px;
	border-bottom: 1px solid #2d3748;
}

.toggle-btn {
	background-color: #2d3748;
	color: #a0aec0;
	border: none;
	padding: 5px 10px;
	border-radius: 4px;
	cursor: pointer;
	font-size: 12px;
}

.toggle-btn.active {
	background-color: #007bff;
	color: white;
}

.instruction-content img {
	max-width: 100%;
	height: auto;
	border-radius: 8px;
	margin: 10px 0;
}

.instruction-text {
	margin-bottom: 15px;
	line-height: 1.6;
}

.image-container {
	text-align: center;
	margin: 10px 0;
	background-color: #2d3748;
	padding: 10px;
	border-radius: 8px;
}

.image-caption {
	font-size: 12px;
	color: #a0aec0;
	margin-top: 5px;
}

/* Enhanced Chat Styles */
.chat-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 10px 15px;
	background-color: #2d3748;
	border-radius: 8px 8px 0 0;
	margin-bottom: 10px;
}

.chat-title {
	font-weight: bold;
	color: #63b3ed;
	font-size: 16px;
}

.chat-status {
	display: flex;
	align-items: center;
	font-size: 12px;
	color: #a0aec0;
}

.chat-status-indicator {
	width: 8px;
	height: 8px;
	border-radius: 50%;
	background-color: #48bb78;
	margin-right: 5px;
}

.system-message {
	background-color: rgba(255, 215, 0, 0.1);
	border-left: 3px solid #ffd700;
	padding: 10px;
	margin: 10px 0;
	border-radius: 4px;
	font-size: 13px;
	color: #ffd700;
}

.user-typing {
	font-style: italic;
	color: #a0aec0;
	font-size: 12px;
	padding: 5px 15px;
	height: 20px;
}

.message-highlight {
	animation: messagePulse 2s ease;
}

@keyframes messagePulse {
	0% { background-color: rgba(59, 130, 246, 0.3); }
	100% { background-color: #2d3748; }
}

.command-message {
	border-left: 3px solid #48bb78;
}

.important-message {
	border: 1px solid #f56565;
}

/* Notification badge */
.notification-badge {
	position: absolute;
	top: -5px;
	right: -5px;
	background-color: #ff4757;
	color: white;
	border-radius: 50%;
	width: 18px;
	height: 18px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 11px;
	font-weight: bold;
}

/* Chat input area (if needed in future) */
.chat-input-area {
	display: flex;
	padding: 10px;
	border-top: 1px solid #2d3748;
	background-color: #1a202c;
}

.chat-input {
	flex: 1;
	background-color: #2d3748;
	border: none;
	border-radius: 20px;
	padding: 10px 15px;
	color: white;
}

.chat-send-btn {
	background-color: #007bff;
	color: white;
	border: none;
	border-radius: 20px;
	padding: 10px 15px;
	margin-left: 10px;
	cursor: pointer;
}

/* Modal for enlarged images */
.image-modal {
	display: none;
	position: fixed;
	z-index: 2000;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: rgba(0, 0, 0, 0.9);
	overflow: auto;
}

.modal-content {
	display: block;
	margin: auto;
	max-width: 90%;
	max-height: 80%;
	position: absolute;
	top: 50%;
	left: 50%;
	transform: translate(-50%, -50%);
}

.close-modal {
	position: absolute;
	top: 15px;
	right: 35px;
	color: #f1f1f1;
	font-size: 40px;
	font-weight: bold;
	cursor: pointer;
}

.close-modal:hover,
.close-modal:focus {
	color: #bbb;
	text-decoration: none;
	cursor: pointer;
}

/* Image caption in modal */
.modal-caption {
	position: absolute;
	bottom: 20px;
	left: 0;
	width: 100%;
	text-align: center;
	color: white;
	padding: 10px;
	background-color: rgba(0, 0, 0, 0.7);
}

/* New styles for copy functionality */
/* Simplified copy button styles */
.command-container {
    position: relative;
    margin: 10px 0;
    padding: 12px;
    background-color: #2d3748;
    border-radius: 8px;
    border-left: 3px solid #48bb78;
}

.command-text {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #f8f9fa;
    margin-right: 30px; /* Space for the copy button */
    word-break: break-all;
}

.copy-button {
    position: absolute;
    top: 8px;
    right: 8px;
    background-color: transparent;
    color: #a0aec0;
    border: none;
    border-radius: 4px;
    padding: 5px;
    font-size: 12px;
    cursor: pointer;
    transition: color 0.3s;
}

.copy-button:hover {
    color: #007bff;
}

.copy-button.copied {
    color: #28a745;
}
/* Focus management for RDP frame */
.rdp-frame:focus {
	outline: 2px solid #007bff;
	outline-offset: -2px;
}
</style>

<link rel="stylesheet" th:href="@{/webtemplate/css/style_connetion.css}">
</head>

<body>
	<!-- Image Modal -->
	<div id="imageModal" class="image-modal">
		<span class="close-modal">&times;</span>
		<img class="modal-content" id="modalImage">
		<div id="modalCaption" class="modal-caption"></div>
	</div>

	<div class="connection-container">
		<!-- Top controls bar -->
		<div class="top-controls">
			<div class="brand">
				<i class="fas fa-desktop"></i> MAGICBOX CyberSecurity Lab
			</div>

			<div class="connection-info">
				<div class="status-indicator"></div>
				<span>Connected to <span th:text="${connectionName}">Windows
						Server</span></span> <span class="text-muted">|</span> <span><i
					class="fas fa-clock"></i> <span id="session-timer">00:00:00</span></span>
			</div>

			<div class="control-buttons">
				<button class="btn-control" id="toggle-sidebar">
					<i class="fas fa-times"></i> Close
				</button>
				<button class="btn-control" id="fullscreen-btn">
					<i class="fas fa-expand"></i> Fullscreen
				</button>
				<button class="btn-control" onclick="window.history.back();">
					<i class="fas fa-times"></i> Disconnect
				</button>
			</div>
		</div>

		<!-- Main content area -->
		<div class="main-content">
			<!-- RDP Frame -->
			<div class="rdp-frame-container" id="rdp-container">
				<div class="connection-loading" id="loading-indicator">
					<div class="spinner"></div>
					<p>Establishing secure connection...</p>
				</div>
				<iframe th:src="${embedUrl}" class="rdp-frame" id="rdp-frame"></iframe>
			</div>

			<!-- Sidebar with instructions and chat -->
			<div class="sidebar" id="instruction-sidebar">
				<div class="sidebar-tabs">
					<button class="sidebar-tab active" data-tab="instructions">
						<i class="fas fa-book"></i> Instructions
					</button>

					<button class="sidebar-tab" data-tab="chat" id="chat-tab-button">
						<i class="fas fa-comments"></i> Chat Support
						<span class="notification-badge" id="chat-notification" style="display: none;">3</span>
					</button>

					<button class="sidebar-tab" data-tab="details">
						<i class="fas fa-info-circle"></i> Details
					</button>
				</div>

				<div class="tab-content">
					<!-- Instructions Tab -->
					<div class="tab-pane active" id="instructions-tab">
						<div class="instructions-container">
							<div class="instruction-toggle">
								<h5>Lab Instructions</h5>
								<div>
									<button class="toggle-btn active" id="show-text-btn">Text</button>
									<button class="toggle-btn active" id="show-images-btn">Images</button>
								</div>
							</div>
							<div class="instruction-content">
								<div id="Lab_Instructions">
									<!-- Instructions will be dynamically loaded here -->
								</div>
							</div>
						</div>
					</div>

					<!-- Chat Tab -->
					<div class="tab-pane" id="chat-tab">
						<div class="chat-header">
							<div class="chat-title">Lab Assistant</div>
							<div class="chat-status">
								<div class="chat-status-indicator"></div>
								Online
							</div>
						</div>
						<div class="chat-container">
							<div id="chat-messages">
								<div class="system-message">
									<i class="fas fa-info-circle"></i> Your lab assistant is ready to help. Follow the instructions to complete the lab.
								</div>
								<!-- Messages will be dynamically appended here -->
							</div>
							
							<div class="user-typing" id="typing-indicator"></div>

							<!-- Continue button for each Command -->
							<div class="messageoutgoing">
								<button class="continue-button" id="continue-button"
									data-labid="" data-command="">Continue</button>
							</div>
						</div>
					</div>

					<!-- Details Tab -->
					<div class="tab-pane" id="details-tab">
						<div class="details-container">
							<h5 class="mb-3" style="color: aliceblue;">Connection Details</h5>
							<div class="details-grid">
								<div id="connection_details">
									<!-- Connection details will be dynamically loaded here -->
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Sidebar toggle button -->
			<button class="sidebar-toggler" id="sidebar-toggle" style="display: none">
				<i class="fas fa-chevron-left" id="sidebar-toggle-icon"></i>
			</button>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- SweetAlert2 -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
	// Function to extract ID from URL
	function getLabIdFromUrl() {
		const path = window.location.pathname;
		const parts = path.split('/');
		// The ID should be the last part of the URL
		return parts[parts.length - 1];
	}
	
	// Global variable to store current lab ID
	let currentLabId = getLabIdFromUrl();
	let newMessagesCount = 0;
	
	// Function to handle continue button click
	function handleContinueClick() {
		const labId = $('#continue-button').data('labid');
		const command = $('#continue-button').data('command');
		continueAction(labId, command);
	}
	
	// Function to show typing indicator
	function showTypingIndicator() {
		$('#typing-indicator').html('<i class="fas fa-circle-notch fa-spin"></i> Assistant is typing...');
		setTimeout(() => {
			$('#typing-indicator').html('');
		}, 2000);
	}
	
	// Function to highlight new messages
	function highlightNewMessage() {
		$('#chat-messages .message').last().addClass('message-highlight');
	}
	
	// Function to update notification badge
	function updateNotificationBadge() {
		const chatTab = $('#chat-tab-button');
		const notificationBadge = $('#chat-notification');
		
		if (!$('#chat-tab').hasClass('active')) {
			newMessagesCount++;
			notificationBadge.text(newMessagesCount).show();
			chatTab.addClass('has-new-messages');
		} else {
			newMessagesCount = 0;
			notificationBadge.hide();
			chatTab.removeClass('has-new-messages');
		}
	}
	
	// Function to set up image modal functionality
	function setupImageModal() {
		// Get the modal
		const modal = document.getElementById("imageModal");
		const modalImg = document.getElementById("modalImage");
		const captionText = document.getElementById("modalCaption");
		
		// Get all images in chat messages and add click event
		$('#chat-messages').on('click', '.message-content img', function() {
			modal.style.display = "block";
			modalImg.src = this.src;
			captionText.innerHTML = this.alt || "Instruction Image";
		});
		
		// Get the <span> element that closes the modal
		const span = document.getElementsByClassName("close-modal")[0];
		
		// When the user clicks on <span> (x), close the modal
		span.onclick = function() { 
			modal.style.display = "none";
		}
		
		// When the user clicks anywhere outside of the modal, close it
		modal.onclick = function(event) {
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}
	}
	
	// Function to copy command to clipboard
	function copyCommandToClipboard(commandText) {
		// Create a temporary textarea element
		const textArea = document.createElement("textarea");
		textArea.value = commandText;
		textArea.style.position = "fixed";
		textArea.style.opacity = 0;
		document.body.appendChild(textArea);
		textArea.focus();
		textArea.select();
		
		try {
			// Execute the copy command
			const successful = document.execCommand('copy');
			if (successful) {
				return true;
			} else {
				return false;
			}
		} catch (err) {
			console.error('Failed to copy text: ', err);
			return false;
		} finally {
			// Clean up
			document.body.removeChild(textArea);
		}
	}
	
	// Function to focus on RDP frame for pasting
function focusRDPFrame() {
	const iframe = document.getElementById("rdp-frame");
	if (iframe) {
		iframe.setAttribute("tabindex", "0"); // ensure it's focusable
		iframe.focus();
	}
}

	
	// Function to set up copy buttons for commands
// 	function setupCopyButtons() {
// 		// Set up event delegation for copy buttons
// 		$(document).on('click', '.copy-button', function() {
// 			const commandText = $(this).closest('.command-container').find('.command-text').text();
// 			const button = $(this);
			
// 			// Copy command to clipboard
// 			if (copyCommandToClipboard(commandText)) {
// 				// Show success feedback
// 				button.addClass('copied');
// 				button.html('<i class="fas fa-check"></i> Copied!');
				
// 				// Focus on RDP frame for pasting
// 				focusRDPFrame();
				
// 				// Reset button after 2 seconds
// 				setTimeout(function() {
// 					button.removeClass('copied');
// 					button.html('<i class="fas fa-copy"></i> Copy');
// 				}, 2000);
// 			} else {
// 				// Show error message
// 				Swal.fire({
// 					icon: 'error',
// 					title: 'Copy Failed',
// 					text: 'Failed to copy command to clipboard. Please try again.',
// 					timer: 2000,
// 					showConfirmButton: false
// 				});
// 			}
// 		});
// 	}
	
	
	function setupCopyButtons() {
	// Set up event delegation for dynamically loaded copy buttons
	$(document).on('click', '.copy-button', function () {
		const commandText = $(this).closest('.command-container').find('.command-text').text().trim();
		const button = $(this);

		// Try to copy command to clipboard
		navigator.clipboard.writeText(commandText)
			.then(() => {
				// Success feedback
				button.addClass('copied');
				button.html('<i class="fas fa-check"></i>');

				// Focus the RDP iframe
				focusRDPFrame();

				// Reset button after 2 seconds
				setTimeout(function () {
					button.removeClass('copied');
					button.html('<i class="fas fa-copy"></i>');
				}, 2000);
			})
			.catch(() => {
				// Error feedback
				Swal.fire({
					icon: 'error',
					title: 'Copy Failed',
					text: 'Failed to copy command to clipboard. Please try again.',
					timer: 2000,
					showConfirmButton: false
				});
			});
	});
}

	
	// Function to format command messages with copy functionality
// 	function formatCommandWithCopy(commandText) {
// 		return `
// 			<div class="command-container">
// 				<div class="command-text">${commandText}</div>
// 				<button class="copy-button">
// 					<i class="fas fa-copy"></i> Copy
// 				</button>
// 				<div class="copy-hint">Click to copy, then paste in VM with Ctrl+V</div>
// 			</div>
// 		`;
// 	}
	
	
	function formatCommandWithCopy(commandText) {
    return `
        <div class="command-container">
            <div class="command-text">${commandText}</div>
            <button class="copy-button">
                <i class="fas fa-copy"></i>
            </button>
        </div>
    `;
}
	
	$(document).ready(function() {
		// Toggle sidebar visibility
		$('#sidebar-toggle').click(function() {
			const sidebar = $('#instruction-sidebar');
			sidebar.toggleClass('collapsed');
			$('#rdp-container').toggleClass('expanded');
			
			// Update icon based on state
			const icon = $('#sidebar-toggle-icon');
			if (sidebar.hasClass('collapsed')) {
				icon.removeClass('fa-chevron-left').addClass('fa-chevron-right');
			} else {
				icon.removeClass('fa-chevron-right').addClass('fa-chevron-left');
			}
		});
		
		// Toggle text visibility
		$('#show-text-btn').click(function() {
			$(this).toggleClass('active');
			$('.instruction-text').toggle();
		});
		
		// Toggle image visibility
		$('#show-images-btn').click(function() {
			$(this).toggleClass('active');
			$('.image-container').toggle();
		});
		
		// Set up copy buttons functionality
		setupCopyButtons();
		
		// Load initial instructions on page load
		if (currentLabId) {
			ActionforLAbOnload(currentLabId);
			continueActionforLAbOnload(currentLabId);
			ConnectionDetails(currentLabId); // Call ConnectionDetails on page load
			 checkLabCompletionStatus(currentLabId); // Check if lab is already completed
		}
		
		// Set up event handler for continue button
		$('#continue-button').on('click', handleContinueClick);
		
		// Set up event handler for chat tab click
		$('#chat-tab-button').on('click', function() {
			if (currentLabId) {
				continueActionforLAbOnload(currentLabId);
			}
			// Reset notification when chat tab is opened
			newMessagesCount = 0;
			$('#chat-notification').hide();
			$(this).removeClass('has-new-messages');
		});
		
		// Toggle sidebar visibility (old button)
		$('#toggle-sidebar').click(function() {
			$('#instruction-sidebar').toggle();
			const isVisible = $('#instruction-sidebar').is(':visible');
			$(this).html(isVisible ? 
				 '<i class="fas fa-times"></i> Close' : '<i class="fas fa-comments"></i> Instructions');
		});
		
		// Fullscreen functionality
		$('#fullscreen-btn').click(function() {
			const elem = $('.connection-container')[0];
			
			if (!document.fullscreenElement) {
				if (elem.requestFullscreen) {
					elem.requestFullscreen();
				} else if (elem.webkitRequestFullscreen) {
					elem.webkitRequestFullscreen();
				} else if (elem.msRequestFullscreen) {
					elem.msRequestFullscreen();
				}
				$(this).html('<i class="fas fa-compress"></i> Exit Fullscreen');
			} else {
				if (document.exitFullscreen) {
					document.exitFullscreen();
				} else if (document.webkitExitFullscreen) {
					document.webkitExitFullscreen();
				} else if (document.msExitFullscreen) {
					document.msExitFullscreen();
				}
				$(this).html('<i class="fas fa-expand"></i> Fullscreen');
			}
		});
		
		// Session timer
		let startTime = Date.now();
		function updateTimer() {
			const elapsed = Date.now() - startTime;
			const seconds = Math.floor((elapsed / 1000) % 60);
			const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
			const hours = Math.floor(elapsed / (1000 * 60 * 60));
			
			const timeString = [
				hours.toString().padStart(2, '0'),
				minutes.toString().padStart(2, '0'),
				seconds.toString().padStart(2, '0')
			].join(':');
			
			$('#session-timer').text(timeString);
			$('#connection-duration').text(timeString);
		}
		setInterval(updateTimer, 1000);
		
		// Simulate connection loading
		$('#rdp-frame').on('load', function() {
			$('#loading-indicator').fadeOut();
		});
		
		// Simulate resource usage updates
		setInterval(() => {
			$('#cpu-usage').text(Math.floor(Math.random() * 30 + 5) + '%');
			$('#memory-usage').text(Math.floor(Math.random() * 30 + 50) + '%');
			$('#network-in').text((Math.random() * 5 + 1).toFixed(1) + ' Mbps');
			$('#network-out').text((Math.random() * 3 + 0.5).toFixed(1) + ' Mbps');
		}, 5000);
		
		// Tab switching functionality
		document.querySelectorAll('.sidebar-tab').forEach(button => {
			button.addEventListener('click', function() {
				const tab = this.getAttribute('data-tab');
				
				// Remove active class from all tabs
				document.querySelectorAll('.sidebar-tab').forEach(tab => {
					tab.classList.remove('active');
				});
				
				// Add active class to clicked tab
				this.classList.add('active');
				
				// Hide all tab content
				document.querySelectorAll('.tab-pane').forEach(pane => {
					pane.classList.remove('active');
				});
				
				// Show selected tab content
				const tabContent = document.getElementById(tab + '-tab');
				if (tabContent) {
					tabContent.classList.add('active');
				}
			});
		});
		
		// Set up image modal functionality
		setupImageModal();
	});
	
	function ActionforLAbOnload(id) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/ActionloadInitialInstruction",
	        data: { labId: id },
	        success: function(response) {
	            if (response.success) {
	                const instructions = response.instructions || [];

	                // Clear previous messages
	                $('#Lab_Instructions').empty();

	                instructions.forEach(instr => {
	                    const command = instr.command || '';
	                    const details = instr.instructionDetails || '';

	                    // Parse the instruction details to separate text and images
	                    const $content = $('<div>').html(details);
	                    const textContent = $content.text().trim();
	                    const images = $content.find('img');
	                    
	                    // Create instruction container
	                    const instructionHtml = $(`
	                        <div class="instruction-item">
	                            <div class="instruction-text">${textContent}</div>
	                            <div class="message-command"><strong>${command}</strong></div>
	                        </div>
	                    `);
	                    
	                    // Add images if any
	                    if (images.length > 0) {
	                        images.each(function() {
	                            const src = $(this).attr('src');
	                            const alt = $(this).attr('alt') || '';
	                            const imageContainer = $(`
	                                <div class="image-container">
	                                    <img src="${src}" alt="${alt}">
	                                    ${alt ? `<div class="image-caption">${alt}</div>` : ''}
	                                </div>
	                            `);
	                            instructionHtml.append(imageContainer);
	                        });
	                    }
	                    
	                    $('#Lab_Instructions').append(instructionHtml);
	                });

	            } else {
	                console.error('Failed to load instructions:', response.error);
	            }
	        },
	        error: function() {
	            Swal.fire({
	                icon: 'error',
	                title: 'Error',
	                text: 'An error occurred while fetching data.'
	            });
	        }
	    });
	}

	function continueActionforLAbOnload(id) {
		$.ajax({
			type: "POST",
			url: "/guac/chatloadInitialInstruction",
			data: { labId: id },
			success: function(response) {
				if (response.success) {
					const newInstruction = response.instructionText || '';
					const newCommand = response.command || '';
					const isLast = response.isLast || false;

					// Clear previous messages except system message
					$('#chat-messages').children().not('.system-message').remove();

						// Show typing indicator before adding new message
					showTypingIndicator();
					
					setTimeout(() => {
						// Add instruction (HTML including image)
						const instructionHtml = $(`
							<div class="message incoming">
								<div class="message-content">${newInstruction}</div>
							</div>
						`);
						$('#chat-messages').append(instructionHtml);

						// Add command with copy functionality
						if (newCommand.trim() !== '') {
							const commandHtml = formatCommandWithCopy(newCommand);
							$('#chat-messages').append(commandHtml);
						}

						// Update Continue button data attributes
						$('#continue-button')
							.data('labid', id)
							.data('command', newCommand);

						// Auto-scroll to bottom
						const chatMessages = $('#chat-messages');
						chatMessages.scrollTop(chatMessages.prop("scrollHeight"));
						
						// Highlight new message
						highlightNewMessage();
						
						// Update notification badge
						updateNotificationBadge();
						
						// Set up image modal for any new images
						setupImageModal();

						// Disable continue button if it's the last
						if (isLast) {
							onLastInstructionCompleted(id);
							$('#continue-button').prop('disabled', true).text("Completed");
						}
					}, 2000);

				} else {
					console.error('Failed to load instruction:', response.error);
				}
			},
			error: function() {
				Swal.fire({
					icon: 'error',
					title: 'Error',
					text: 'An error occurred while fetching data.'
				});
			}
		});
	}
	
	function continueAction(id, command) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/continueActionInstruction",
	        data: {
	            labId: id,
	            labcommand: command
	        },
	        success: function(response) {
	            if (response.success) {
	                const newInstruction = response.instruction;
	                const newCommand = response.command;
	                const isLast = response.isLast || false;

	                // Update button data attributes
	                $('#continue-button')
	                    .data('labid', id)
	                    .data('command', newCommand);

	                // Show typing indicator
	                showTypingIndicator();
	                
	                setTimeout(() => {
		                // Instruction HTML
		                const instructionHtml = $(`
		                    <div class="message incoming">
		                        <div class="message-content">${newInstruction}</div>
		                    </div>
		                `);

		                // Command with copy functionality
		                const commandHtml = formatCommandWithCopy(newCommand);

		                // Append to chat window
		                $('#chat-messages').append(instructionHtml).append(commandHtml);

		                // Auto scroll to bottom
		                const chatMessages = $('#chat-messages');
		                chatMessages.scrollTop(chatMessages[0].scrollHeight);
		                
		                // Highlight new message
		                highlightNewMessage();
		                
		                // Update notification badge
		                updateNotificationBadge();
		                
		                // Set up image modal for any new images
		                setupImageModal();

		                // Call function if it's the last step
		                if (isLast) {
		                    onLastInstructionCompleted(id);
		                    $('#continue-button').prop('disabled', true).text("Completed");
		                }
	                }, 2000);
	            } else {
	                Swal.fire({
	                    icon: 'error',
	                    title: 'Failed',
	                    text: response.error || 'Failed to load instruction.'
	                });
	            }
	        },
	        error: function() {
	            Swal.fire({
	                icon: 'error',
	                title: 'Error',
	                text: 'An error occurred while fetching data.'
	            });
	        }
	    });
	}

	function onLastInstructionCompleted(labId) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/InstructionCompleted",
	        data: { LabId: labId }, 
	        success: function(response) {
	        	if (response==="success") {
	        	    // Add completion message to chat
	        	    const completionMessage = $(`
	        	        <div class="message incoming important-message">
	        	            <div class="message-content">
	        	                <i class="fas fa-check-circle"></i> Congratulations! You've completed all lab instructions.
	        	            </div>
	        	        </div>
	        	    `);
	        	    $('#chat-messages').append(completionMessage);
	        	    
	        	    // Auto scroll to bottom
	        	    const chatMessages = $('#chat-messages');
	        	    chatMessages.scrollTop(chatMessages[0].scrollHeight);
	        	    
	        	    Swal.fire({
	        	        icon: 'success',
	        	        title: 'Completed',
	        	        text: 'Lab instruction marked as completed for Lab ID: ' + labId
	        	    });
	        	} else {
	        	    Swal.fire({
	        	        icon: 'error',
	        	        title: 'Failed',
	        	        text: response.error || 'Could not mark instruction completed.'
	        	    });
	        	}
	        },
	        error: function(xhr, status, error) {
	            console.error("AJAX error:", status, error);
	        }
	    });
	}

	function ConnectionDetails(id) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/getConnectionDeatils",
	        data: { LabId: id },
	        success: function(response) {
	            if (response.success) {
	                $('#connection_details').empty();

	                const detailsHtml = `
	                    <div class="detail-row">
	                        <span class="detail-label">Username:</span>
	                        <span class="detail-value">${response.username || '-'}</span>
	                    </div>
	                    <div class="detail-row">
                        <span class="detail-label">Password:</span>
                        <span class="detail-value">${response.password || '-'}</span>
                    </div>
	                    <div class="detail-row">
	                        <span class="detail-label">Lab Name:</span>
	                        <span class="detail-value">${response.labName || '-'}</span>
	                    </div>
	                    <div class="detail-row">
	                        <span class="detail-label">IP Address:</span>
	                        <span class="detail-value">${response.ipAddress || '-'}</span>
	                    </div>
	                `;
	                $('#connection_details').html(detailsHtml);
	            } else {
	                console.error('Failed to load connection details:', response.error);
	                $('#connection_details').html('<div class="text-muted">Error loading connection details</div>');
	            }
	        },
	        error: function() {
	            Swal.fire({
	                icon: 'error',
	                title: 'Error',
	                text: 'An error occurred while fetching connection details.'
	            });
	            $('#connection_details').html('<div class="text-muted">Error loading connection details</div>');
	        }
	    });
	}
	
	function checkLabCompletionStatus(labId) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/checkLabCompletion",
	        data: { labId: labId },
	        success: function(response) {
	            if (response==="success") {
	                // If lab is already completed, disable the button
	                $('#continue-button')
	                    .prop('disabled', true)
	                    .text("Completed");
	                
	                // Load completed commands history
	                loadCompletedCommandsHistory(labId);
	            }
	        },
	        error: function() {
	            console.error('Failed to check lab completion status');
	            
	            // Fallback to localStorage check
	            if (localStorage.getItem(`labCompleted_${labId}`) === 'true') {
	                $('#continue-button')
	                    .prop('disabled', true)
	                    .text("Completed");
	                
	                // Try to load completed commands
	                loadCompletedCommandsHistory(labId);
	            }
	        }
	    });
	}
	
	function loadCompletedCommandsHistory(labId) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/getCompletedCommands",  
	        data: { labId: labId },
	        success: function(response) {
	            if (response && response.completedCommands && response.completedCommands.length > 0) {
	                $('#chat-messages').empty();
	                
	                // Add system message
	                $('#chat-messages').append(`
	                    <div class="system-message">
	                        <i class="fas fa-info-circle"></i> This lab has been completed. Here's the command history:
	                    </div>
	                `);

	                response.completedCommands.forEach(cmd => {
	                    // Add instruction
	                    const instructionHtml = $(`
	                        <div class="message incoming">
	                            <div class="message-content">${cmd.instruction || ''}</div>
	                        </div>
	                    `);
	                    $('#chat-messages').append(instructionHtml);
	                    
	                    // Add command with copy functionality
	                    if (cmd.command && cmd.command.trim() !== '') {
	                        const commandHtml = formatCommandWithCopy(cmd.command);
	                        $('#chat-messages').append(commandHtml);
	                    }
	                });

	                const completionHtml = $(`
	                    <div class="message incoming important-message">
	                        <div class="message-content" style="color: #4ade80; font-weight: bold;">
	                            <i class="fas fa-check-circle"></i> All lab instructions completed!
	                        </div>
	                    </div>
	                `);
	                $('#chat-messages').append(completionHtml);

	                // Auto-scroll to bottom
	                const chatMessages = $('#chat-messages');
	                chatMessages.scrollTop(chatMessages.prop("scrollHeight"));
	                
	                // Set up image modal for any images in completed commands
	                setupImageModal();
	            } else {
	                $('#chat-messages').empty();
	                $('#chat-messages').append('<div>No completed commands found.</div>');
	            }
	        },
	        error: function() {
	            console.error('Failed to load completed commands history');

	            // Optional fallback to localStorage
	            const completedCommandsStr = localStorage.getItem(`completedCommands_${labId}`);
	            if (completedCommandsStr) {
	                try {
	                    const completedCommands = JSON.parse(completedCommandsStr);
	                    $('#chat-messages').empty();
	                    completedCommands.forEach(cmd => {
	                        // Add instruction
	                        const instructionHtml = $(`
	                            <div class="message incoming">
	                                <div class="message-content">${cmd.instruction || ''}</div>
	                            </div>
	                        `);
	                        $('#chat-messages').append(instructionHtml);
	                        
	                        // Add command with copy functionality
	                        if (cmd.command && cmd.command.trim() !== '') {
	                            const commandHtml = formatCommandWithCopy(cmd.command);
	                            $('#chat-messages').append(commandHtml);
	                        }
	                    });
	                    // Completion message
	                    $('#chat-messages').append(`
	                        <div class="message incoming important-message">
	                            <div class="message-content" style="color: #4ade80; font-weight: bold;">
	                                <i class="fas fa-check-circle"></i> All lab instructions completed!
	                            </div>
	                        </div>
	                    `);

	                    const chatMessages = $('#chat-messages');
	                    chatMessages.scrollTop(chatMessages.prop("scrollHeight"));
	                    
	                    // Set up image modal for any images in completed commands
	                    setupImageModal();
	                } catch (e) {
	                    console.error('Error parsing completed commands from localStorage', e);
	                }
	            }
	        }
	    });
	}

	const iframe = document.getElementById("rdp-frame");

	// Always return focus to iframe after any outside click
	window.addEventListener("click", () => {
	    setTimeout(() => {
	      iframe.focus();
	    }, 50); // small delay so click event finishes first
	});

	// Ensure iframe can actually be focused
	iframe.setAttribute("tabindex", "0");	
	</script>
</body>
</html>
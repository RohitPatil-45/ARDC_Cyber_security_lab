<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
<title>View RDP Connections |CMP</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bootstrap & Font Awesome -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body {
	overflow: hidden;
	background-color: #0f172a;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.continue-button {
	background-color: #007bff; /* Blue background */
	color: white; /* White text */
	border: none; /* Remove border */
	border-radius: 25px; /* Rounded corners */
	padding: 10px 20px; /* Padding inside the button */
	font-size: 16px; /* Text size */
	cursor: pointer; /* Pointer cursor on hover */
	text-align: center; /* Center the text inside the button */
	display: inline-block; /* Make it inline element */
	transition: background-color 0.3s;
	/* Smooth transition for hover effect */
}

.continue-button:hover {
	background-color: #0056b3; /* Darker blue on hover */
}

.messageoutgoing {
	background-color: #2a2d3000;
	color: white;
	align-self: flex-end;
	margin-left: 10rem;
	align-self: flex-end;
}

/* Added for tab switching functionality */
.tab-pane {
	display: none;
}

.tab-pane.active {
	display: block;
}
</style>

<link rel="stylesheet" th:href="@{/webtemplate/css/style_connetion.css}">
</head>

<body>
	<div class="connection-container">
		<!-- Top controls bar -->
		<div class="top-controls">
			<div class="brand">
				<i class="fas fa-desktop"></i> Canaris Setup Lab
			</div>

			<div class="connection-info">
				<div class="status-indicator"></div>
				<span>Connected to <span th:text="${connectionName}">Windows
						Server</span></span> <span class="text-muted">|</span> <span><i
					class="fas fa-clock"></i> <span id="session-timer">00:00:00</span></span>
			</div>

			<div class="control-buttons">
				<button class="btn-control" id="toggle-sidebar">
					<i class="fas fa-comments"></i> Instructions
				</button>
				<button class="btn-control" id="fullscreen-btn">
					<i class="fas fa-expand"></i> Fullscreen
				</button>
				<button class="btn-control" onclick="window.history.back();">
					<i class="fas fa-times"></i> Disconnect
				</button>

			</div>
		</div>

		<!-- Main content area -->
		<div class="main-content">
			<!-- RDP Frame -->
			<div class="rdp-frame-container">
				<div class="connection-loading" id="loading-indicator">
					<div class="spinner"></div>
					<p>Establishing secure connection...</p>
				</div>
				<iframe th:src="${embedUrl}" class="rdp-frame" id="rdp-frame"></iframe>
			</div>

			<!-- Sidebar with instructions and chat -->
			<div class="sidebar" id="instruction-sidebar">
				<div class="sidebar-tabs" th:each="instance : ${instructionsdata}">
					<button class="sidebar-tab active" data-tab="instructions">
						<i class="fas fa-book"></i> Instructions
					</button>

					<button class="sidebar-tab" data-tab="chat"
						th:attr="data-id=${instance.guacamoleId}">
						<i class="fas fa-comments"></i> Chat Support
					</button>

					<button class="sidebar-tab" data-tab="details">
						<i class="fas fa-info-circle"></i> Details
					</button>

				</div>

				<div class="tab-content">
					<!-- Instructions Tab -->
					<div class="tab-pane active" id="instructions-tab">
						<div class="instructions-container">
							<h5 class="mb-3">Lab Instructions</h5>

							<div class="instruction-content">
								<div th:each="instance : ${instructionsdata}">
									<div th:text="${instance.vm_instructions}"></div>
								</div>
							</div>
						</div>
					</div>



					<div class="tab-pane" id="chat-tab">
						<div class="chat-container">
							<div id="chat-messages">
								<!-- ðŸ”§ This was missing -->
								<!-- Messages will be dynamically appended here -->
							</div>

							<!-- Continue button for each Command -->
							<div class="messageoutgoing">
								<!-- 								<button class="continue-button" -->
								<!-- 									onclick="continueAction(labid,command)">Continue</button> -->
								<button class="continue-button" data-labid="" data-command=""
									onclick="handleContinueClick(this)">Continue</button>


							</div>
						</div>
					</div>


					<!-- Details Tab -->
					<div class="tab-pane" id="details-tab">
						<h5 class="mb-3">Connection Details</h5>
						<div class="details-grid">
							<div th:each="instance : ${instructionsdata}">
								<div class="detail-label">Name:</div>
								<div th:text="${instance.instance_name}">Windows Server
									2022</div>

								<div class="detail-label">Protocol:</div>
								<div>RDP</div>

								<div class="detail-label">Status:</div>
								<div>
									<span class="status-indicator"></span> Connected
								</div>

								<div class="detail-label">Duration:</div>
								<div id="connection-duration">00:00:00</div>

								<div class="detail-label">Address:</div>
								<div th:text="${serverAddress}">192.168.1.105</div>

								<div class="detail-label">Username:</div>
								<div th:text="${username}">Administrator</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- SweetAlert2 -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
       
   document.querySelectorAll('.sidebar-tab').forEach(button => {
    button.addEventListener('click', function () {
        const tab = this.getAttribute('data-tab');

        // Activate the correct tab visually and functionally
        switchTab(tab);

        // If it's the chat tab, also handle guacamoleId
        if (tab === 'chat') {
            const guacamoleId = this.getAttribute('data-id');
            if (guacamoleId) {
                // Optional: use guacamoleId for something
//                 alert('Chat tab selected with ID: ' + guacamoleId);
                continueActionforLAbOnload(guacamoleId)
//                 continueAction(guacamoleId);
            }
        }
    });
});
   

function continueActionforLAbOnload(id) {
    $.ajax({
        type: "POST",
        url: "/guac/loadInitialInstruction",
        data: { labId: id },
        success: function (response) {
            if (response.success) {
                const newInstruction = response.instruction;
                const newCommand = response.command;
                const isLast = response.isLast || false;

                const instructionHtml = `
                    <div class="message incoming">
                        <div class="message-content">${newInstruction}</div>
                    </div>
                `;

                const commandHtml = `
                    <div class="message incoming">
                        <div class="message-content">${newCommand}</div>
                    </div>
                `;

                $('#chat-messages').append(instructionHtml).append(commandHtml);

                // âœ… Update the Continue button with latest data
                $('.continue-button')
                    .attr('data-labid', id)
                    .attr('data-command', newCommand);

                // Auto-scroll
                const chatMessages = $('#chat-messages');
                chatMessages.scrollTop(chatMessages[0].scrollHeight);

                if (isLast) {
                    $('.continue-button').prop('disabled', true).text("Completed");
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: response.error || 'Failed to load instruction.'
                });
            }
        },
        error: function () {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while fetching data.'
            });
        }
    });
}

$('.continue-button')
.attr('data-labid', id)
.attr('data-command', newCommand);

   
   function handleContinueClick(button) {
	    const labId = button.getAttribute('data-labid');
	    const command = button.getAttribute('data-command');
// 	    alert("labId :"+labId)
// 	     alert("command :"+command)
	    continueAction(labId, command);
	}

   
   function continueAction(id,command) {
	    $.ajax({
	        type: "POST",
	        url: "/guac/continueActionInstruction",
	        data: {
	            labId: id,
	            labcommand: command
	        },
	        success: function (response) {
	            if (response.success) {
	            	
	                const newInstruction = response.instruction;
// 	                alert("newInstruction :"+newInstruction)
	                const newCommand = response.command;
// 	                alert("newCommand :"+newCommand)
	                const isLast = response.isLast || false;
	                $('.continue-button')
	                .attr('data-labid', id)
	                .attr('data-command', newCommand);
	                // Instruction HTML
	                const instructionHtml = `
	                    <div class="message incoming">
	                        <div class="message-content">${newInstruction}</div>
	                    </div>
	                `;

	                // Command HTML
	                const commandHtml = `
	                    <div class="message incoming">
	                        <div class="message-content">${newCommand}</div>
	                    </div>
	                `;

	                // Append to chat window
	                $('#chat-messages').append(instructionHtml).append(commandHtml);

	                // Auto scroll to bottom
	                const chatMessages = $('#chat-messages');
	                chatMessages.scrollTop(chatMessages[0].scrollHeight);

	                // Disable button if it's the last step
	                if (isLast) {
	                    $('.continue-button').prop('disabled', true).text("Completed");
	                }
	            } else {
	                Swal.fire({
	                    icon: 'error',
	                    title: 'Failed',
	                    text: response.error || 'Failed to load instruction.'
	                });
	            }
	        },
	        error: function () {
	            Swal.fire({
	                icon: 'error',
	                title: 'Error',
	                text: 'An error occurred while fetching data.'
	            });
	        }
	    });
	}


function switchTab(tabName) {
    // Remove active class from all tabs
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Highlight the clicked tab
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
            tab.classList.add('active');
        }
    });

    // Hide all tab content
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });

    // Show selected tab
    const tabContent = document.getElementById(tabName + '-tab');
    if (tabContent) {
        tabContent.classList.add('active');
    }
}


        $(document).ready(function() {
            // Toggle sidebar visibility
            $('#toggle-sidebar').click(function() {
                $('#instruction-sidebar').toggle();
                const isVisible = $('#instruction-sidebar').is(':visible');
                $(this).html(isVisible ? 
                    '<i class="fas fa-times"></i> Close' : 
                    '<i class="fas fa-comments"></i> Instructions');
            });
            
            // Fullscreen functionality
            $('#fullscreen-btn').click(function() {
                const elem = $('.connection-container')[0];
                
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        elem.msRequestFullscreen();
                    }
                    $(this).html('<i class="fas fa-compress"></i> Exit Fullscreen');
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                    $(this).html('<i class="fas fa-expand"></i> Fullscreen');
                }
            });
            
            // Session timer
            let startTime = Date.now();
            function updateTimer() {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                
                const timeString = [
                    hours.toString().padStart(2, '0'),
                    minutes.toString().padStart(2, '0'),
                    seconds.toString().padStart(2, '0')
                ].join(':');
                
                $('#session-timer').text(timeString);
                $('#connection-duration').text(timeString);
            }
            setInterval(updateTimer, 1000);
            
            // Simulate connection loading
            $('#rdp-frame').on('load', function() {
                $('#loading-indicator').fadeOut();
            });
            
            // Chat functionality
            $('#send-message').click(sendMessage);
            $('#chat-input').keypress(function(e) {
                if (e.which === 13) { // Enter key
                    sendMessage();
                }
            });
            
            function sendMessage() {
                const messageText = $('#chat-input').val().trim();
                if (messageText) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Add user message
                    $('#chat-messages').append(`
                        <div class="message outgoing">
                            <div class="message-content">${messageText}</div>
                            <div class="message-time">${timeString}</div>
                        </div>
                    `);
                    
                    // Clear input
                    $('#chat-input').val('');
                    
                    // Scroll to bottom
                    const chatMessages = $('#chat-messages');
                    chatMessages.scrollTop(chatMessages[0].scrollHeight);
                    
                    // Simulate bot response after a delay
                    setTimeout(() => {
                        $('#chat-messages').append(`
                            <div class="message incoming">
                                <div class="message-sender">Support Bot</div>
                                <div class="message-content">Thanks for your message. Our support team will respond shortly.</div>
                                <div class="message-time">${timeString}</div>
                            </div>
                        `);
                        chatMessages.scrollTop(chatMessages[0].scrollHeight);
                    }, 1000);
                }
            }
            
            // Simulate resource usage updates
            setInterval(() => {
                $('#cpu-usage').text(Math.floor(Math.random() * 30 + 5) + '%');
                $('#memory-usage').text(Math.floor(Math.random() * 30 + 50) + '%');
                $('#network-in').text((Math.random() * 5 + 1).toFixed(1) + ' Mbps');
                $('#network-out').text((Math.random() * 3 + 0.5).toFixed(1) + ' Mbps');
            }, 5000);
        });
    </script>
</body>
</html>
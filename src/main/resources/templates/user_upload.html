<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="template :: headFragment('Bulk User Upload')"></head>
<link rel="stylesheet" th:href="@{/webtemplate/plugins/sweetalert2/sweetalert2.min.css}">

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <div th:replace="fragments/header_bk :: header"></div>
        <div th:replace="fragments/sidebar :: aside"></div>

        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Bulk User Upload</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item"><a th:href="@{'/users/view/'}">Users</a></li>
                                <li class="breadcrumb-item active">Bulk Upload</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <!-- File Upload Details Div -->
                            <div class="card card-primary" style="display: none;" id="fileUploadDetails">
                                <div class="card-header">
                                    <h3 class="card-title">File Upload Details</h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <br>
                                            <center>
                                                <h3 style="color: #000">
                                                    <b>Uploaded Successfully</b>
                                                </h3>
                                            </center>
                                            <br>
                                            <center>
                                                <p id="insertshow">
                                                    <b> Inserted Record = <span id="insertCount">0</span></b>
                                                </p>
                                            </center>
                                            <br>
                                            <center>
                                                <p id="updateshow">
                                                    <b>Updated Record = <span id="updateCount">0</span></b>
                                                </p>
                                            </center>
                                            <br>
                                            <center>
                                                <p id="deleteshow">
                                                    <b>Delete Record = <span id="deleteCount">0</span></b>
                                                </p>
                                            </center>
                                            <br>
                                            <center>
                                                <p id="failshow">
                                                    <b>Failed Record = <span id="failCount">0</span></b>
                                                </p>
                                            </center>
                                            <br>
                                            <center>
                                                <b>Failed Record Details:
                                                    <button class="downloadbtn" id="downloadFailedRecords">
                                                        <i class="fa fa-download"></i> Download
                                                    </button>
                                                </b>
                                            </center>
                                            <br><br>
                                            <center>
                                                <button class="btn btn-primary" id="bulkupload_back">
                                                    <font color="white">Back</font>
                                                </button>
                                            </center>
                                            <br><br>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- End File Upload Details Div -->

                            <div class="card card-secondary" id="uploadFile">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <h3 class="card-title" style="padding-top: 10px">Bulk User Upload</h3>
                                        </div>
                                        <div class="col-md-2">
                                            <a th:href="@{'/users/view/'}" class="btn btn-block bg-gradient-primary">View Users</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Download Template Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="alert alert-info">
                                                <h5><i class="icon fas fa-info-circle"></i> Instructions</h5>
                                                <ul>
                                                    <li>Download the template file below</li>
                                                    <li>Fill in the user data according to the format</li>
                                                    <li>Use Key Parameter: 1=Insert, 2=Update, 3=Delete</li>
                                                    <li>Select the file and click Submit Upload</li>
                                                    <li>Maximum file size: 10MB</li>
                                                    <li>Supported formats: .xlsx</li>
                                                    <li><strong>For updates, email field is used to identify the user</strong></li>
                                                    <li><strong>For deletes, email field is used to identify the user</strong></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Download Template</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p>Download the template to ensure correct formatting:</p>
                                                    <div class="btn-group">
                                                        <a th:href="@{/users/download-excel-template}" class="btn btn-success">
                                                            <i class="fas fa-download"></i> Download Excel Template
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Data Format</h5>
                                                </div>
                                                <div class="card-body">
                                                    <small>
                                                        <strong>Required Fields:</strong> name, userName, email, mobileNo, roleId, groupName, keyParam<br>
                                                        <strong>Optional Fields:</strong> departmentName, courseName, semesterName, batchName<br>
                                                        <strong>Role IDs:</strong> 1=Admin, 2=User, 3=Super Admin, 4=Teacher<br>
                                                        <strong>Key Parameter:</strong> 1=Insert, 2=Update, 3=Delete<br>
                                                        <strong class="text-danger">For updates and deletes, email is used to identify the user</strong>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Upload Section -->
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Upload File</h5>
                                                </div>
                                                <div class="card-body">
                                                    <form id="uploadForm" method="post" enctype="multipart/form-data">
                                                        <div class="form-group">
                                                            <label for="fileInput">Select Excel File</label>
                                                            <div class="custom-file">
                                                                <input type="file" class="custom-file-input" id="fileInput" name="file" accept=".xlsx" required>
                                                                <label class="custom-file-label" for="fileInput" id="fileInputLabel">Choose file</label>
                                                            </div>
                                                            <small class="form-text text-muted">Maximum file size: 10MB, Only .xlsx files allowed</small>
                                                            <span id="selectFile" style="color: red; display: none;">Please Select the File</span>
                                                        </div>
                                                        
                                                        <div id="fileInfo" class="alert alert-info mt-3" style="display: none;">
                                                            <i class="fas fa-file"></i> 
                                                            <strong>Selected File:</strong> 
                                                            <span id="fileName"></span> 
                                                            (<span id="fileSize"></span>)
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Submit Button -->
                                    <div class="row mt-4">
                                        <div class="col-md-12 text-center">
                                            <button type="button" id="submitUpload" class="btn btn-primary btn-lg" style="display: none;">
                                                <i class="fas fa-upload"></i> Submit Upload
                                            </button>
                                            <center>
                                                <i style="margin-left: 10px; display: none;" id="uploadFileSpinner" class='fa fa-spinner fa-spin fa-2x'></i>
                                            </center>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <a th:href="@{'/users/view/'}" class="btn btn-default">Back to Users</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <div th:replace="fragments/footer :: footer"></div>
    </div>

    <div th:replace="template :: jsscript"></div>
</body>
<script th:src="@{/webtemplate/plugins/sweetalert2/sweetalert2.min.js}"></script>
<script th:src="@{/webtemplate/plugins/bs-custom-file-input/bs-custom-file-input.min.js}"></script>

<script>
    $(document).ready(function() {
        // Initialize custom file input
        bsCustomFileInput.init();
        
        let selectedFile = null;

        // File input change event
        $('#fileInput').on('change', function(e) {
            const file = e.target.files[0];
            selectedFile = file;
            
            if (file) {
                // Validate file type
                const validTypes = ['.xlsx'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validTypes.includes(fileExtension)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File Type',
                        text: 'Please select an Excel file (.xlsx)',
                        confirmButtonColor: '#d33'
                    });
                    $(this).val('');
                    selectedFile = null;
                    $('#submitUpload').hide();
                    $('#fileInfo').hide();
                    $('#selectFile').hide();
                    return;
                }
                
                // Validate file size (10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                if (file.size > maxSize) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'File size must be less than 10MB',
                        confirmButtonColor: '#d33'
                    });
                    $(this).val('');
                    selectedFile = null;
                    $('#submitUpload').hide();
                    $('#fileInfo').hide();
                    $('#selectFile').hide();
                    return;
                }
                
                // Show file info
                $('#fileName').text(file.name);
                $('#fileSize').text(formatFileSize(file.size));
                $('#fileInfo').show();
                $('#selectFile').hide();
                
                // Show submit button
                $('#submitUpload').show();
                
                // Hide previous results
                $('#fileUploadDetails').hide();
            } else {
                selectedFile = null;
                $('#submitUpload').hide();
                $('#fileInfo').hide();
            }
        });

        // Submit upload button
        $('#submitUpload').click(function() {
            if (!selectedFile) {
                $('#selectFile').show();
                Swal.fire({
                    icon: 'warning',
                    title: 'No File Selected',
                    text: 'Please select a file first.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            // Show spinner and disable button
            $('#uploadFileSpinner').show();
            $(this).prop('disabled', true);

            // Create FormData and submit
            const formData = new FormData();
            formData.append('file', selectedFile);

            $.ajax({
                url: '/users/bulk-upload-with-edit',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log("Upload success response:", response);
                    $('#uploadFileSpinner').hide();
                    $('#submitUpload').prop('disabled', false);
                    
                    if (response.success) {
                        // Show upload details
                        $('#fileUploadDetails').show();
                        $('#uploadFile').hide();
                        
                        // Update counts
                        $('#insertCount').text(response.insertCount || 0);
                        $('#updateCount').text(response.updateCount || 0);
                        $('#deleteCount').text(response.deleteCount || 0);
                        $('#failCount').text(response.failCount || 0);
                        
                        // Store failed records for download
                        if (response.failedRecords && response.failedRecords.length > 0) {
                            $('#downloadFailedRecords').data('failedRecords', response.failedRecords);
                        }
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Upload Completed',
                            html: `<div class="text-left">
                                <h5>Upload Summary:</h5>
                                <p><strong>Inserted:</strong> ${response.insertCount || 0}</p>
                                <p><strong>Updated:</strong> ${response.updateCount || 0}</p>
                                <p><strong>Deleted:</strong> ${response.deleteCount || 0}</p>
                                <p><strong>Failed:</strong> ${response.failCount || 0}</p>
                            </div>`,
                            confirmButtonColor: '#28a745'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Upload Failed',
                            text: response.message || 'An error occurred during upload.',
                            confirmButtonColor: '#d33'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Upload error:", error);
                    $('#uploadFileSpinner').hide();
                    $('#submitUpload').prop('disabled', false);
                    
                    let errorMessage = 'An error occurred during upload.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Upload Failed',
                        text: errorMessage,
                        confirmButtonColor: '#d33'
                    });
                }
            });
        });

        // Download failed records
        $('#downloadFailedRecords').click(function() {
            const failedRecords = $(this).data('failedRecords');
            if (!failedRecords || failedRecords.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'No Failed Records',
                    text: 'There are no failed records to download.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            // Convert to CSV and download
            const csvContent = convertToCSV(failedRecords);
            downloadCSV(csvContent, 'failed_records.csv');
        });

        // Back button
        $('#bulkupload_back').click(function() {
            $('#fileUploadDetails').hide();
            $('#uploadFile').show();
            // Reset form
            $('#uploadForm')[0].reset();
            $('#fileInputLabel').text('Choose file');
            $('#fileInfo').hide();
            $('#submitUpload').hide();
            selectedFile = null;
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function convertToCSV(objArray) {
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = '';
            
            // Headers
            const headers = Object.keys(array[0]);
            str += headers.join(',') + '\r\n';
            
            // Data
            for (let i = 0; i < array.length; i++) {
                let line = '';
                for (let j = 0; j < headers.length; j++) {
                    if (line !== '') line += ',';
                    line += array[i][headers[j]] || '';
                }
                str += line + '\r\n';
            }
            return str;
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    });
</script>
</html>
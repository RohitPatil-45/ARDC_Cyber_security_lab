<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="template :: headFragment('Bulk User Upload')"></head>
<link rel="stylesheet" th:href="@{/webtemplate/plugins/sweetalert2/sweetalert2.min.css}">

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <div th:replace="fragments/header_bk :: header"></div>
        <div th:replace="fragments/sidebar :: aside"></div>

        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Bulk User Upload</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item"><a th:href="@{'/users/view/'}">Users</a></li>
                                <li class="breadcrumb-item active">Bulk Upload</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-secondary">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <h3 class="card-title" style="padding-top: 10px">Upload Users in Bulk</h3>
                                        </div>
                                        <div class="col-md-2">
                                            <a th:href="@{'/users/view/'}" class="btn btn-block bg-gradient-primary">View Users</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Download Template Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="alert alert-info">
                                                <h5><i class="icon fas fa-info-circle"></i> Instructions</h5>
                                                <ul>
                                                    <li>Download the template file below</li>
                                                    <li>Fill in the user data according to the format</li>
                                                    <li>Select the file and click Submit Upload</li>
                                                    <li>Maximum file size: 10MB</li>
                                                    <li>Supported formats: .csv, .xlsx, .xls</li>
                                                    <li><strong>Switch ID and Generation Type will be set to default values (1)</strong></li>
                                                    <li><strong>Username, Email, and Mobile Number must be unique</strong></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Download Template</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p>Download the template to ensure correct formatting:</p>
                                                    <div class="btn-group">
                                                        <a th:href="@{/users/download-csv-template}" class="btn btn-success">
                                                            <i class="fas fa-download"></i> Download CSV Template
                                                        </a>
                                                        <a th:href="@{/users/download-excel-template}" class="btn btn-success ml-2">
                                                            <i class="fas fa-download"></i> Download Excel Template
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Data Format</h5>
                                                </div>
                                                <div class="card-body">
                                                    <small>
                                                        <strong>Required Fields:</strong> name, userName, email, mobileNo, roleId, groupName<br>
                                                        <strong>Optional Fields:</strong> departmentName, courseName, semesterName, batchName<br>
                                                        <strong>Role IDs:</strong> 1=Admin, 2=User, 3=Super Admin, 4=Teacher<br>
<!--                                                         <strong>Default Values:</strong> Switch ID = 1, Generation Type = 1<br> -->
                                                        <strong class="text-danger">Username, Email, and Mobile Number must be unique</strong>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Upload Section -->
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Upload File</h5>
                                                </div>
                                                <div class="card-body">
                                                    <form id="uploadForm" method="post" enctype="multipart/form-data">
                                                        <div class="form-group">
                                                            <label for="fileInput">Select File (CSV or Excel)</label>
                                                            <div class="custom-file">
                                                                <input type="file" class="custom-file-input" id="fileInput" name="file" accept=".csv,.xlsx,.xls" required>
                                                                <label class="custom-file-label" for="fileInput" id="fileInputLabel">Choose file</label>
                                                            </div>
                                                            <small class="form-text text-muted">Maximum file size: 10MB</small>
                                                        </div>
                                                        
                                                        <div id="fileInfo" class="alert alert-info mt-3" style="display: none;">
                                                            <i class="fas fa-file"></i> 
                                                            <strong>Selected File:</strong> 
                                                            <span id="fileName"></span> 
                                                            (<span id="fileSize"></span>)
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Submit Button -->
                                    <div class="row mt-4">
                                        <div class="col-md-12 text-center">
                                            <button type="button" id="submitUpload" class="btn btn-primary btn-lg" style="display: none;">
                                                <i class="fas fa-upload"></i> Submit Upload
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Progress and Results Section -->
                                    <div class="row mt-4" id="progressSection" style="display: none;">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Upload Progress</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="progress mb-3">
                                                        <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                                                    </div>
                                                    <div id="uploadStatus" class="alert alert-info">Preparing upload...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-4" id="resultsSection" style="display: none;">
                                        <div class="col-md-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="card-title">Upload Results</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div id="successResults" class="alert alert-success" style="display: none;">
                                                        <h6><i class="icon fas fa-check"></i> Successful Uploads</h6>
                                                        <div id="successList"></div>
                                                    </div>
                                                    <div id="errorResults" class="alert alert-danger" style="display: none;">
                                                        <h6><i class="icon fas fa-exclamation-triangle"></i> Errors</h6>
                                                        <div id="errorList"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <a th:href="@{'/users/view/'}" class="btn btn-default">Back to Users</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <div th:replace="fragments/footer :: footer"></div>
    </div>

    <div th:replace="template :: jsscript"></div>
</body>
<script th:src="@{/webtemplate/plugins/sweetalert2/sweetalert2.min.js}"></script>
<script th:src="@{/webtemplate/plugins/bs-custom-file-input/bs-custom-file-input.min.js}"></script>

<script>
    $(document).ready(function() {
        // Initialize custom file input
        bsCustomFileInput.init();
        
        let selectedFile = null;

        // File input change event
        $('#fileInput').on('change', function(e) {
            const file = e.target.files[0];
            selectedFile = file;
            
            if (file) {
                // Validate file type
                const validTypes = ['.csv', '.xlsx', '.xls'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validTypes.includes(fileExtension)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File Type',
                        text: 'Please select a CSV or Excel file (.csv, .xlsx, .xls)',
                        confirmButtonColor: '#d33'
                    });
                    $(this).val('');
                    selectedFile = null;
                    $('#submitUpload').hide();
                    $('#fileInfo').hide();
                    return;
                }
                
                // Validate file size (10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                if (file.size > maxSize) {
                    Swal.fire({
                        icon: 'error',
                        title: 'File Too Large',
                        text: 'File size must be less than 10MB',
                        confirmButtonColor: '#d33'
                    });
                    $(this).val('');
                    selectedFile = null;
                    $('#submitUpload').hide();
                    $('#fileInfo').hide();
                    return;
                }
                
                // Show file info
                $('#fileName').text(file.name);
                $('#fileSize').text(formatFileSize(file.size));
                $('#fileInfo').show();
                
                // Show submit button
                $('#submitUpload').show();
                
                // Hide previous results
                $('#resultsSection').hide();
                $('#progressSection').hide();
            } else {
                selectedFile = null;
                $('#submitUpload').hide();
                $('#fileInfo').hide();
            }
        });

        // Submit upload button
        $('#submitUpload').click(function() {
            if (!selectedFile) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No File Selected',
                    text: 'Please select a file first.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            // Show progress section
            $('#progressSection').show();
            $('#resultsSection').hide();
            updateProgress(10, 'Starting upload process...');

            // Create FormData and submit
            const formData = new FormData();
            formData.append('file', selectedFile);

            // Disable submit button during upload
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');

            $.ajax({
                url: '/users/bulk-upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            updateProgress(30 + percentComplete * 0.7, 'Uploading file... ' + percentComplete + '%');
                        }
                    }, false);
                    return xhr;
                },
                success: function(response) {
                    console.log("Upload success response:", response);
                    updateProgress(100, 'Processing complete!');
                    
                    // Show results
                    showResults(response);
                    
                    // Show SweetAlert notification
                    showUploadNotification(response);
                    
                    // Re-enable submit button
                    $('#submitUpload').prop('disabled', false).html('<i class="fas fa-upload"></i> Submit Upload');
                },
                error: function(xhr, status, error) {
                    console.error("Upload error:", error);
                    updateProgress(0, 'Upload failed!');
                    
                    let errorMessage = 'An error occurred during upload.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Upload Failed',
                        text: errorMessage,
                        confirmButtonColor: '#d33'
                    });
                    
                    // Re-enable submit button
                    $('#submitUpload').prop('disabled', false).html('<i class="fas fa-upload"></i> Submit Upload');
                }
            });
        });

        function updateProgress(percent, message) {
            $('#uploadProgress').css('width', percent + '%').text(percent + '%');
            $('#uploadStatus').text(message);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showResults(response) {
            $('#resultsSection').show();
            
            // Clear previous results
            $('#successList').empty();
            $('#errorList').empty();
            
            if (response.successUsers && response.successUsers.length > 0) {
                $('#successResults').show();
                let successHtml = '<div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr><th>Name</th><th>Username</th><th>Email</th><th>Switch ID</th><th>Generation Type</th><th>Status</th></tr></thead><tbody>';
                response.successUsers.forEach(user => {
                    successHtml += `<tr>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.userName || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.switchId || '1 (Default)'}</td>
                        <td>${user.generationType || '1 (Default)'}</td>
                        <td><span class="badge badge-success">Success</span></td>
                    </tr>`;
                });
                successHtml += '</tbody></table></div>';
                $('#successList').html(successHtml);
            } else {
                $('#successResults').hide();
            }

            if (response.errorUsers && response.errorUsers.length > 0) {
                $('#errorResults').show();
                let errorHtml = '<div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr><th>Username</th><th>Error</th></tr></thead><tbody>';
                response.errorUsers.forEach(error => {
                    // Check if it's a duplicate error
                    const isDuplicateError = error.error && (
                        error.error.includes('already exists') || 
                        error.error.includes('duplicate') ||
                        error.error.includes('unique')
                    );
                    
                    const errorClass = isDuplicateError ? 'warning' : 'danger';
                    const errorIcon = isDuplicateError ? 'fa-exclamation-triangle' : 'fa-times-circle';
                    
                    errorHtml += `<tr>
                        <td><strong>${error.userName || 'Unknown'}</strong></td>
                        <td>
                            <span class="text-${errorClass}">
                                <i class="fas ${errorIcon} mr-1"></i>
                                ${error.error || 'Unknown error'}
                            </span>
                        </td>
                    </tr>`;
                });
                errorHtml += '</tbody></table></div>';
                $('#errorList').html(errorHtml);
            } else {
                $('#errorResults').hide();
            }

            // Show summary in progress section
            if (response.successUsers && response.errorUsers) {
                const total = response.totalProcessed || (response.successUsers.length + response.errorUsers.length);
                const successCount = response.successCount || response.successUsers.length;
                const errorCount = response.errorCount || response.errorUsers.length;
                
                $('#uploadStatus').html(
                    `<div class="alert alert-info">
                        <h6><i class="fas fa-chart-bar"></i> Upload Summary</h6>
                        <strong>Total Records Processed:</strong> ${total}<br>
                        <strong class="text-success">Successful:</strong> ${successCount}<br>
                        <strong class="text-danger">Errors:</strong> ${errorCount}
                    </div>`
                );
            }
        }

        function showUploadNotification(response) {
            const total = response.totalProcessed || 0;
            const successCount = response.successCount || 0;
            const errorCount = response.errorCount || 0;

            // Check if there are any duplicate errors
            const duplicateErrors = response.errorUsers ? 
                response.errorUsers.filter(error => 
                    error.error && error.error.includes('already exists')
                ).length : 0;

            if (successCount === total && successCount > 0) {
                // All successful
                Swal.fire({
                    icon: 'success',
                    title: 'Upload Successful!',
                    html: `<div class="text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h4>All users uploaded successfully!</h4>
                        <p><strong>${successCount}</strong> users were created successfully.</p>
                        <p class="text-muted"><small>Switch ID and Generation Type set to default values (1)</small></p>
                    </div>`,
                    confirmButtonColor: '#28a745',
                    confirmButtonText: 'Great!'
                });
            } else if (successCount > 0 && errorCount > 0) {
                // Partial success
                let htmlContent = `<div class="text-left">
                    <h4>Upload Completed with Results</h4>
                    <p><strong>Total Processed:</strong> ${total}</p>
                    <p class="text-success"><strong>Successful:</strong> ${successCount}</p>
                    <p class="text-danger"><strong>Errors:</strong> ${errorCount}</p>
                    <p class="text-info"><small>Switch ID and Generation Type set to default values (1) for successful users</small></p>`;
                
                if (duplicateErrors > 0) {
                    htmlContent += `<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Duplicate Records:</strong> ${duplicateErrors}</p>`;
                }
                
                htmlContent += `</div>`;

                Swal.fire({
                    icon: 'warning',
                    title: 'Partial Upload',
                    html: htmlContent,
                    confirmButtonColor: '#ffc107',
                    confirmButtonText: 'View Details'
                });
            } else if (errorCount === total && errorCount > 0) {
                // All failed
                let htmlContent = `<div class="text-left">
                    <h4>Upload Failed</h4>
                    <p>All <strong>${errorCount}</strong> records failed to upload.</p>`;
                
                if (duplicateErrors > 0) {
                    htmlContent += `<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Duplicate Records Found:</strong> ${duplicateErrors}</p>`;
                }
                
                htmlContent += `<p>Please check the error details below and try again.</p></div>`;

                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    html: htmlContent,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'View Errors'
                });
            } else {
                // No records processed
                Swal.fire({
                    icon: 'info',
                    title: 'No Records Processed',
                    text: 'No user records were found in the uploaded file.',
                    confirmButtonColor: '#17a2b8'
                });
            }
        }
    });
</script>
</html>
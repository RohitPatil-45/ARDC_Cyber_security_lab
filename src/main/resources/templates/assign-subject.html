<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="template :: headFragment(${pageTitle})"></head>
<link rel="stylesheet"
	th:href="@{/webtemplate/plugins/select2/css/select2.min.css}">
<link rel="stylesheet"
	th:href="@{/webtemplate/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css}">
<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">

		<div th:replace="fragments/header_bk :: header"></div>
		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">

			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>Assign Subject to Teacher</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#">Home</a></li>
								<li class="breadcrumb-item active">Assign Subject</li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<!-- Main content -->
			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-12">
							<div class="card card-secondary">
								<div class="card-header">
									<div class="row">
										<div class="col-md-10">
											<h3 class="card-title" style="padding-top: 10px">[[${pageTitle}]]</h3>
										</div>
										<div class="col-md-2">
											<a th:href="@{'/guac/teachers'}"
												class="btn btn-block bg-gradient-primary">View Teachers</a>
										</div>
									</div>
								</div>
								
								<!-- Success/Error Messages -->
								<div th:if="${success}" class="alert alert-success alert-dismissible m-3">
									<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
									<span th:text="${success}"></span>
								</div>
								<div th:if="${error}" class="alert alert-danger alert-dismissible m-3">
									<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
									<span th:text="${error}"></span>
								</div>
								<div th:if="${warning}" class="alert alert-warning alert-dismissible m-3">
									<button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
									<span th:text="${warning}"></span>
								</div>
								
								<form th:action="@{/guac/assign_subject_save}" method="post"
									onsubmit="return validateForm()">
									<div class="card-body">
										<div class="row">
											<!-- Teacher Selection -->
											<div class="col-md-6">
												<div class="form-group">
													<label>Select Teacher</label>
													<select id="teacherSelect" class="form-control" name="teacherId" required>
														<option value="">-- Select Teacher --</option>
														<option th:each="teacher : ${teachers}"
															th:value="${teacher.userId}"
															th:text="${teacher.name}"></option>
													</select>
												</div>
											</div>
											<div class="col-md-6">
												<!-- Department dropdown -->
												<div class="form-group">
													<label>Department</label>
													<select id="departmentSelect" class="form-control" name="departmentId" required>
														<option value="">-- Select Department --</option>
														<option th:each="d : ${departments}"
															th:value="${d.departmentId}"
															th:text="${d.departmentName}"></option>
													</select>
												</div>
											</div>

											<div class="col-md-6">
												<!-- Course dropdown -->
												<div class="form-group">
													<label>Course</label>
													<select id="courseSelect" class="form-control" name="courseId" required>
														<option value="">-- Select Course --</option>
													</select>
												</div>
											</div>

											<div class="col-md-6">
												<!-- Semester dropdown -->
												<div class="form-group">
													<label>Semester</label>
													<select id="semesterSelect" class="form-control" name="semesterId" required>
														<option value="">-- Select Semester --</option>
													</select>
												</div>
											</div>
											
											<div class="col-md-6">
												<!-- Batch dropdown -->
												<div class="form-group">
													<label>Batch</label>
													<select id="batchSelect" class="form-control" name="batchId" required>
														<option value="">-- Select Batch --</option>
													</select>
												</div>
											</div>
											
											<div class="col-md-6">
												<!-- Subjects multiselect -->
												<div class="form-group">
													<label>Select Subjects</label>
													<select id="subjectSelect" class="form-control select2" 
															name="subjectIds" multiple="multiple" required style="width: 100%;">
														<option value="">-- Select Subjects --</option>
													</select>
													<small class="form-text text-muted">You can select multiple subjects</small>
												</div>
											</div>
										</div>
									</div>
									<div class="card-footer">
										<button type="submit" class="btn btn-primary">Assign Subjects</button>
										<a th:href="@{'/teachers'}" class="btn btn-secondary">Cancel</a>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>
</body>
<script th:src="@{/webtemplate/plugins/select2/js/select2.full.min.js}"></script>
<script
	th:src="@{/webtemplate/plugins/jquery-validation/jquery.validate.min.js}"></script>

<script th:inline="javascript">
	$(function() {
		// Initialize select2 for multiselect
		$('.select2').select2({
			placeholder: "Select subjects",
			allowClear: true
		});
	});

	$(document).ready(function() {
	    const deptSel = $('#departmentSelect');
	    const courseSel = $('#courseSelect');
	    const semSel = $('#semesterSelect');
	    const subjectSel = $('#subjectSelect');
	    const batchSel = $('#batchSelect');

	    deptSel.change(function() {
	        const deptId = $(this).val();
	        if (!deptId) {
	            courseSel.html('<option value="">-- Select Course --</option>');
	            semSel.html('<option value="">-- Select Semester --</option>');
	            subjectSel.html('<option value="">-- Select Subjects --</option>');
	            batchSel.html('<option value="">-- Select Batch --</option>');
	            return;
	        }
	        $.ajax({
	            url: '/guac/courses',
	            type: 'GET',
	            data: { departmentId: deptId },
	            success: function(data) {
	                courseSel.empty().append('<option value="">-- Select Course --</option>');
	                semSel.html('<option value="">-- Select Semester --</option>');
	                subjectSel.html('<option value="">-- Select Subjects --</option>');
	                batchSel.html('<option value="">-- Select Batch --</option>');
	                data.forEach(c => {
	                    courseSel.append(`<option value="${c.courseId}">${c.courseName}</option>`);
	                });
	            }
	        });
	    });

	    courseSel.change(function() {
	        const cId = $(this).val();
	        if (!cId) {
	            semSel.html('<option value="">-- Select Semester --</option>');
	            subjectSel.html('<option value="">-- Select Subjects --</option>');
	            batchSel.html('<option value="">-- Select Batch --</option>');
	            return;
	        }
	        $.ajax({
	            url: '/guac/semesters',
	            type: 'GET',
	            data: { courseId: cId },
	            success: function(data) {
	                semSel.empty().append('<option value="">-- Select Semester --</option>');
	                subjectSel.html('<option value="">-- Select Subjects --</option>');
	                batchSel.html('<option value="">-- Select Batch --</option>');
	                data.forEach(s => {
	                    semSel.append(`<option value="${s.semesterId}">${s.semesterName}</option>`);
	                });
	            }
	        });
	    });

	    semSel.change(function() {
	        const sId = $(this).val();
	        if (!sId) {
	            subjectSel.html('<option value="">-- Select Subjects --</option>');
	            batchSel.html('<option value="">-- Select Batch --</option>');
	            return;
	        }
	        
	        // Fetch subjects for the selected semester
	        $.ajax({
	            url: '/guac/subjects',
	            type: 'GET',
	            data: { semesterId: sId },
	            success: function(data) {
	                subjectSel.empty().append('<option value="">-- Select Subjects --</option>');
	                if (data && data.length > 0) {
	                    data.forEach(sub => {
	                        // Show if subject is already assigned
	                        const isAssigned = sub.teacher ? true : false;
	                        const assignedText = isAssigned ? ` (Assigned to: ${sub.teacher})` : '';
	                        const disabled = isAssigned ? 'disabled' : '';
	                        subjectSel.append(`<option value="${sub.subjectId}" ${disabled}>
	                            ${sub.subjectName}
	                        </option>`);
	                    });
	                } else {
	                    subjectSel.append(`<option value="">No subjects available for this semester</option>`);
	                }
	                // Refresh select2 to show new options
	                subjectSel.select2();
	            },
	            error: function() {
	                subjectSel.html('<option value="">Error loading subjects</option>');
	                subjectSel.select2();
	            }
	        });
	        
	        // Fetch batches for the selected semester
	        $.ajax({
	            url: '/guac/batches',
	            type: 'GET',
	            data: { semesterId: sId },
	            success: function(data) {
	                batchSel.empty().append('<option value="">-- Select Batch --</option>');
	                data.forEach(b => {
	                    batchSel.append(`<option value="${b.batchId}">${b.batchName}</option>`);
	                });
	            }
	        });
	    });
	    
	    // Form validation function
	    function validateForm() {
	        const teacherId = $('#teacherSelect').val();
	        const subjectIds = $('#subjectSelect').val();
	        
	        if (!teacherId) {
	            alert('Please select a teacher');
	            return false;
	        }
	        
	        if (!subjectIds || subjectIds.length === 0) {
	            alert('Please select at least one subject');
	            return false;
	        }
	        
	        return true;
	    }
	});
</script>
</html>
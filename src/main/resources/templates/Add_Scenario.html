<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head th:include="template :: headFragment(${pageTitle})">
<link rel="icon" type="image/png" href="/webtemplate/dist/img/magicboxEye3.png">
<title>Scenario Manager | CMP</title>

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Summernote CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css"
	rel="stylesheet">

<link
	href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
	rel="stylesheet" />

<style>
:root {
	--primary: #3498db;
	--secondary: #2c3e50;
	--light: #ecf0f1;
	--dark: #1a252f;
	--success: #2ecc71;
	--danger: #e74c3c;
	--warning: #f39c12;
	--info: #1abc9c;
}

body {
	background-color: #f5f7fa;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.main-header {
	background-color: var(--secondary) !important;
	border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
}

.content-wrapper {
	background-color: #f5f7fa;
}

.card {
	border-radius: 8px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
	border: none;
}

.card-header {
	background-color: white;
	border-bottom: 1px solid rgba(0, 0, 0, 0.05);
	border-radius: 8px 8px 0 0 !important;
	padding: 20px;
}

.card-title {
	font-weight: 600;
	color: var(--secondary);
	font-size: 1.25rem;
	margin: 0;
}

.form-control {
	border-radius: 6px;
	border: 1px solid #ddd;
	padding: 10px 15px;
	height: auto;
	transition: all 0.3s;
}

.form-control:focus {
	border-color: var(--primary);
	box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.btn-primary {
	background-color: var(--primary);
	border-color: var(--primary);
	border-radius: 6px;
	padding: 10px 20px;
	font-weight: 500;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}

.btn-primary:hover {
	background-color: #2980b9;
	border-color: #2980b9;
}

.breadcrumb {
	background-color: transparent;
	padding: 0;
}

.content-header h1 {
	font-weight: 600;
	color: var(--secondary);
	font-size: 1.8rem;
}

label {
	font-weight: 500;
	color: #555;
	margin-bottom: 8px;
}

.nav-sidebar .nav-item .nav-link {
	border-radius: 4px;
	margin-bottom: 5px;
}

.form-section {
	background-color: white;
	padding: 25px;
	border-radius: 8px;
	margin-bottom: 20px;
}

.form-section-title {
	font-size: 1.1rem;
	color: var(--secondary);
	margin-bottom: 20px;
	padding-bottom: 10px;
	border-bottom: 1px solid #eee;
	font-weight: 600;
}

.footer {
	background-color: var(--secondary);
	color: white;
	padding: 15px 0;
}

/* Summernote customization */
.note-editor.note-frame {
	border-radius: 6px;
	border: 1px solid #ddd;
}

.note-editor.note-frame .note-statusbar {
	border-bottom-left-radius: 6px;
	border-bottom-right-radius: 6px;
}

.note-btn-group {
	border-radius: 4px;
	overflow: hidden;
}

.note-editable {
	background-color: white;
	min-height: 150px;
}

.avatar-circle {
	width: 40px;
	height: 40px;
	border-radius: 50%;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 18px;
}

.comment-box {
	border: 1px solid #ddd;
	border-radius: 8px;
	padding: 12px;
	background-color: #f8f9fa;
}

.comment-box textarea {
	border: none;
	background: transparent;
	resize: none;
	box-shadow: none;
	padding: 0;
}

.comment-box textarea:focus {
	box-shadow: none;
}

.comment-actions .btn-link {
	padding: 0 8px;
}

.comment-actions .btn-link:hover {
	color: var(--primary) !important;
}

.select2-container--default .select2-selection--multiple {
	border: 1px solid #ced4da;
	border-radius: 6px;
	padding: 4px;
	min-height: 42px;
	font-size: 14px;
}

/* Selected tags */
.select2-container--default .select2-selection--multiple .select2-selection__choice
	{
	background-color: #007bff;
	border: none;
	border-radius: 4px;
	color: #fff;
	padding: 4px 8px;
	margin-top: 4px;
	margin-right: 4px;
	font-size: 13px;
}

/* X (remove button) inside tag */
.select2-container--default .select2-selection--multiple .select2-selection__choice__remove
	{
	color: #fff;
	margin-right: 6px;
	font-weight: bold;
	cursor: pointer;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover
	{
	color: #ffdddd;
}

/* Dropdown styling */
.select2-container--default .select2-results__option--highlighted {
	background-color: #007bff;
	color: #fff;
}

/* Custom styles for instance-based selection */
.selection-limit {
	font-size: 0.875rem;
	margin-top: 5px;
	color: #6c757d;
}

.selection-limit.error {
	color: #dc3545;
	font-weight: 500;
}

.instance-warning {
	display: none;
	color: #856404;
	background-color: #fff3cd;
	border: 1px solid #ffeeba;
	border-radius: 4px;
	padding: 10px;
	margin-top: 10px;
	font-size: 0.9rem;
}

.select2-container--disabled {
	background-color: #e9ecef;
	opacity: 0.8;
	cursor: not-allowed;
}

.select2-container--disabled .select2-selection {
	background-color: #e9ecef;
	cursor: not-allowed;
}
</style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
	<div class="wrapper">

		<div th:replace="fragments/header :: header"></div>

		<div th:replace="fragments/sidebar :: aside"></div>

		<div class="content-wrapper">

			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>[[${pageTitle}]]</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="#"><i
										class="fas fa-home"></i> Home</a></li>
								<li class="breadcrumb-item"><a href="#">Scenarios</a></li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<div class="d-flex justify-content-between align-items-center">
										<h3 class="card-title">
											<i class="fas fa-plus-circle mr-2"></i> Scenario Details
										</h3>
										<div class="card-tools">
											<button type="button" class="btn btn-tool"
												data-card-widget="collapse">
												<i class="fas fa-minus"></i>
											</button>
										</div>
									</div>
								</div>

								<form th:action="@{/guac/saveScenarioData}"
									th:object="${scenario}" method="post"
									enctype="multipart/form-data"
									onsubmit="return validateScenarioForm()">
									<input type="hidden" th:field="*{Id}" />
									<div class="card-body">
										<div class="form-section">
											<h5 class="form-section-title">
												<i class="fas fa-info-circle mr-2"></i>Basic Information
											</h5>
											<div class="row">
												<div class="col-md-6">
													<div class="form-group">
														<label for="title">Scenario Title <span
															class="text-danger">*</span></label> <input type="text" required
															id="ScenarioTitle" name="ScenarioTitle"
															th:field="*{ScenarioTitle}" class="form-control"
															placeholder="Enter scenario title">
													</div>
												</div>
												<div class="col-md-6">

													<div class="form-group">
														<label for="title">Scenario Name <span
															class="text-danger">*</span></label> <input type="text" required
															id="ScenarioName" name="ScenarioName"
															th:field="*{ScenarioName}" class="form-control"
															placeholder="Enter scenario Name">
													</div>
												</div>
											</div>

											<div class="row">
												<div class="col-md-12">
													<div class="form-group">
														<label for="description">Description</label>
														<textarea id="Description" name="Description"
															class="summernote form-control" rows="3"
															placeholder="Briefly describe the scenario objectives"></textarea>
													</div>
												</div>
											</div>
										</div>

										<div class="form-section">
											<h5 class="form-section-title">
												<i class="fas fa-cog mr-2"></i>Configuration
											</h5>
											<div class="row">
												<div class="col-md-4">
													<div class="form-group">
														<label for="Category">Category <span
															class="text-danger">*</span></label> <select required
															th:field="*{Category}" id="Category" name="Category"
															class="form-control">
															<option value="">-- Select Category --</option>
															<option value="Mobile Security">Mobile Security</option>
															<option value="Forensic">Forensic</option>
															<option value="Networking">Networking</option>
															<option value="Cloud Security">Cloud Security</option>
															<option value="Web Application">Web Application</option>
														</select>
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="type">Scenario Type <span
															class="text-danger">*</span></label> <select required
															id="ScenarioType" th:field="*{ScenarioType}"
															name="ScenarioType" class="form-control">
															<option value="">-- Select Type --</option>
															<option value="openrange">Open Range</option>
															<option value="guided">Guided</option>
															<option value="challenge">Challenge</option>
														</select>
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="mode">Play Mode <span
															class="text-danger">*</span></label> <select required id="Mode"
															th:field="*{Mode}" name="Mode" class="form-control">
															<option value="">-- Select Mode --</option>
															<option value="singleplayer">Single Player</option>
															<option value="multiplayer">Multi Player</option>
															<option value="both">Both</option>
														</select>
													</div>
												</div>
											</div>

											<div class="row">
												<div class="col-md-4">
													<div class="form-group">
														<label for="Difficulty">Difficulty Level <span
															class="text-danger">*</span></label> <select required
															th:field="*{DifficultyLevel}" id="DifficultyLevel"
															name="DifficultyLevel" class="form-control">
															<option value="">-- Select Difficulty --</option>
															<option value="Easy">Easy</option>
															<option value="Intermediate">Intermediate</option>
															<option value="Advanced">Advanced</option>
															<option value="Expert">Expert</option>
														</select>
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="Duration">Duration (minutes) <span
															class="text-danger">*</span></label> <input type="number" min="5"
															th:field="*{Duration}" max="240" required id="Duration"
															name="Duration" class="form-control" placeholder="30">
													</div>
												</div>
												<div class="col-md-4">
													<div class="form-group">
														<label for="max_players">Max Players (if
															multiplayer)</label> <input type="number" min="1" max="20"
															th:field="*{MaxPlayers}" id="MaxPlayers"
															name="MaxPlayers" class="form-control" placeholder="5">
													</div>
												</div>
											</div>
										</div>

										<div class="form-section">
											<h5 class="form-section-title">
												<i class="fas fa-image mr-2"></i>Media & Resources
											</h5>
											<div class="row">
												<div class="col-md-6">
													<div class="form-group">
														<label for="cover_image">Cover Image</label>
														<div class="custom-file">
															<input type="file" class="custom-file-input"
																id="cover_image" name="cover_image" accept="image/*">
															<label class="custom-file-label" for="cover_image">Choose
																file</label>
														</div>
														<small class="form-text text-muted">Recommended
															size: 1200x630 pixels</small>
													</div>
												</div>
												<div class="col-md-6">
													<div class="form-group">
														<label for="NoOfInstance">Number of Instance <span
															class="text-danger">*</span></label> <input type="number" min="1"
															max="2000" th:field="*{NumberofInstance}"
															id="NumberofInstance" name="NumberofInstance"
															class="form-control"
															placeholder="Enter number of instances..." required>
														<div class="instance-warning" id="instanceWarning">
															<i class="fas fa-exclamation-triangle mr-2"></i>Please
															set the number of instances before selecting lab
															templates.
														</div>
													</div>
												</div>
											</div>

											<div class="row mt-4">
												<div class="col-md-12">
													<div class="form-group">
														<label for="Labs" class="form-label fw-bold">Select
															Lab Template <span class="text-danger">*</span>
														</label> <select id="Labs" name="Labs" class="form-control"
															th:field="*{Labs}" multiple="multiple" disabled>
															<option th:each="scenario : ${instanceNameList}"
																th:value="${scenario.id + '~' + scenario.instance_name}"
																th:text="${scenario.instance_name}"></option>
														</select>
														<div class="selection-limit" id="selectionLimit">
															You can select up to <span id="maxSelections">0</span>
															lab templates
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>

									<div class="card-footer text-right">
										<button type="reset" class="btn btn-outline-secondary mr-2">
											<i class="fas fa-undo mr-1"></i> Reset
										</button>
										<button type="submit" id="saveScenarioBtn"
											class="btn btn-primary">
											<i class="fas fa-save mr-1"></i> Save Scenario <span
												id="scenarioSpinner"
												class="spinner-border spinner-border-sm ml-2 d-none"></span>
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<div th:replace="fragments/footer :: footer"></div>
	</div>

	<div th:replace="template :: jsscript"></div>

	<!-- jQuery (needed for Bootstrap and multiselect) -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- Bootstrap JS -->
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bs-custom-file-input/dist/bs-custom-file-input.min.js"></script>
	<!-- Summernote JS -->
	<script
		src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<script type="text/javascript">
		$(document).ready(function() {
			// Initialize custom file input
			bsCustomFileInput.init();

			// Initialize Summernote
			$('.summernote').summernote({
				height: 200,
				toolbar: [
					['style', ['style']],
					['font', ['bold', 'italic', 'underline', 'clear']],
					['fontname', ['fontname']],
					['color', ['color']],
					['para', ['ul', 'ol', 'paragraph']],
					['height', ['height']],
					['table', ['table']],
					['insert', ['link', 'picture', 'video']],
					['view', ['fullscreen', 'codeview', 'help']]
				],
				styleTags: ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
				fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Helvetica', 'Impact', 'Tahoma', 'Times New Roman', 'Verdana', 'Roboto'],
				fontNamesIgnoreCheck: ['Roboto']
			});

			// Initialize Select2 for multi-select
			$('#Labs').select2({
				placeholder: "Select lab templates (max: 0)",
				allowClear: true,
				width: '100%',
				closeOnSelect: false
			});

			// Handle instance number change
			$('#NumberofInstance').on('input', function() {
				const instanceCount = parseInt($(this).val()) || 0;
				
				if (instanceCount > 0) {
					$('#Labs').prop('disabled', false);
					$('#instanceWarning').hide();
					$('#maxSelections').text(instanceCount);
					$('#selectionLimit').removeClass('error');
					
					// Update placeholder text
					$('#Labs').data('select2').$container.find('.select2-selection__placeholder').text(`Select lab templates (max: ${instanceCount})`);
					
					// If current selections exceed the new limit, remove the extra ones
					const selectedOptions = $('#Labs').val() || [];
					if (selectedOptions.length > instanceCount) {
						// Remove excess selections
						$('#Labs').val(selectedOptions.slice(0, instanceCount)).trigger('change');
						$('#selectionLimit').addClass('error').html(`<i class="fas fa-exclamation-circle mr-1"></i>Selection limit exceeded! Only ${instanceCount} lab templates allowed.`);
					} else if (selectedOptions.length > 0) {
						$('#selectionLimit').html(`You have selected ${selectedOptions.length} of ${instanceCount} allowed lab templates`);
					} else {
						$('#selectionLimit').html(`You can select up to <span id="maxSelections">${instanceCount}</span> lab templates`);
					}
				} else {
					$('#Labs').prop('disabled', true);
					$('#Labs').val(null).trigger('change');
					$('#instanceWarning').show();
					$('#maxSelections').text('0');
					$('#selectionLimit').html(`You can select up to <span id="maxSelections">0</span> lab templates`);
				}
			});

			// Handle lab template selection with limit validation
			$('#Labs').on('select2:selecting', function(e) {
				const instanceCount = parseInt($('#NumberofInstance').val()) || 0;
				const currentSelections = $('#Labs').select2('data').length;
				
				if (instanceCount > 0 && currentSelections >= instanceCount) {
					e.preventDefault();
					$('#selectionLimit').addClass('error').html(`<i class="fas fa-exclamation-circle mr-1"></i>You can only select up to ${instanceCount} lab templates.`);
					
					// Show warning for 2 seconds
					setTimeout(function() {
						$('#selectionLimit').removeClass('error');
						$('#selectionLimit').html(`You have selected ${currentSelections} of ${instanceCount} allowed lab templates`);
					}, 2000);
				}
			});

			// Update selection count when changing labs
			$('#Labs').on('change', function() {
				const instanceCount = parseInt($('#NumberofInstance').val()) || 0;
				const currentSelections = $('#Labs').select2('data').length;
				
				if (instanceCount > 0) {
					if (currentSelections > instanceCount) {
						// This shouldn't happen with the prevention above, but just in case
						const selectedOptions = $('#Labs').val() || [];
						$('#Labs').val(selectedOptions.slice(0, instanceCount)).trigger('change');
					} else if (currentSelections > 0) {
						$('#selectionLimit').html(`You have selected ${currentSelections} of ${instanceCount} allowed lab templates`);
					} else {
						$('#selectionLimit').html(`You can select up to <span id="maxSelections">${instanceCount}</span> lab templates`);
					}
				}
			});

			// Inline validation on input change
			const requiredFields = [
				'ScenarioTitle', 'ScenarioName', 'Category', 'ScenarioType', 
				'Mode', 'DifficultyLevel', 'Duration', 'NumberofInstance'
			];

			requiredFields.forEach(fieldId => {
				$('#' + fieldId).on('input change', function() {
					if ($(this).val().trim()) {
						$(this).removeClass('is-invalid');
					} else {
						$(this).addClass('is-invalid');
					}
				});
			});

			// Summernote inline validation
			$('#Description').on('summernote.change', function() {
				const content = $(this).summernote('code').replace(/<[^>]*>/g, '').trim();
				if (content) {
					$(this).closest('.form-group').find('.note-editor').removeClass('is-invalid');
				} else {
					$(this).closest('.form-group').find('.note-editor').addClass('is-invalid');
				}
			});
		});

		function validateScenarioForm() {
			let isValid = true;

			// Validate required fields
			const requiredFields = [
				'ScenarioTitle', 'ScenarioName', 'Category', 'ScenarioType', 
				'Mode', 'DifficultyLevel', 'Duration', 'NumberofInstance'
			];

			requiredFields.forEach(fieldId => {
				const field = $('#' + fieldId);
				if (!field.val().trim()) {
					field.addClass('is-invalid');
					isValid = false;
				} else {
					field.removeClass('is-invalid');
				}
			});

			// Validate Labs selection
			const instanceCount = parseInt($('#NumberofInstance').val()) || 0;
			const selectedLabs = $('#Labs').val();
			
			if (!selectedLabs || selectedLabs.length === 0) {
				$('#Labs').closest('.form-group').find('.select2-selection').addClass('is-invalid');
				isValid = false;
			} else if (selectedLabs.length > instanceCount) {
				$('#selectionLimit').addClass('error').html(`<i class="fas fa-exclamation-circle mr-1"></i>You can only select up to ${instanceCount} lab templates.`);
				isValid = false;
			} else {
				$('#Labs').closest('.form-group').find('.select2-selection').removeClass('is-invalid');
			}

			// Validate Summernote
			const summernoteContent = $('#Description').summernote('code').replace(/<[^>]*>/g, '').trim();
			if (!summernoteContent) {
				$('#Description').closest('.form-group').find('.note-editor').addClass('is-invalid');
				isValid = false;
			} else {
				$('#Description').closest('.form-group').find('.note-editor').removeClass('is-invalid');
			}

			if (!isValid) {
				// Scroll to first invalid field
				$('html, body').animate({
					scrollTop: $('.is-invalid:first').offset().top - 100
				}, 500);
				return false;
			}

			// Show loading spinner
			$('#scenarioSpinner').removeClass('d-none');
			$('#saveScenarioBtn').prop('disabled', true);

			return true;
		}
		
		
		
	</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var result = [[${result}]];

    if (result === 'success') {
        Swal.fire({
            title: 'Scenario Saved!',
            text: 'The scenario has been saved successfully.',
            icon: 'success',
            confirmButtonText: 'OK',
            confirmButtonColor: '#3498db'
        });
    } else if (result && result !== '') {
        Swal.fire({
            title: 'Error',
            text: result,
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#e74c3c'
        });
    }
    /*]]>*/
</script>





</body>
</html>